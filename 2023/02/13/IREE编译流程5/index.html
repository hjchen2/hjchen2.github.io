<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>IREE编译流程解析(五) › Don&#39;t Respond</title>
  <meta name="author" content="Dou Jiang">
  
  <meta name="description" content="IREE::Stream::StreamTransformPassPipeline
的主要作用是将program转换到stream
dialect，优化变量编码方式，划分调度子图，生成异步调度策略，并实现内存规划策略。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="IREE编译流程解析(五)"/>
  <meta property="og:site_name" content="Don&#39;t Respond"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Don&#39;t Respond" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">Don&#39;t Respond</a></h1>
  <h2><a href="/"></a></h2>
  <nav id="main-nav">
    <ul>
      
      <li><a href="/about">About</a></li>
      
      <li><a href="/archives">Archives</a></li>
      
      <li><a href="/atom.xml">RSS</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title">IREE编译流程解析(五)</h1>
  

      
        <time datetime="2023-02-13T13:57:20.000Z">2023-02-13</time>
      
    </header>
    <div class="entry">
      
        <p>IREE::Stream::StreamTransformPassPipeline
的主要作用是将program转换到stream
dialect，优化变量编码方式，划分调度子图，生成异步调度策略，并实现内存规划策略。</p>
<span id="more"></span>
<ul>
<li><p>buildStreamTensorPassPipeline</p>
<ul>
<li><p>IREE::Stream::createVerifyInputPass</p>
<p>检查program的合法性。</p></li>
<li><p>IREE::Stream::createOutlineConstantsPass</p>
<p>将module内部的dense constant转换成global dense constant。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">  %cst = arith.constant dense&lt;[<span class="number">0.000000e+00</span>, <span class="number">0.00999999977</span>, <span class="number">2.000000e-02</span>, <span class="number">3.000000e-02</span>, <span class="number">4.000000e-02</span>, <span class="number">5.000000e-02</span>, <span class="number">6.000000e-02</span>, <span class="number">7.000000e-02</span>, <span class="number">8.000000e-02</span>, <span class="number">9.000000e-02</span>]&gt; : tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">  %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">  %<span class="number">0</span> = hal.tensor.<span class="keyword">import</span> %arg0 : !hal.buffer_view -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt;</span><br><span class="line">  %<span class="number">1</span> = flow.tensor.reshape %<span class="number">0</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; -&gt; tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">  %<span class="number">2</span> = flow.tensor.empty : tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">  %<span class="number">3</span> = flow.dispatch @test_dispatch_0::@test_dispatch_0_generic_10[%c10](%<span class="number">1</span>, %cst, %<span class="number">2</span>) : (tensor&lt;<span class="number">10</span>xf32&gt;, tensor&lt;<span class="number">10</span>xf32&gt;, tensor&lt;<span class="number">10</span>xf32&gt;) -&gt; %<span class="number">2</span></span><br><span class="line">  %<span class="number">4</span> = flow.tensor.reshape %<span class="number">3</span> : tensor&lt;<span class="number">10</span>xf32&gt; -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt;</span><br><span class="line">  %<span class="number">5</span> = hal.tensor.<span class="keyword">export</span> %<span class="number">4</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; -&gt; !hal.buffer_view</span><br><span class="line">  <span class="keyword">return</span> %<span class="number">5</span> : !hal.buffer_view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">util.global <span class="keyword">private</span> @_constant &#123;noinline&#125; = dense&lt;[<span class="number">0.000000e+00</span>, <span class="number">0.00999999977</span>, <span class="number">2.000000e-02</span>, <span class="number">3.000000e-02</span>, <span class="number">4.000000e-02</span>, <span class="number">5.000000e-02</span>, <span class="number">6.000000e-02</span>, <span class="number">7.000000e-02</span>, <span class="number">8.000000e-02</span>, <span class="number">9.000000e-02</span>]&gt; : tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">func.func @<span class="built_in">test</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">  %_constant = util.global.load @_constant : tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">  %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">  %<span class="number">0</span> = hal.tensor.<span class="keyword">import</span> %arg0 : !hal.buffer_view -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt;</span><br><span class="line">  %<span class="number">1</span> = flow.tensor.reshape %<span class="number">0</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; -&gt; tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">  %<span class="number">2</span> = flow.tensor.empty : tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">  %<span class="number">3</span> = flow.dispatch @test_dispatch_0::@test_dispatch_0_generic_10[%c10](%<span class="number">1</span>, %_constant, %<span class="number">2</span>) : (tensor&lt;<span class="number">10</span>xf32&gt;, tensor&lt;<span class="number">10</span>xf32&gt;, tensor&lt;<span class="number">10</span>xf32&gt;) -&gt; %<span class="number">2</span></span><br><span class="line">  %<span class="number">4</span> = flow.tensor.reshape %<span class="number">3</span> : tensor&lt;<span class="number">10</span>xf32&gt; -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt;</span><br><span class="line">  %<span class="number">5</span> = hal.tensor.<span class="keyword">export</span> %<span class="number">4</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; -&gt; !hal.buffer_view</span><br><span class="line">  <span class="keyword">return</span> %<span class="number">5</span> : !hal.buffer_view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>addCleanupPatterns</p></li>
<li><p>IREE::Stream::createConvertToStreamPass</p>
<p>将<code>IREE::Util</code>、<code>IREE::Flow</code>、<code>IREE::HAL</code>以及<code>std</code>
dialect转换到<code>IREE::Stream</code> dialect。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> &#123;</span><br><span class="line">  util.global <span class="keyword">private</span> @_constant &#123;noinline&#125; = dense&lt;[<span class="number">0.000000e+00</span>, <span class="number">0.00999999977</span>, <span class="number">2.000000e-02</span>, <span class="number">3.000000e-02</span>, <span class="number">4.000000e-02</span>, <span class="number">5.000000e-02</span>, <span class="number">6.000000e-02</span>, <span class="number">7.000000e-02</span>, <span class="number">8.000000e-02</span>, <span class="number">9.000000e-02</span>]&gt; : tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">  flow.executable <span class="keyword">private</span> @test_dispatch_0 &#123;</span><br><span class="line">    flow.executable.<span class="keyword">export</span> <span class="keyword">public</span> @test_dispatch_0_generic_10 <span class="built_in">workgroups</span>(%arg0: index) -&gt; (index, index, index) &#123;</span><br><span class="line">      %x, %y, %z = flow.dispatch.workgroup_count_from_dag_root %arg0</span><br><span class="line">      flow.<span class="keyword">return</span> %x, %y, %z : index, index, index</span><br><span class="line">    &#125;</span><br><span class="line">    builtin.<span class="keyword">module</span> &#123;</span><br><span class="line">      func.func @<span class="built_in">test_dispatch_0_generic_10</span>(%arg0: !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xf32&gt;&gt;, %arg1: !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xf32&gt;&gt;, %arg2: !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">10</span>xf32&gt;&gt;) &#123;</span><br><span class="line">        %<span class="number">0</span> = flow.dispatch.tensor.load %arg0, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xf32&gt;&gt; -&gt; tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">        %<span class="number">1</span> = flow.dispatch.tensor.load %arg1, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xf32&gt;&gt; -&gt; tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">        %<span class="number">2</span> = flow.dispatch.tensor.load %arg2, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">10</span>xf32&gt;&gt; -&gt; tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">        %<span class="number">3</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;, <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;, <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">0</span>, %<span class="number">1</span> : tensor&lt;<span class="number">10</span>xf32&gt;, tensor&lt;<span class="number">10</span>xf32&gt;) <span class="built_in">outs</span>(%<span class="number">2</span> : tensor&lt;<span class="number">10</span>xf32&gt;) &#123;</span><br><span class="line">        ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">          %<span class="number">4</span> = arith.addf %in, %in_0 : f32</span><br><span class="line">          linalg.yield %<span class="number">4</span> : f32</span><br><span class="line">        &#125; -&gt; tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">        flow.dispatch.tensor.store %<span class="number">3</span>, %arg2, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : tensor&lt;<span class="number">10</span>xf32&gt; -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">10</span>xf32&gt;&gt;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  func.func @<span class="built_in">test</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">    %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">    %_constant = util.global.load @_constant : tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">    %<span class="number">0</span> = hal.tensor.<span class="keyword">import</span> %arg0 : !hal.buffer_view -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt;</span><br><span class="line">    %<span class="number">1</span> = flow.tensor.reshape %<span class="number">0</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; -&gt; tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">    %<span class="number">2</span> = flow.tensor.empty : tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">    %<span class="number">3</span> = flow.dispatch @test_dispatch_0::@test_dispatch_0_generic_10[%c10](%<span class="number">1</span>, %_constant, %<span class="number">2</span>) : (tensor&lt;<span class="number">10</span>xf32&gt;, tensor&lt;<span class="number">10</span>xf32&gt;, tensor&lt;<span class="number">10</span>xf32&gt;) -&gt; %<span class="number">2</span></span><br><span class="line">    %<span class="number">4</span> = flow.tensor.reshape %<span class="number">3</span> : tensor&lt;<span class="number">10</span>xf32&gt; -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt;</span><br><span class="line">    %<span class="number">5</span> = hal.tensor.<span class="keyword">export</span> %<span class="number">4</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; -&gt; !hal.buffer_view</span><br><span class="line">    <span class="keyword">return</span> %<span class="number">5</span> : !hal.buffer_view</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换为</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> &#123;</span><br><span class="line">  util.global <span class="keyword">private</span> @_constant : !stream.resource&lt;constant&gt;</span><br><span class="line">  util.global <span class="keyword">private</span> @_constant__size : index</span><br><span class="line">  util.initializer &#123;</span><br><span class="line">    %cst = stream.tensor.constant : tensor&lt;<span class="number">10</span>xf32&gt; in !stream.resource&lt;constant&gt; = dense&lt;[<span class="number">0.000000e+00</span>, <span class="number">0.00999999977</span>, <span class="number">2.000000e-02</span>, <span class="number">3.000000e-02</span>, <span class="number">4.000000e-02</span>, <span class="number">5.000000e-02</span>, <span class="number">6.000000e-02</span>, <span class="number">7.000000e-02</span>, <span class="number">8.000000e-02</span>, <span class="number">9.000000e-02</span>]&gt; : tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">    %<span class="number">0</span> = stream.resource.size %cst : !stream.resource&lt;constant&gt;</span><br><span class="line">    util.global.store %cst, @_constant : !stream.resource&lt;constant&gt;</span><br><span class="line">    util.global.store %<span class="number">0</span>, @_constant__size : index</span><br><span class="line">    util.initializer.<span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  stream.executable <span class="keyword">private</span> @test_dispatch_0 &#123;</span><br><span class="line">    stream.executable.<span class="keyword">export</span> <span class="keyword">public</span> @test_dispatch_0_generic_10 <span class="built_in">workgroups</span>(%arg0: index) -&gt; (index, index, index) &#123;</span><br><span class="line">      %x, %y, %z = flow.dispatch.workgroup_count_from_dag_root %arg0</span><br><span class="line">      stream.<span class="keyword">return</span> %x, %y, %z : index, index, index</span><br><span class="line">    &#125;</span><br><span class="line">    builtin.<span class="keyword">module</span> &#123;</span><br><span class="line">      func.func @<span class="built_in">test_dispatch_0_generic_10</span>(%arg0: !stream.binding, %arg1: !stream.binding, %arg2: !stream.binding) &#123;</span><br><span class="line">        %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">        %<span class="number">0</span> = stream.binding.subspan %arg0[%c0] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xf32&gt;&gt;</span><br><span class="line">        %<span class="number">1</span> = stream.binding.subspan %arg1[%c0] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xf32&gt;&gt;</span><br><span class="line">        %<span class="number">2</span> = stream.binding.subspan %arg2[%c0] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">10</span>xf32&gt;&gt;</span><br><span class="line">        %<span class="number">3</span> = flow.dispatch.tensor.load %<span class="number">0</span>, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xf32&gt;&gt; -&gt; tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">        %<span class="number">4</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xf32&gt;&gt; -&gt; tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">        %<span class="number">5</span> = flow.dispatch.tensor.load %<span class="number">2</span>, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">10</span>xf32&gt;&gt; -&gt; tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">        %<span class="number">6</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;, <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;, <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">3</span>, %<span class="number">4</span> : tensor&lt;<span class="number">10</span>xf32&gt;, tensor&lt;<span class="number">10</span>xf32&gt;) <span class="built_in">outs</span>(%<span class="number">5</span> : tensor&lt;<span class="number">10</span>xf32&gt;) &#123;</span><br><span class="line">        ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">          %<span class="number">7</span> = arith.addf %in, %in_0 : f32</span><br><span class="line">          linalg.yield %<span class="number">7</span> : f32</span><br><span class="line">        &#125; -&gt; tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">        flow.dispatch.tensor.store %<span class="number">6</span>, %<span class="number">2</span>, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : tensor&lt;<span class="number">10</span>xf32&gt; -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">10</span>xf32&gt;&gt;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  func.func @<span class="built_in">test</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">    %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">    %_constant = util.global.load @_constant : !stream.resource&lt;constant&gt;</span><br><span class="line">    %_constant__size = util.global.load @_constant__size : index</span><br><span class="line">    %<span class="number">0</span> = stream.async.transfer %_constant : !stream.resource&lt;constant&gt;&#123;%_constant__size&#125; -&gt; !stream.resource&lt;*&gt;&#123;%_constant__size&#125;</span><br><span class="line">    %c553648160_i32 = arith.constant <span class="number">553648160</span> : i32</span><br><span class="line">    %c1_i32 = arith.constant <span class="number">1</span> : i32</span><br><span class="line">    %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">    %c10_0 = arith.constant <span class="number">10</span> : index</span><br><span class="line">    hal.buffer_view.assert&lt;%arg0 : !hal.buffer_view&gt; <span class="built_in">message</span>(<span class="string">&quot;tensor&quot;</span>) <span class="built_in">shape</span>([%c1, %c10_0]) <span class="built_in">type</span>(%c553648160_i32) <span class="built_in">encoding</span>(%c1_i32)</span><br><span class="line">    %<span class="number">1</span> = stream.tensor.<span class="keyword">sizeof</span> tensor&lt;<span class="number">1</span>x10xf32&gt; : index</span><br><span class="line">    %<span class="number">2</span> = stream.tensor.<span class="keyword">import</span> %arg0 : !hal.buffer_view -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt; in !stream.resource&lt;external&gt;&#123;%<span class="number">1</span>&#125;</span><br><span class="line">    %<span class="number">3</span> = stream.async.transfer %<span class="number">2</span> : !stream.resource&lt;external&gt;&#123;%<span class="number">1</span>&#125; -&gt; !stream.resource&lt;*&gt;&#123;%<span class="number">1</span>&#125;</span><br><span class="line">    %<span class="number">4</span> = stream.tensor.<span class="keyword">sizeof</span> tensor&lt;<span class="number">10</span>xf32&gt; : index</span><br><span class="line">    %<span class="number">5</span> = stream.tensor.clone %<span class="number">3</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; in !stream.resource&lt;*&gt;&#123;%<span class="number">1</span>&#125; -&gt; tensor&lt;<span class="number">10</span>xf32&gt; in !stream.resource&lt;*&gt;&#123;%<span class="number">4</span>&#125;</span><br><span class="line">    %<span class="number">6</span> = stream.tensor.<span class="keyword">sizeof</span> tensor&lt;<span class="number">10</span>xf32&gt; : index</span><br><span class="line">    %empty = stream.tensor.empty : tensor&lt;<span class="number">10</span>xf32&gt; in !stream.resource&lt;*&gt;&#123;%<span class="number">6</span>&#125;</span><br><span class="line">    %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">    %<span class="number">7</span> = stream.async.dispatch @test_dispatch_0::@test_dispatch_0_generic_10[%c10](%<span class="number">5</span>[%c0 to %<span class="number">4</span> <span class="keyword">for</span> %<span class="number">4</span>], %<span class="number">0</span>[%c0 to %_constant__size <span class="keyword">for</span> %_constant__size], %empty[%c0 to %<span class="number">6</span> <span class="keyword">for</span> %<span class="number">6</span>]) : (!stream.resource&lt;*&gt;&#123;%<span class="number">4</span>&#125;, !stream.resource&lt;*&gt;&#123;%_constant__size&#125;, !stream.resource&lt;*&gt;&#123;%<span class="number">6</span>&#125;) -&gt; %empty&#123;%<span class="number">6</span>&#125;</span><br><span class="line">    %<span class="number">8</span> = stream.tensor.<span class="keyword">sizeof</span> tensor&lt;<span class="number">1</span>x10xf32&gt; : index</span><br><span class="line">    %<span class="number">9</span> = stream.tensor.clone %<span class="number">7</span> : tensor&lt;<span class="number">10</span>xf32&gt; in !stream.resource&lt;*&gt;&#123;%<span class="number">6</span>&#125; -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt; in !stream.resource&lt;*&gt;&#123;%<span class="number">8</span>&#125;</span><br><span class="line">    %<span class="number">10</span> = stream.async.transfer %<span class="number">9</span> : !stream.resource&lt;*&gt;&#123;%<span class="number">8</span>&#125; -&gt; !stream.resource&lt;external&gt;&#123;%<span class="number">8</span>&#125;</span><br><span class="line">    %<span class="number">11</span> = stream.tensor.<span class="keyword">export</span> %<span class="number">10</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; in !stream.resource&lt;external&gt;&#123;%<span class="number">8</span>&#125; -&gt; !hal.buffer_view</span><br><span class="line">    <span class="keyword">return</span> %<span class="number">11</span> : !hal.buffer_view</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到除了<code>flow.executable</code>，module中<code>tensor</code>
type都被转换成<code>stream.resource</code>和<code>index</code>，但<code>hal.buffer_view</code>
type仍然被保留。初始值为tensor的<code>util.global</code>
constant被转换为不带初始值的
<code>stream.resource</code>和<code>index</code>，同时生成了一个<code>util.initializer</code>对
<code>stream.resource</code>和<code>index</code>进行初始化。
<code>util.global.load</code>被转换成<code>util.global.load</code> +
<code>stream.async.transfer</code>，<code>hal.tensor.import</code>被转换成<code>stream.tensor.import</code>
+
<code>stream.async.transfer</code>，<code>hal.tensor.export</code>被转换为<code>stream.async.transfer</code>
+
<code>stream.tensor.export</code>，<code>flow.tensor.reshape</code>被转换成<code>stream.tensor.clone</code>，<code>flow.executable</code>转换为<code>stream.executable</code>，内部的<code>flow.executable.export</code>转换为<code>stream.executable.export</code>
，内部的func
op的argument由<code>flow.dispatch.tensor</code>转换为<code>stream.binding</code>。</p></li>
<li><p>IREE::Stream::createVerifyLoweringToTensorsPass</p>
<p>检查program的合法性。</p></li>
<li><p>addCleanupPatterns</p></li>
<li><p>IREE::Util::createCombineInitializersPass</p>
<p>合并所有的<code>util.initializer</code> ops。</p></li>
</ul></li>
<li><p>buildStreamAsyncPassPipeline</p>
<ul>
<li><p>IREE::Stream::createEncodeHostTensorsPass</p>
<p>主要作用是将tensor的元素位宽（bit）扩充为2的幂大小，并按字节对齐。其中i1~i7转换为i8（1
byte），i9~i15转换为i16 (2 bytes)，i17~i31转换为i32 (4
bytes)，i33~i63转换为i64（8 bytes）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">util.initializer &#123;</span><br><span class="line">  %cst = stream.tensor.constant : tensor&lt;<span class="number">10</span>xi4&gt; in !stream.resource&lt;constant&gt; = dense&lt;[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">-8</span>, <span class="number">-7</span>]&gt; : tensor&lt;<span class="number">10</span>xi4&gt;</span><br><span class="line">  %<span class="number">0</span> = stream.resource.size %cst : !stream.resource&lt;constant&gt;</span><br><span class="line">  util.global.store %cst, @_constant : !stream.resource&lt;constant&gt;</span><br><span class="line">  util.global.store %<span class="number">0</span>, @_constant__size : index</span><br><span class="line">  util.initializer.<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换为</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">util.initializer &#123;</span><br><span class="line">  %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">  %cst = stream.async.constant : !stream.resource&lt;constant&gt;&#123;%c10&#125; = dense&lt;[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]&gt; : tensor&lt;<span class="number">10</span>xi8&gt;</span><br><span class="line">  util.global.store %cst, @_constant : !stream.resource&lt;constant&gt;</span><br><span class="line">  util.global.store %c10, @_constant__size : index</span><br><span class="line">  util.initializer.<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>%cst</code>的类型从i4转成了i8，此外<code>stream.tensor.constant</code>转换成了<code>stream.async.constant</code>，<code>%0 = stream.resource.size %cst : !stream.resource&lt;constant&gt;</code>直接被替换成了常量<code>%c10</code>。</p></li>
<li><p>IREE::Stream::createEncodeDeviceTensorsPass</p>
<p>和createEncodeHostTensorsPass作用一样，区别是createEncodeDeviceTensorsPass作用的是<code>stream.executable</code>中的op。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">builtin.<span class="keyword">module</span> &#123;</span><br><span class="line">    func.func @<span class="built_in">test_dispatch_0_generic_10</span>(%arg0: !stream.binding, %arg1: !stream.binding, %arg2: !stream.binding) &#123;</span><br><span class="line">      %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">      %<span class="number">0</span> = stream.binding.subspan %arg0[%c0] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xi4&gt;&gt;</span><br><span class="line">      %<span class="number">1</span> = stream.binding.subspan %arg1[%c0] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xi4&gt;&gt;</span><br><span class="line">      %<span class="number">2</span> = stream.binding.subspan %arg2[%c0] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">10</span>xi4&gt;&gt;</span><br><span class="line">      %<span class="number">3</span> = flow.dispatch.tensor.load %<span class="number">0</span>, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xi4&gt;&gt; -&gt; tensor&lt;<span class="number">10</span>xi4&gt;</span><br><span class="line">      %<span class="number">4</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xi4&gt;&gt; -&gt; tensor&lt;<span class="number">10</span>xi4&gt;</span><br><span class="line">      %<span class="number">5</span> = flow.dispatch.tensor.load %<span class="number">2</span>, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">10</span>xi4&gt;&gt; -&gt; tensor&lt;<span class="number">10</span>xi4&gt;</span><br><span class="line">      %<span class="number">6</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;, <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;, <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">3</span>, %<span class="number">4</span> : tensor&lt;<span class="number">10</span>xi4&gt;, tensor&lt;<span class="number">10</span>xi4&gt;) <span class="built_in">outs</span>(%<span class="number">5</span> : tensor&lt;<span class="number">10</span>xi4&gt;) &#123;</span><br><span class="line">      ^<span class="built_in">bb0</span>(%in: i4, %in_0: i4, %out: i4):</span><br><span class="line">        %<span class="number">7</span> = arith.addi %in, %in_0 : i4</span><br><span class="line">        linalg.yield %<span class="number">7</span> : i4</span><br><span class="line">      &#125; -&gt; tensor&lt;<span class="number">10</span>xi4&gt;</span><br><span class="line">      flow.dispatch.tensor.store %<span class="number">6</span>, %<span class="number">2</span>, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : tensor&lt;<span class="number">10</span>xi4&gt; -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">10</span>xi4&gt;&gt;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换为，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">builtin.<span class="keyword">module</span> &#123;</span><br><span class="line">    func.func @<span class="built_in">test_dispatch_0_generic_10</span>(%arg0: !stream.binding, %arg1: !stream.binding, %arg2: !stream.binding) &#123;</span><br><span class="line">      %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">      %<span class="number">0</span> = stream.binding.subspan %arg0[%c0] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xi8&gt;&gt;</span><br><span class="line">      %<span class="number">1</span> = stream.binding.subspan %arg1[%c0] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xi8&gt;&gt;</span><br><span class="line">      %<span class="number">2</span> = stream.binding.subspan %arg2[%c0] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">10</span>xi8&gt;&gt;</span><br><span class="line">      %<span class="number">3</span> = flow.dispatch.tensor.load %<span class="number">0</span>, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xi8&gt;&gt; -&gt; tensor&lt;<span class="number">10</span>xi8&gt;</span><br><span class="line">      %<span class="number">4</span> = arith.trunci %<span class="number">3</span> : tensor&lt;<span class="number">10</span>xi8&gt; to tensor&lt;<span class="number">10</span>xi4&gt;</span><br><span class="line">      %<span class="number">5</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">10</span>xi8&gt;&gt; -&gt; tensor&lt;<span class="number">10</span>xi8&gt;</span><br><span class="line">      %<span class="number">6</span> = arith.trunci %<span class="number">5</span> : tensor&lt;<span class="number">10</span>xi8&gt; to tensor&lt;<span class="number">10</span>xi4&gt;</span><br><span class="line">      %<span class="number">7</span> = flow.dispatch.tensor.load %<span class="number">2</span>, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">10</span>xi8&gt;&gt; -&gt; tensor&lt;<span class="number">10</span>xi8&gt;</span><br><span class="line">      %<span class="number">8</span> = arith.trunci %<span class="number">7</span> : tensor&lt;<span class="number">10</span>xi8&gt; to tensor&lt;<span class="number">10</span>xi4&gt;</span><br><span class="line">      %<span class="number">9</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;, <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;, <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">4</span>, %<span class="number">6</span> : tensor&lt;<span class="number">10</span>xi4&gt;, tensor&lt;<span class="number">10</span>xi4&gt;) <span class="built_in">outs</span>(%<span class="number">8</span> : tensor&lt;<span class="number">10</span>xi4&gt;) &#123;</span><br><span class="line">      ^<span class="built_in">bb0</span>(%in: i4, %in_0: i4, %out: i4):</span><br><span class="line">        %<span class="number">11</span> = arith.addi %in, %in_0 : i4</span><br><span class="line">        linalg.yield %<span class="number">11</span> : i4</span><br><span class="line">      &#125; -&gt; tensor&lt;<span class="number">10</span>xi4&gt;</span><br><span class="line">      %<span class="number">10</span> = arith.extui %<span class="number">9</span> : tensor&lt;<span class="number">10</span>xi4&gt; to tensor&lt;<span class="number">10</span>xi8&gt;</span><br><span class="line">      flow.dispatch.tensor.store %<span class="number">10</span>, %<span class="number">2</span>, offsets = [<span class="number">0</span>], sizes = [<span class="number">10</span>], strides = [<span class="number">1</span>] : tensor&lt;<span class="number">10</span>xi8&gt; -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">10</span>xi8&gt;&gt;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>stream.binding.subspan</code>的result
type从i4转换成了i8，并且在<code>flow.dispatch.tensor.load</code>之后插入了一个<code>arith.trunci</code>，将i8截断为i4，进而参与<code>linalg.generic</code>中的计算。</p></li>
<li><p>IREE::Stream::createMaterializeBuiltinsPass</p></li>
<li><p>addCleanupPatterns</p></li>
<li><p>IREE::Stream::createMaterializeCopyOnWritePass</p>
<p>写入时插入一次拷贝，以更有效地支持inplace更新，并且确保正确的执行语义。</p></li>
<li><p>IREE::Stream::createElideAsyncCopiesPass</p>
<p>消除MaterializeCopyOnWritePass中插入的不必要的拷贝。</p></li>
<li><p>mlir::createCanonicalizerPass</p></li>
<li><p>IREE::Stream::createEmplaceAllocationsPass</p>
<p>尝试消除<code>stream.async.dispatch</code>后的<code>stream.async.update</code>
op。当<code>stream.async.dispatch</code>的结果没有绑定一个value时，就可以把<code>stream.async.update</code>的target绑定到<code>stream.async.dispatch</code>的结果，使得<code>stream.async.dispatch</code>直接把计算结果更新到target。</p></li>
<li><p>IREE::Stream::createRefineUsagePass</p>
<p>确定每个<code>stream.resource</code>的生命期，推导<code>stream.resource</code>的类型。<code>stream.resource</code>类型包括：</p>
<ul>
<li>Unknown: <code>stream.resource&lt;*&gt;</code></li>
<li>External：<code>stream.resource&lt;external&gt;</code>
由外部程序管理的内存</li>
<li>Staging：<code>stream.resource&lt;staging&gt;</code>
用于上传/下载的暂存缓冲区</li>
<li>Transient：<code>stream.resource&lt;transient&gt;</code>
跨stream的一段临时值</li>
<li>Variable：<code>stream.resource&lt;variable&gt;</code>
跨stream的一段持续值</li>
<li>Constant：<code>stream.resource&lt;constant&gt;</code>
整个程序中持续存在的立即值（常量）。</li>
</ul>
<p>除此之外还消除了冗余的<code>stream.async.transfer</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">    %c40 = arith.constant <span class="number">40</span> : index</span><br><span class="line">    %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">    %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">    %c553648160_i32 = arith.constant <span class="number">553648160</span> : i32</span><br><span class="line">    %c1_i32 = arith.constant <span class="number">1</span> : i32</span><br><span class="line">    hal.buffer_view.assert&lt;%arg0 : !hal.buffer_view&gt; <span class="built_in">message</span>(<span class="string">&quot;tensor&quot;</span>) <span class="built_in">shape</span>([%c10]) <span class="built_in">type</span>(%c553648160_i32) <span class="built_in">encoding</span>(%c1_i32)</span><br><span class="line">    %<span class="number">0</span> = stream.tensor.<span class="keyword">import</span> %arg0 : !hal.buffer_view -&gt; tensor&lt;<span class="number">10</span>xf32&gt; in !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">    %<span class="number">1</span> = stream.async.transfer %<span class="number">0</span> : !stream.resource&lt;external&gt;&#123;%c40&#125; -&gt; !stream.resource&lt;*&gt;&#123;%c40&#125;</span><br><span class="line">    %<span class="number">2</span> = stream.async.dispatch @test_dispatch_0::@test_dispatch_0_generic_10[%c10](%<span class="number">1</span>[%c0 to %c40 <span class="keyword">for</span> %c40]) : (!stream.resource&lt;*&gt;&#123;%c40&#125;) -&gt; !stream.resource&lt;*&gt;&#123;%c40&#125;</span><br><span class="line">    %<span class="number">3</span> = stream.async.transfer %<span class="number">2</span> : !stream.resource&lt;*&gt;&#123;%c40&#125; -&gt; !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">    %<span class="number">4</span> = stream.tensor.<span class="keyword">export</span> %<span class="number">3</span> : tensor&lt;<span class="number">10</span>xf32&gt; in !stream.resource&lt;external&gt;&#123;%c40&#125; -&gt; !hal.buffer_view</span><br><span class="line">    <span class="keyword">return</span> %<span class="number">4</span> : !hal.buffer_view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换为</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">    %c40 = arith.constant <span class="number">40</span> : index</span><br><span class="line">    %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">    %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">    %c553648160_i32 = arith.constant <span class="number">553648160</span> : i32</span><br><span class="line">    %c1_i32 = arith.constant <span class="number">1</span> : i32</span><br><span class="line">    hal.buffer_view.assert&lt;%arg0 : !hal.buffer_view&gt; <span class="built_in">message</span>(<span class="string">&quot;tensor&quot;</span>) <span class="built_in">shape</span>([%c10]) <span class="built_in">type</span>(%c553648160_i32) <span class="built_in">encoding</span>(%c1_i32)</span><br><span class="line">    %<span class="number">0</span> = stream.tensor.<span class="keyword">import</span> %arg0 : !hal.buffer_view -&gt; tensor&lt;<span class="number">10</span>xf32&gt; in !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">    %<span class="number">1</span> = stream.async.dispatch @test_dispatch_0::@test_dispatch_0_generic_10[%c10](%<span class="number">0</span>[%c0 to %c40 <span class="keyword">for</span> %c40]) : (!stream.resource&lt;external&gt;&#123;%c40&#125;) -&gt; !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">    %<span class="number">2</span> = stream.tensor.<span class="keyword">export</span> %<span class="number">1</span> : tensor&lt;<span class="number">10</span>xf32&gt; in !stream.resource&lt;external&gt;&#123;%c40&#125; -&gt; !hal.buffer_view</span><br><span class="line">    <span class="keyword">return</span> %<span class="number">2</span> : !hal.buffer_view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>!stream.resource&lt;*&gt;&#123; %c40&#125;</code>被推导为<code>!stream.resource&lt;external&gt;&#123; %c40&#125;</code>，并且有两处<code>stream.async.transfer</code>被删除了。</p></li>
<li><p>addCleanupPatterns</p></li>
<li><p>IREE::Stream::createScheduleExecutionPass</p>
<p>根据启发式算法将每个callable（包括<code>util.initializer</code>）划分成多个part进行调度，每个part独立构成一个<code>stream.async.execute</code>，并且每个<code>stream.async.execute</code>后面都跟了一个<code>stream.timepoint.await</code>操作用于同步执行结果。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">  %c40 = arith.constant <span class="number">40</span> : index</span><br><span class="line">  %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">  %c553648160_i32 = arith.constant <span class="number">553648160</span> : i32</span><br><span class="line">  %c1_i32 = arith.constant <span class="number">1</span> : i32</span><br><span class="line">  %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %_constant = util.global.load @_constant : !stream.resource&lt;constant&gt;</span><br><span class="line">  hal.buffer_view.assert&lt;%arg0 : !hal.buffer_view&gt; <span class="built_in">message</span>(<span class="string">&quot;tensor&quot;</span>) <span class="built_in">shape</span>([%c1, %c10]) <span class="built_in">type</span>(%c553648160_i32) <span class="built_in">encoding</span>(%c1_i32)</span><br><span class="line">  %<span class="number">0</span> = stream.tensor.<span class="keyword">import</span> %arg0 : !hal.buffer_view -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt; in !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  %<span class="number">1</span> = stream.async.alloca : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  %<span class="number">2</span> = stream.async.dispatch @test_dispatch_0::@test_dispatch_0_generic_10[%c10](%<span class="number">0</span>[%c0 to %c40 <span class="keyword">for</span> %c40], %_constant[%c0 to %c40 <span class="keyword">for</span> %c40], %<span class="number">1</span>[%c0 to %c40 <span class="keyword">for</span> %c40]) : (!stream.resource&lt;external&gt;&#123;%c40&#125;, !stream.resource&lt;constant&gt;&#123;%c40&#125;, !stream.resource&lt;external&gt;&#123;%c40&#125;) -&gt; %<span class="number">1</span>&#123;%c40&#125;</span><br><span class="line">  %<span class="number">3</span> = stream.tensor.<span class="keyword">export</span> %<span class="number">2</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; in !stream.resource&lt;external&gt;&#123;%c40&#125; -&gt; !hal.buffer_view</span><br><span class="line">  <span class="keyword">return</span> %<span class="number">3</span> : !hal.buffer_view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">  %c40 = arith.constant <span class="number">40</span> : index</span><br><span class="line">  %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">  %c553648160_i32 = arith.constant <span class="number">553648160</span> : i32</span><br><span class="line">  %c1_i32 = arith.constant <span class="number">1</span> : i32</span><br><span class="line">  %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %_constant = util.global.load @_constant : !stream.resource&lt;constant&gt;</span><br><span class="line">  hal.buffer_view.assert&lt;%arg0 : !hal.buffer_view&gt; <span class="built_in">message</span>(<span class="string">&quot;tensor&quot;</span>) <span class="built_in">shape</span>([%c1, %c10]) <span class="built_in">type</span>(%c553648160_i32) <span class="built_in">encoding</span>(%c1_i32)</span><br><span class="line">  %<span class="number">0</span> = stream.tensor.<span class="keyword">import</span> %arg0 : !hal.buffer_view -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt; in !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  %results, %result_timepoint = stream.async.execute <span class="built_in">with</span>(%<span class="number">0</span> as %arg1: !stream.resource&lt;external&gt;&#123;%c40&#125;, %_constant as %arg2: !stream.resource&lt;constant&gt;&#123;%c40&#125;) -&gt; !stream.resource&lt;external&gt;&#123;%c40&#125; &#123;</span><br><span class="line">    %<span class="number">3</span> = stream.async.alloca : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">    %<span class="number">4</span> = stream.async.dispatch @test_dispatch_0::@test_dispatch_0_generic_10[%c10](%arg1[%c0 to %c40 <span class="keyword">for</span> %c40], %arg2[%c0 to %c40 <span class="keyword">for</span> %c40], %<span class="number">3</span>[%c0 to %c40 <span class="keyword">for</span> %c40]) : (!stream.resource&lt;external&gt;&#123;%c40&#125;, !stream.resource&lt;constant&gt;&#123;%c40&#125;, !stream.resource&lt;external&gt;&#123;%c40&#125;) -&gt; %<span class="number">3</span>&#123;%c40&#125;</span><br><span class="line">    stream.yield %<span class="number">4</span> : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  &#125; =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">1</span> = stream.timepoint.await %result_timepoint =&gt; %results : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  %<span class="number">2</span> = stream.tensor.<span class="keyword">export</span> %<span class="number">1</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; in !stream.resource&lt;external&gt;&#123;%c40&#125; -&gt; !hal.buffer_view</span><br><span class="line">  <span class="keyword">return</span> %<span class="number">2</span> : !hal.buffer_view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：该示例中只有一个part。</p></li>
<li><p>IREE::Stream::createScheduleConcurrencyPass</p>
<p>继续将<code>stream.async.execute</code>划分为多个并行调度区，每个并行调度区构成一个<code>stream.async.concurrent</code>
。</p></li>
<li><p>IREE::Stream::createPropagateTimepointsPass</p>
<p>给<code>stream.resource</code> 绑定一个
<code>stream.timepoint</code>，在代码中用<code>stream.resource + stream.timepoint</code>
的pair
替换原来的<code>stream.resource</code>，并在需要的地方插入await。</p>
<ul>
<li><p><code>util.global</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">util.global <span class="keyword">private</span> @_constant : !stream.resource&lt;constant&gt;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">util.global <span class="keyword">private</span> <span class="keyword">mutable</span> @_constant__timepoint = <span class="meta">#stream.timepoint<span class="string">&lt;immediate&gt;</span> : !stream.timepoint</span></span><br><span class="line">util.global <span class="keyword">private</span> @_constant : !stream.resource&lt;constant&gt;</span><br></pre></td></tr></table></figure></li>
<li><p><code>util.global.load</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%_constant = util.global.load @_constant : !stream.resource&lt;constant&gt;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%_constant__timepoint = util.global.load @_constant__timepoint : !stream.timepoint</span><br><span class="line">%_constant = util.global.load @_constant : !stream.resource&lt;constant&gt;</span><br><span class="line">%<span class="number">0</span> = stream.timepoint.await %_constant__timepoint =&gt; %_constant : !stream.resource&lt;constant&gt;&#123;%c40&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>util.global.store</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">util.global.store %<span class="number">0</span>, @_constant : !stream.resource&lt;constant&gt;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">util.global.store %result_timepoint, @_constant__timepoint : !stream.timepoint</span><br><span class="line">util.global.store %results, @_constant : !stream.resource&lt;constant&gt;</span><br></pre></td></tr></table></figure></li>
<li><p><code>func.func</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">foo</span>(%<span class="number">0</span>: !stream.resource) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">foo</span>(%t: !stream.timepoint, %<span class="number">0</span>: !stream.resource) &#123;</span><br><span class="line">  %<span class="number">1</span> = stream.timepoint.await %t, %<span class="number">0</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>call</code></p>
<p>由于func内部已经插入了await，因此call之前的冗余await可以删除，call之后需要再插入一个func返回值的await。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">1</span> = stream.timepoint.await %t, %<span class="number">0</span></span><br><span class="line">%r = call @<span class="built_in">foo</span>(%<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%rt, %r = call @<span class="built_in">foo</span>(%t, %<span class="number">0</span>)</span><br><span class="line">stream.timepoint.await %rt, %t</span><br></pre></td></tr></table></figure></li>
<li><p><code>return</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">1</span> = stream.timepoint.await %t, %<span class="number">0</span></span><br><span class="line"><span class="keyword">return</span> %<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> %t, %<span class="number">0</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>branch</code></p>
<p>将参数的await挪到branch里面。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">1</span> = stream.timepoint.await %t, %<span class="number">0</span></span><br><span class="line">br ^<span class="built_in">bb1</span>(%<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">^<span class="built_in">bb1</span>(%b):</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">br ^<span class="built_in">bb1</span>(%t, %<span class="number">0</span>)</span><br><span class="line">^<span class="built_in">bb1</span>(%a, %b):</span><br><span class="line">  %<span class="number">1</span> = stream.timepoint.await %a, %b</span><br></pre></td></tr></table></figure></li>
<li><p><code>stream.async.execute</code></p>
<p>为每个未绑定<code>stream.timepoint</code>的输入参数绑定一个<code>stream.timepoint</code>，并在<code>stream.async.execute</code>之前计算参数的最大timepoint，<code>stream.async.execute</code>
则await这个最大timepoint。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%results, %result_timepoint = stream.async.execute <span class="built_in">with</span>(%<span class="number">0</span> as %arg1: !stream.resource&lt;external&gt;&#123;%c40&#125;, %_constant as %arg2: !stream.resource&lt;constant&gt;&#123;%c40&#125;) -&gt; !stream.resource&lt;external&gt;&#123;%c40&#125; &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">3</span> = stream.timepoint.join <span class="built_in">max</span>(%<span class="number">2</span>, %_constant__timepoint) =&gt; !stream.timepoint</span><br><span class="line">%results, %result_timepoint = stream.async.execute <span class="built_in">await</span>(%<span class="number">3</span>) =&gt; <span class="built_in">with</span>(%<span class="number">1</span> as %arg1: !stream.resource&lt;external&gt;&#123;%c40&#125;, %_constant as %arg2: !stream.resource&lt;constant&gt;&#123;%c40&#125;) -&gt; !stream.resource&lt;external&gt;&#123;%c40&#125; &#123;</span><br><span class="line">   ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><p>addCleanupPatterns</p></li>
<li><p>IREE::Stream::createVerifyLoweringToAsyncPass</p>
<p>验证LoweringToAsyncPass阶段program的合法性。</p></li>
</ul></li>
<li><p>buildStreamCmdPassPipeline</p>
<ul>
<li><p>IREE::Stream::createScheduleAllocationPas</p>
<ul>
<li><p>首先将所有常量op聚合成一个<code>stream.resource.constants</code>，并移出该region，<code>stream.resource.constants</code>的结果会被append到该region的输入参数中（原本直接yield的常量除外）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%results, %result_timepoint = stream.async.execute <span class="built_in">with</span>() -&gt; !stream.resource&lt;constant&gt;&#123;%c40&#125; &#123;</span><br><span class="line">    %cst = stream.async.constant : !stream.resource&lt;constant&gt;&#123;%c40&#125; = dense&lt;[<span class="number">0.000000e+00</span>, <span class="number">0.00999999977</span>, <span class="number">2.000000e-02</span>, <span class="number">3.000000e-02</span>, <span class="number">4.000000e-02</span>, <span class="number">5.000000e-02</span>, <span class="number">6.000000e-02</span>, <span class="number">7.000000e-02</span>, <span class="number">8.000000e-02</span>, <span class="number">9.000000e-02</span>]&gt; : tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">    stream.yield %cst : !stream.resource&lt;constant&gt;&#123;%c40&#125;</span><br><span class="line">&#125; =&gt; !stream.timepoint</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%results, %result_timepoint = stream.resource.constants :</span><br><span class="line">    !stream.resource&lt;constant&gt;&#123;%c40&#125; = dense&lt;[<span class="number">0.000000e+00</span>, <span class="number">0.00999999977</span>, <span class="number">2.000000e-02</span>, <span class="number">3.000000e-02</span>, <span class="number">4.000000e-02</span>, <span class="number">5.000000e-02</span>, <span class="number">6.000000e-02</span>, <span class="number">7.000000e-02</span>, <span class="number">8.000000e-02</span>, <span class="number">9.000000e-02</span>]&gt; : tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">    =&gt; !stream.timepoint</span><br><span class="line">%<span class="number">0</span> = stream.cmd.execute <span class="built_in">with</span>() &#123;</span><br><span class="line">&#125; =&gt; !stream.timepoint</span><br><span class="line">%<span class="number">1</span> = stream.timepoint.join <span class="built_in">max</span>(%result_timepoint, %<span class="number">0</span>) =&gt; !stream.timepoint</span><br></pre></td></tr></table></figure></li>
<li><p>分析<code>stream.async.execute</code>
region中resource的类型和他们之间的alias关系，按照resource的类型统一分配空间。对于没有被Tied到输入（即非inplace）的results，会统一在region外面由<code>stream.resource.alloc</code>申请一段external空间，region再通过Tied的方式消费alloc的结果。对于中间临时的resource，经过<code>stream.resource.pack</code>计算需要分配的空间大小后统一由<code>stream.resource.alloca</code>申请一段transient空间，并会在region后面插入<code>stream.resource.dealloca</code>释放申请的临时空间。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">predict</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">  %c8 = arith.constant <span class="number">8</span> : index</span><br><span class="line">  %c40 = arith.constant <span class="number">40</span> : index</span><br><span class="line">  %c4 = arith.constant <span class="number">4</span> : index</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">  %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">  %c553648160_i32 = arith.constant <span class="number">553648160</span> : i32</span><br><span class="line">  %c1_i32 = arith.constant <span class="number">1</span> : i32</span><br><span class="line">  %c2 = arith.constant <span class="number">2</span> : index</span><br><span class="line">  hal.buffer_view.assert&lt;%arg0 : !hal.buffer_view&gt; <span class="built_in">message</span>(<span class="string">&quot;tensor&quot;</span>) <span class="built_in">shape</span>([%c1, %c2]) <span class="built_in">type</span>(%c553648160_i32) <span class="built_in">encoding</span>(%c1_i32)</span><br><span class="line">  %<span class="number">0</span> = stream.tensor.<span class="keyword">import</span> %arg0 : !hal.buffer_view -&gt; tensor&lt;<span class="number">1</span>x2xf32&gt; in !stream.resource&lt;external&gt;&#123;%c8&#125;</span><br><span class="line">  <span class="comment">// stream.async.execute</span></span><br><span class="line">  %results, %result_timepoint = stream.async.execute <span class="built_in">with</span>(%<span class="number">0</span> as %arg1: !stream.resource&lt;external&gt;&#123;%c8&#125;) -&gt; !stream.resource&lt;external&gt;&#123;%c40&#125; &#123;</span><br><span class="line">    %<span class="number">3</span> = stream.async.dispatch @predict_dispatch_0::@predict_dispatch_0_matmul_1x10x2[%c1, %c10](%arg1[%c0 to %c8 <span class="keyword">for</span> %c8]) : (!stream.resource&lt;external&gt;&#123;%c8&#125;) -&gt; !stream.resource&lt;transient&gt;&#123;%c40&#125;</span><br><span class="line">    %<span class="number">4</span> = stream.async.dispatch @predict_dispatch_1::@predict_dispatch_1_generic_10[%c1](%<span class="number">3</span>[%c0 to %c40 <span class="keyword">for</span> %c40]) : (!stream.resource&lt;transient&gt;&#123;%c40&#125;) -&gt; !stream.resource&lt;transient&gt;&#123;%c4&#125;</span><br><span class="line">    %<span class="number">5</span> = stream.async.dispatch @predict_dispatch_2::@predict_dispatch_2_generic_1x10[%c1, %c10](%<span class="number">3</span>[%c0 to %c40 <span class="keyword">for</span> %c40], %<span class="number">4</span>[%c0 to %c4 <span class="keyword">for</span> %c4]) : (!stream.resource&lt;transient&gt;&#123;%c40&#125;, !stream.resource&lt;transient&gt;&#123;%c4&#125;) -&gt; !stream.resource&lt;transient&gt;&#123;%c40&#125;</span><br><span class="line">    %<span class="number">6</span> = stream.async.dispatch @predict_dispatch_3::@predict_dispatch_3_generic_10[%c1](%<span class="number">5</span>[%c0 to %c40 <span class="keyword">for</span> %c40]) : (!stream.resource&lt;transient&gt;&#123;%c40&#125;) -&gt; !stream.resource&lt;transient&gt;&#123;%c4&#125;</span><br><span class="line">    %<span class="number">7</span> = stream.async.dispatch @predict_dispatch_4::@predict_dispatch_4_generic_1x10[%c1, %c10](%<span class="number">5</span>[%c0 to %c40 <span class="keyword">for</span> %c40], %<span class="number">6</span>[%c0 to %c4 <span class="keyword">for</span> %c4]) : (!stream.resource&lt;transient&gt;&#123;%c40&#125;, !stream.resource&lt;transient&gt;&#123;%c4&#125;) -&gt; !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">    stream.yield %<span class="number">7</span> : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  &#125; =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">1</span> = stream.timepoint.await %result_timepoint =&gt; %results : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  %<span class="number">2</span> = stream.tensor.<span class="keyword">export</span> %<span class="number">1</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; in !stream.resource&lt;external&gt;&#123;%c40&#125; -&gt; !hal.buffer_view</span><br><span class="line">  <span class="keyword">return</span> %<span class="number">2</span> : !hal.buffer_view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">predict</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">  %c8 = arith.constant <span class="number">8</span> : index</span><br><span class="line">  %c40 = arith.constant <span class="number">40</span> : index</span><br><span class="line">  %c4 = arith.constant <span class="number">4</span> : index</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">  %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">  %c553648160_i32 = arith.constant <span class="number">553648160</span> : i32</span><br><span class="line">  %c1_i32 = arith.constant <span class="number">1</span> : i32</span><br><span class="line">  %c2 = arith.constant <span class="number">2</span> : index</span><br><span class="line">  hal.buffer_view.assert&lt;%arg0 : !hal.buffer_view&gt; <span class="built_in">message</span>(<span class="string">&quot;tensor&quot;</span>) <span class="built_in">shape</span>([%c1, %c2]) <span class="built_in">type</span>(%c553648160_i32) <span class="built_in">encoding</span>(%c1_i32)</span><br><span class="line">  %<span class="number">0</span> = stream.tensor.<span class="keyword">import</span> %arg0 : !hal.buffer_view -&gt; tensor&lt;<span class="number">1</span>x2xf32&gt; in !stream.resource&lt;external&gt;&#123;%c8&#125;</span><br><span class="line">  %c0_0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  <span class="comment">// 申请输出resource的空间</span></span><br><span class="line">  %<span class="number">1</span> = stream.resource.alloc uninitialized : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  <span class="comment">// 计算临时resource所需要的空间大小</span></span><br><span class="line">  %<span class="number">2</span>:<span class="number">5</span> = stream.resource.pack <span class="built_in">slices</span>(&#123;</span><br><span class="line">    [<span class="number">0</span>, <span class="number">2</span>] = %c40,  <span class="comment">// [0, 2]是某个resource的lifetime，%40是resource size</span></span><br><span class="line">    [<span class="number">1</span>, <span class="number">2</span>] = %c4,</span><br><span class="line">    [<span class="number">2</span>, <span class="number">4</span>] = %c40,</span><br><span class="line">    [<span class="number">3</span>, <span class="number">4</span>] = %c4</span><br><span class="line">  &#125;) : index</span><br><span class="line">  <span class="comment">// 申请临时resource的空间</span></span><br><span class="line">  %result, %result_timepoint = stream.resource.alloca uninitialized : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125; =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">3</span> = stream.cmd.execute <span class="built_in">await</span>(%result_timepoint) =&gt; <span class="built_in">with</span>(%<span class="number">0</span> as %arg1: !stream.resource&lt;external&gt;&#123;%c8&#125;, %<span class="number">1</span> as %arg2: !stream.resource&lt;external&gt;&#123;%c40&#125;, %result as %arg3: !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;) &#123;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_0::@predict_dispatch_0_matmul_1x10x2[%c1, %c10] &#123;</span><br><span class="line">      ro %arg1[%c0 <span class="keyword">for</span> %c8] : !stream.resource&lt;external&gt;&#123;%c8&#125;,</span><br><span class="line">      wo %arg3[%<span class="number">2</span>#<span class="number">1</span> <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_1::@predict_dispatch_1_generic_10[%c1] &#123;</span><br><span class="line">      ro %arg3[%<span class="number">2</span>#<span class="number">1</span> <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;,</span><br><span class="line">      wo %arg3[%<span class="number">2</span>#<span class="number">2</span> <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_2::@predict_dispatch_2_generic_1x10[%c1, %c10] &#123;</span><br><span class="line">      ro %arg3[%<span class="number">2</span>#<span class="number">1</span> <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;,</span><br><span class="line">      ro %arg3[%<span class="number">2</span>#<span class="number">2</span> <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;,</span><br><span class="line">      wo %arg3[%<span class="number">2</span>#<span class="number">3</span> <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_3::@predict_dispatch_3_generic_10[%c1] &#123;</span><br><span class="line">      ro %arg3[%<span class="number">2</span>#<span class="number">3</span> <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;,</span><br><span class="line">      wo %arg3[%<span class="number">2</span>#<span class="number">4</span> <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_4::@predict_dispatch_4_generic_1x10[%c1, %c10] &#123;</span><br><span class="line">      ro %arg3[%<span class="number">2</span>#<span class="number">3</span> <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;,</span><br><span class="line">      ro %arg3[%<span class="number">2</span>#<span class="number">4</span> <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;,</span><br><span class="line">      wo %arg2[%c0_0 <span class="keyword">for</span> %c40] : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; =&gt; !stream.timepoint</span><br><span class="line">  <span class="comment">// 释放申请的临时空间</span></span><br><span class="line">  %<span class="number">4</span> = stream.resource.dealloca <span class="built_in">await</span>(%<span class="number">3</span>) =&gt; %result : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125; =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">5</span> = stream.timepoint.join <span class="built_in">max</span>(%<span class="number">4</span>, %<span class="number">3</span>) =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">6</span> = stream.timepoint.await %<span class="number">5</span> =&gt; %<span class="number">1</span> : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  %<span class="number">7</span> = stream.tensor.<span class="keyword">export</span> %<span class="number">6</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; in !stream.resource&lt;external&gt;&#123;%c40&#125; -&gt; !hal.buffer_view</span><br><span class="line">  <span class="keyword">return</span> %<span class="number">7</span> : !hal.buffer_view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><p>IREE::Stream::createPackConstantsPass</p>
<p>将<code>stream.resource.constants</code>的结果根据lifetime类型分成Constant和Variable两种，每一种都替换成一个<code>util.buffer.constant</code>
。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">util.initializer &#123;</span><br><span class="line">  %c40 = arith.constant <span class="number">40</span> : index</span><br><span class="line">  %results, %result_timepoint = stream.resource.constants :</span><br><span class="line">    !stream.resource&lt;constant&gt;&#123;%c40&#125; = dense&lt;[<span class="number">0.000000e+00</span>, <span class="number">0.00999999977</span>, <span class="number">2.000000e-02</span>, <span class="number">3.000000e-02</span>, <span class="number">4.000000e-02</span>, <span class="number">5.000000e-02</span>, <span class="number">6.000000e-02</span>, <span class="number">7.000000e-02</span>, <span class="number">8.000000e-02</span>, <span class="number">9.000000e-02</span>]&gt; : tensor&lt;<span class="number">10</span>xf32&gt;</span><br><span class="line">    =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">0</span> = stream.cmd.execute <span class="built_in">with</span>() &#123;</span><br><span class="line">  &#125; =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">1</span> = stream.timepoint.join <span class="built_in">max</span>(%result_timepoint, %<span class="number">0</span>) =&gt; !stream.timepoint</span><br><span class="line">  util.global.store %results, @_constant : !stream.resource&lt;constant&gt;</span><br><span class="line">  util.global.store %<span class="number">1</span>, @_constant__timepoint : !stream.timepoint</span><br><span class="line">  util.initializer.<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">util.initializer &#123;</span><br><span class="line">  %c40 = arith.constant <span class="number">40</span> : index</span><br><span class="line">  %buffer_cst = util.buffer.constant &#123;alignment = <span class="number">64</span> : index&#125; : !util.buffer = <span class="meta">#util.composite&lt;64xi8, [</span></span><br><span class="line">    dense&lt;[<span class="number">0.000000e+00</span>, <span class="number">0.00999999977</span>, <span class="number">2.000000e-02</span>, <span class="number">3.000000e-02</span>, <span class="number">4.000000e-02</span>, <span class="number">5.000000e-02</span>, <span class="number">6.000000e-02</span>, <span class="number">7.000000e-02</span>, <span class="number">8.000000e-02</span>, <span class="number">9.000000e-02</span>]&gt; : tensor&lt;<span class="number">10</span>xf32&gt;,</span><br><span class="line">    dense&lt;<span class="number">0</span>&gt; : vector&lt;<span class="number">24</span>xi8&gt;, <span class="comment">// 填充的无用数据</span></span><br><span class="line">]&gt;</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %c64 = arith.constant <span class="number">64</span> : index</span><br><span class="line">  <span class="comment">// 尝试将buffer映射为target (!stream.resource&lt;constant&gt;)</span></span><br><span class="line">  %did_map, %result = stream.resource.try_map %buffer_cst[%c0] : !util.buffer -&gt; i1, !stream.resource&lt;constant&gt;&#123;%c64&#125;</span><br><span class="line">  %<span class="number">0</span>:<span class="number">2</span> = scf.<span class="keyword">if</span> %did_map -&gt; (!stream.resource&lt;constant&gt;, !stream.timepoint) &#123;</span><br><span class="line">    <span class="comment">// 如果可以映射，则直接返回映射的结果（!stream.resource&lt;constant&gt;）</span></span><br><span class="line">    %<span class="number">4</span> = stream.timepoint.immediate =&gt; !stream.timepoint</span><br><span class="line">    scf.yield %result, %<span class="number">4</span> : !stream.resource&lt;constant&gt;, !stream.timepoint</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果不能映射，需要先将buffer映射为缓冲区（stage），然后申请一段新的空间并从缓冲区拷贝数据（copy）。</span></span><br><span class="line">    <span class="comment">// 如果lifetime类型是Variable，则不需要try_map，直接走该分支（stage + copy）的实现。</span></span><br><span class="line">    %<span class="number">4</span> = stream.resource.map %buffer_cst[%c0] : !util.buffer -&gt; !stream.resource&lt;staging&gt;&#123;%c64&#125;</span><br><span class="line">    %<span class="number">5</span> = stream.resource.alloc uninitialized : !stream.resource&lt;constant&gt;&#123;%c64&#125;</span><br><span class="line">    %<span class="number">6</span> = stream.cmd.execute <span class="built_in">with</span>(%<span class="number">4</span> as %arg0: !stream.resource&lt;staging&gt;&#123;%c64&#125;, %<span class="number">5</span> as %arg1: !stream.resource&lt;constant&gt;&#123;%c64&#125;) &#123;</span><br><span class="line">      stream.cmd.copy %arg0[%c0], %arg1[%c0], %c64 : !stream.resource&lt;staging&gt;&#123;%c64&#125; -&gt; !stream.resource&lt;constant&gt;&#123;%c64&#125;</span><br><span class="line">    &#125; =&gt; !stream.timepoint</span><br><span class="line">    scf.yield %<span class="number">5</span>, %<span class="number">6</span> : !stream.resource&lt;constant&gt;, !stream.timepoint</span><br><span class="line">  &#125;</span><br><span class="line">  %<span class="number">1</span> = stream.resource.subview %<span class="number">0</span>#<span class="number">0</span>[%c0] : !stream.resource&lt;constant&gt;&#123;%c64&#125; -&gt; !stream.resource&lt;constant&gt;&#123;%c40&#125;</span><br><span class="line">  %<span class="number">2</span> = stream.cmd.execute <span class="built_in">with</span>() &#123;</span><br><span class="line">  &#125; =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">3</span> = stream.timepoint.join <span class="built_in">max</span>(%<span class="number">0</span>#<span class="number">1</span>, %<span class="number">2</span>) =&gt; !stream.timepoint</span><br><span class="line">  util.global.store %<span class="number">1</span>, @_constant : !stream.resource&lt;constant&gt;</span><br><span class="line">  util.global.store %<span class="number">3</span>, @_constant__timepoint : !stream.timepoint</span><br><span class="line">  util.initializer.<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>IREE::Stream::createPackAllocationsPass</p>
<p>将包含多个resource的<code>stream.resource.alloc</code> 转换成
<code>stream.resource.pack + stream.resource.alloc</code>，并通过<code>stream.resource.subview</code>
获取每一个resource。</p></li>
<li><p>IREE::Stream::createLayoutSlicesPass</p>
<p>将<code>stream.resource.pack</code>转化为具体的内存复用算法计算过程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">predict</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">  %c8 = arith.constant <span class="number">8</span> : index</span><br><span class="line">  %c40 = arith.constant <span class="number">40</span> : index</span><br><span class="line">  %c4 = arith.constant <span class="number">4</span> : index</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">  %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">  %c553648160_i32 = arith.constant <span class="number">553648160</span> : i32</span><br><span class="line">  %c1_i32 = arith.constant <span class="number">1</span> : i32</span><br><span class="line">  %c2 = arith.constant <span class="number">2</span> : index</span><br><span class="line">  hal.buffer_view.assert&lt;%arg0 : !hal.buffer_view&gt; <span class="built_in">message</span>(<span class="string">&quot;tensor&quot;</span>) <span class="built_in">shape</span>([%c1, %c2]) <span class="built_in">type</span>(%c553648160_i32) <span class="built_in">encoding</span>(%c1_i32)</span><br><span class="line">  %<span class="number">0</span> = stream.tensor.<span class="keyword">import</span> %arg0 : !hal.buffer_view -&gt; tensor&lt;<span class="number">1</span>x2xf32&gt; in !stream.resource&lt;external&gt;&#123;%c8&#125;</span><br><span class="line">  %c0_0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  <span class="comment">// 申请输出resource的空间</span></span><br><span class="line">  %<span class="number">1</span> = stream.resource.alloc uninitialized : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  <span class="comment">// 计算临时resource所需要的空间大小</span></span><br><span class="line">  %<span class="number">2</span>:<span class="number">5</span> = stream.resource.pack <span class="built_in">slices</span>(&#123;</span><br><span class="line">    [<span class="number">0</span>, <span class="number">2</span>] = %c40,  <span class="comment">// [0, 2]是某个resource的lifetime，%40是resource size</span></span><br><span class="line">    [<span class="number">1</span>, <span class="number">2</span>] = %c4,</span><br><span class="line">    [<span class="number">2</span>, <span class="number">4</span>] = %c40,</span><br><span class="line">    [<span class="number">3</span>, <span class="number">4</span>] = %c4</span><br><span class="line">  &#125;) : index</span><br><span class="line">  <span class="comment">// 申请临时resource的空间</span></span><br><span class="line">  %result, %result_timepoint = stream.resource.alloca uninitialized : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125; =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">3</span> = stream.cmd.execute <span class="built_in">await</span>(%result_timepoint) =&gt; <span class="built_in">with</span>(%<span class="number">0</span> as %arg1: !stream.resource&lt;external&gt;&#123;%c8&#125;, %<span class="number">1</span> as %arg2: !stream.resource&lt;external&gt;&#123;%c40&#125;, %result as %arg3: !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;) &#123;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_0::@predict_dispatch_0_matmul_1x10x2[%c1, %c10] &#123;</span><br><span class="line">      ro %arg1[%c0 <span class="keyword">for</span> %c8] : !stream.resource&lt;external&gt;&#123;%c8&#125;,</span><br><span class="line">      wo %arg3[%<span class="number">2</span>#<span class="number">1</span> <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_1::@predict_dispatch_1_generic_10[%c1] &#123;</span><br><span class="line">      ro %arg3[%<span class="number">2</span>#<span class="number">1</span> <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;,</span><br><span class="line">      wo %arg3[%<span class="number">2</span>#<span class="number">2</span> <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_2::@predict_dispatch_2_generic_1x10[%c1, %c10] &#123;</span><br><span class="line">      ro %arg3[%<span class="number">2</span>#<span class="number">1</span> <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;,</span><br><span class="line">      ro %arg3[%<span class="number">2</span>#<span class="number">2</span> <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;,</span><br><span class="line">      wo %arg3[%<span class="number">2</span>#<span class="number">3</span> <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_3::@predict_dispatch_3_generic_10[%c1] &#123;</span><br><span class="line">      ro %arg3[%<span class="number">2</span>#<span class="number">3</span> <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;,</span><br><span class="line">      wo %arg3[%<span class="number">2</span>#<span class="number">4</span> <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_4::@predict_dispatch_4_generic_1x10[%c1, %c10] &#123;</span><br><span class="line">      ro %arg3[%<span class="number">2</span>#<span class="number">3</span> <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;,</span><br><span class="line">      ro %arg3[%<span class="number">2</span>#<span class="number">4</span> <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125;,</span><br><span class="line">      wo %arg2[%c0_0 <span class="keyword">for</span> %c40] : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; =&gt; !stream.timepoint</span><br><span class="line">  <span class="comment">// 释放申请的临时空间</span></span><br><span class="line">  %<span class="number">4</span> = stream.resource.dealloca <span class="built_in">await</span>(%<span class="number">3</span>) =&gt; %result : !stream.resource&lt;transient&gt;&#123;%<span class="number">2</span>#<span class="number">0</span>&#125; =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">5</span> = stream.timepoint.join <span class="built_in">max</span>(%<span class="number">4</span>, %<span class="number">3</span>) =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">6</span> = stream.timepoint.await %<span class="number">5</span> =&gt; %<span class="number">1</span> : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  %<span class="number">7</span> = stream.tensor.<span class="keyword">export</span> %<span class="number">6</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; in !stream.resource&lt;external&gt;&#123;%c40&#125; -&gt; !hal.buffer_view</span><br><span class="line">  <span class="keyword">return</span> %<span class="number">7</span> : !hal.buffer_view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">predict</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">  %c8 = arith.constant <span class="number">8</span> : index</span><br><span class="line">  %c40 = arith.constant <span class="number">40</span> : index</span><br><span class="line">  %c4 = arith.constant <span class="number">4</span> : index</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">  %c10 = arith.constant <span class="number">10</span> : index</span><br><span class="line">  %c553648160_i32 = arith.constant <span class="number">553648160</span> : i32</span><br><span class="line">  %c1_i32 = arith.constant <span class="number">1</span> : i32</span><br><span class="line">  %c2 = arith.constant <span class="number">2</span> : index</span><br><span class="line">  hal.buffer_view.assert&lt;%arg0 : !hal.buffer_view&gt; <span class="built_in">message</span>(<span class="string">&quot;tensor&quot;</span>) <span class="built_in">shape</span>([%c1, %c2]) <span class="built_in">type</span>(%c553648160_i32) <span class="built_in">encoding</span>(%c1_i32)</span><br><span class="line">  %<span class="number">0</span> = stream.tensor.<span class="keyword">import</span> %arg0 : !hal.buffer_view -&gt; tensor&lt;<span class="number">1</span>x2xf32&gt; in !stream.resource&lt;external&gt;&#123;%c8&#125;</span><br><span class="line">  %c0_0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %<span class="number">1</span> = stream.resource.alloc uninitialized : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  %c0_1 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %c64 = arith.constant <span class="number">64</span> : index</span><br><span class="line">  %c64_2 = arith.constant <span class="number">64</span> : index</span><br><span class="line">  %c128 = arith.constant <span class="number">128</span> : index</span><br><span class="line">  %c128_3 = arith.constant <span class="number">128</span> : index</span><br><span class="line">  %c192 = arith.constant <span class="number">192</span> : index</span><br><span class="line">  %c192_4 = arith.constant <span class="number">192</span> : index</span><br><span class="line">  %result, %result_timepoint = stream.resource.alloca uninitialized : !stream.resource&lt;transient&gt;&#123;%c192_4&#125; =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">2</span> = stream.cmd.execute <span class="built_in">await</span>(%result_timepoint) =&gt; <span class="built_in">with</span>(%<span class="number">0</span> as %arg1: !stream.resource&lt;external&gt;&#123;%c8&#125;, %<span class="number">1</span> as %arg2: !stream.resource&lt;external&gt;&#123;%c40&#125;, %result as %arg3: !stream.resource&lt;transient&gt;&#123;%c192_4&#125;) &#123;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_0::@predict_dispatch_0_matmul_1x10x2[%c1, %c10] &#123;</span><br><span class="line">      ro %arg1[%c0 <span class="keyword">for</span> %c8] : !stream.resource&lt;external&gt;&#123;%c8&#125;,</span><br><span class="line">      wo %arg3[%c0_1 <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%c192_4&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_1::@predict_dispatch_1_generic_10[%c1] &#123;</span><br><span class="line">      ro %arg3[%c0_1 <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%c192_4&#125;,</span><br><span class="line">      wo %arg3[%c64_2 <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%c192_4&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_2::@predict_dispatch_2_generic_1x10[%c1, %c10] &#123;</span><br><span class="line">      ro %arg3[%c0_1 <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%c192_4&#125;,</span><br><span class="line">      ro %arg3[%c64_2 <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%c192_4&#125;,</span><br><span class="line">      wo %arg3[%c128_3 <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%c192_4&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_3::@predict_dispatch_3_generic_10[%c1] &#123;</span><br><span class="line">      ro %arg3[%c128_3 <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%c192_4&#125;,</span><br><span class="line">      wo %arg3[%c0_1 <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%c192_4&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_4::@predict_dispatch_4_generic_1x10[%c1, %c10] &#123;</span><br><span class="line">      ro %arg3[%c128_3 <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%c192_4&#125;,</span><br><span class="line">      ro %arg3[%c0_1 <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%c192_4&#125;,</span><br><span class="line">      wo %arg2[%c0_0 <span class="keyword">for</span> %c40] : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">3</span> = stream.resource.dealloca <span class="built_in">await</span>(%<span class="number">2</span>) =&gt; %result : !stream.resource&lt;transient&gt;&#123;%c192_4&#125; =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">4</span> = stream.timepoint.join <span class="built_in">max</span>(%<span class="number">3</span>, %<span class="number">2</span>) =&gt; !stream.timepoint</span><br><span class="line">  %<span class="number">5</span> = stream.timepoint.await %<span class="number">4</span> =&gt; %<span class="number">1</span> : !stream.resource&lt;external&gt;&#123;%c40&#125;</span><br><span class="line">  %<span class="number">6</span> = stream.tensor.<span class="keyword">export</span> %<span class="number">5</span> : tensor&lt;<span class="number">1</span>x10xf32&gt; in !stream.resource&lt;external&gt;&#123;%c40&#125; -&gt; !hal.buffer_view</span><br><span class="line">  <span class="keyword">return</span> %<span class="number">6</span> : !hal.buffer_view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>IREE::Util::createPropagateSubrangesPass</p>
<p>把resource转换成 (resource, size, offset, length)的元组。</p>
<ul>
<li><p>util.global</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">util.global <span class="keyword">private</span> @_constant : !stream.resource&lt;constant&gt;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">util.global <span class="keyword">private</span> @_constant : !stream.resource&lt;constant&gt;</span><br><span class="line">util.global <span class="keyword">private</span> @_constant_size : index</span><br><span class="line">util.global <span class="keyword">private</span> @_constant_offset : index</span><br><span class="line">util.global <span class="keyword">private</span> @_constant_length : index</span><br></pre></td></tr></table></figure></li>
<li><p>util.global.load</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">0</span> = util.global.load @foo : !stream.resource</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">0</span> = util.global.load @foo : !stream.resource</span><br><span class="line">%s = util.global.load @foo_size : index</span><br><span class="line">%o = util.global.load @foo_offset : index</span><br><span class="line">%l = util.global.load @foo_length : index</span><br><span class="line">%<span class="number">1</span> = stream.resource.subview %<span class="number">0</span>[%o] :</span><br><span class="line">     !stream.resource&lt;*&gt;&#123;%s&#125; -&gt; !stream.resource&lt;*&gt;&#123;%l&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>util.global.store</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">1</span> = stream.resource.subview %<span class="number">0</span>[%o] :</span><br><span class="line">     !stream.resource&lt;*&gt;&#123;%s&#125; -&gt; !stream.resource&lt;*&gt;&#123;%l&#125;</span><br><span class="line">util.global.store %<span class="number">1</span>, @foo : !stream.resource</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">util.global.store %<span class="number">0</span>, @foo : !stream.resource <span class="comment">// 这里语义是正确的吗???</span></span><br><span class="line">util.global.store %s, @foo_size : index</span><br><span class="line">util.global.store %o, @foo_offset : index</span><br><span class="line">util.global.store %l, @foo_length : index</span><br></pre></td></tr></table></figure></li>
<li><p>func.func</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">foo</span>(%<span class="number">0</span>: !stream.resource) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">foo</span>(%<span class="number">0</span>: !stream.resource, %sz: index, %o: index, %l: index) &#123;</span><br><span class="line">  %<span class="number">1</span> = stream.resource.subview %<span class="number">0</span>[%o] : &#123;%sz&#125; -&gt; &#123;%l&#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>call</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">1</span> = stream.resource.subview %<span class="number">0</span>[%o] : &#123;%sz&#125; -&gt; &#123;%l&#125;</span><br><span class="line">%r = call @<span class="built_in">foo</span>(%<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%r, %rsz, %ro, %rl = call @<span class="built_in">foo</span>(%<span class="number">0</span>, %sz, %o, %l)</span><br><span class="line">%<span class="number">2</span> = stream.resource.subview %r[%ro] : &#123;%rsz&#125; -&gt; &#123;%rl&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>return</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">1</span> = stream.resource.subview %<span class="number">0</span>[%o] : &#123;%sz&#125; -&gt; &#123;%l&#125;</span><br><span class="line"><span class="keyword">return</span> %<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> %<span class="number">0</span>, %sz, %o, %l</span><br></pre></td></tr></table></figure></li>
<li><p>branch</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">1</span> = stream.resource.subview %<span class="number">0</span>[%o] : &#123;%sz&#125; -&gt; &#123;%l&#125;</span><br><span class="line">br ^<span class="built_in">bb1</span>(%<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">^<span class="built_in">bb1</span>(%b):</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">br ^<span class="built_in">bb1</span>(%<span class="number">0</span>, %sz, %o, %l)</span><br><span class="line">  </span><br><span class="line">^<span class="built_in">bb1</span>(%a, %b, %c, %d):</span><br><span class="line">  %<span class="number">1</span> = stream.resource.subview %a[%b] : &#123;%c&#125; -&gt; &#123;%d&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>cond_branch</p></li>
</ul></li>
<li><p>addCleanupPatterns</p></li>
<li><p>IREE::Stream::createVerifyLoweringToCmdPass</p>
<p>验证program的合法性。</p></li>
</ul></li>
<li><p>buildStreamOptimizationPassPipeline</p>
<ul>
<li><p>addCleanupPatterns</p></li>
<li><p>mlir::createConvertSCFToCFPass</p>
<p>将structured control flow算子转换成更低层基础块形式的control
flow算子。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test</span>(%pred: i32, %arg1: tensor&lt;<span class="number">2</span>x10xf32&gt;, %arg2: tensor&lt;<span class="number">2</span>x10xf32&gt;) -&gt; tensor&lt;<span class="number">2</span>x10xf32&gt; &#123;</span><br><span class="line">    %c0 = arith.constant <span class="number">0</span> : i32</span><br><span class="line">    %<span class="number">0</span> = arith.cmpi sgt, %pred, %c0 : i32</span><br><span class="line">    %<span class="number">1</span> = scf.<span class="keyword">if</span> %<span class="number">0</span> -&gt; (tensor&lt;<span class="number">2</span>x10xf32&gt;) &#123;</span><br><span class="line">      %<span class="number">2</span> = mhlo.add %arg1, %arg2 : tensor&lt;<span class="number">2</span>x10xf32&gt;</span><br><span class="line">      scf.yield %<span class="number">2</span> : tensor&lt;<span class="number">2</span>x10xf32&gt;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      %<span class="number">2</span> = mhlo.subtract %arg1, %arg2 : tensor&lt;<span class="number">2</span>x10xf32&gt;</span><br><span class="line">      scf.yield %<span class="number">2</span> : tensor&lt;<span class="number">2</span>x10xf32&gt;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> %<span class="number">1</span> : tensor&lt;<span class="number">2</span>x10xf32&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test</span>(%pred: i32, %arg1: tensor&lt;<span class="number">2</span>x10xf32&gt;, %arg2: tensor&lt;<span class="number">2</span>x10xf32&gt;) -&gt; tensor&lt;<span class="number">2</span>x10xf32&gt; &#123;</span><br><span class="line">    %c0 = arith.constant <span class="number">0</span> : i32</span><br><span class="line">    %<span class="number">0</span> = arith.cmpi sgt, %pred, %c0 : i32</span><br><span class="line">    cf.cond_br %<span class="number">0</span>, ^bb1, ^bb2</span><br><span class="line">  ^bb1:</span><br><span class="line">    %<span class="number">2</span> = mhlo.add %arg1, %arg2 : tensor&lt;<span class="number">2</span>x10xf32&gt;</span><br><span class="line">    cf.br ^<span class="built_in">bb3</span>(%<span class="number">2</span> : tensor&lt;<span class="number">2</span>x10xf32&gt;)</span><br><span class="line">  ^bb2:</span><br><span class="line">    %<span class="number">3</span> = mhlo.subtract %arg1, %arg2 : tensor&lt;<span class="number">2</span>x10xf32&gt;</span><br><span class="line">    cf.br ^<span class="built_in">bb3</span>(%<span class="number">3</span> : tensor&lt;<span class="number">2</span>x10xf32&gt;)</span><br><span class="line">  ^<span class="built_in">bb3</span>(%<span class="number">4</span>: tensor&lt;<span class="number">2</span>x10xf32&gt;):</span><br><span class="line">    <span class="keyword">return</span> %<span class="number">4</span> : tensor&lt;<span class="number">2</span>x10xf32&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>addCleanupPatterns</p></li>
<li><p>IREE::Stream::createElideTimepointsPass</p>
<p>消除已经确信到达的等待。比如</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%timepoint0 = ...</span><br><span class="line">%timepoint1 = ... <span class="built_in">await</span>(%timepoint0)</span><br><span class="line">%timepoint2 = stream.timepoint.join <span class="built_in">max</span>(%timepoint0, %timepoint1)</span><br></pre></td></tr></table></figure>
<p>timepoint1到达时timepoint0一定已经达到过，因此可以转换成，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%timepoint0 = ...</span><br><span class="line">%timepoint1 = ... <span class="built_in">await</span>(%timepoint0)</span><br><span class="line">%timepoint2 = stream.timepoint.join <span class="built_in">max</span>(%timepoint1)</span><br></pre></td></tr></table></figure>
<p>canonicalization之后最终是</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%timepoint0 = ...</span><br><span class="line">%timepoint1 = ... <span class="built_in">await</span>(%timepoint0)</span><br><span class="line">%timepoint2 = %timepoint1</span><br></pre></td></tr></table></figure></li>
<li><p>IREE::Util::createFixedPointIteratorPass</p>
<p>该pass触发重复执行一个pass
pipeline，直到达到固定迭代次数或最大迭代次数。这里的pipeline包括前面的addCleanupPatterns和createElideTimepointsPass两个子pass。</p></li>
<li><p>IREE::Stream::createFuseDispatchBindingsPass</p>
<p>根据<code>stream.cmd.dispatch</code> 的resource关系合并dispatch
executable的bindings，比如<code>stream.cmd.dispatch</code>
两个resource是同一个地址的不同range，则可以计算每个resource在base地址上的偏移，并将这两个resource合并成一个binding，在dispatch
executable中根据偏移来截取每个被合并的binding。该操作默认只合并read
only的resource。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">stream.executable <span class="keyword">private</span> @predict_dispatch_2 &#123;</span><br><span class="line">  stream.executable.<span class="keyword">export</span> <span class="keyword">public</span> @<span class="function">predict_dispatch_2_generic_1x10 <span class="title">workgroups</span><span class="params">(%arg0: index, %arg1: index)</span> -&gt; <span class="params">(index, index, index)</span> </span>&#123;</span><br><span class="line">    %x, %y, %z = flow.dispatch.workgroup_count_from_dag_root %arg0, %arg1</span><br><span class="line">    stream.<span class="keyword">return</span> %x, %y, %z : index, index, index</span><br><span class="line">  &#125;</span><br><span class="line">  builtin.<span class="keyword">module</span> &#123;</span><br><span class="line">    func.func @<span class="built_in">predict_dispatch_2_generic_1x10</span>(%arg0: !stream.binding, %arg1: !stream.binding, %arg2: !stream.binding) &#123;</span><br><span class="line">      %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">      %<span class="number">0</span> = stream.binding.subspan %arg0[%c0] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">1</span>x10xf32&gt;&gt;</span><br><span class="line">      %<span class="number">1</span> = stream.binding.subspan %arg1[%c0] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readonly:tensor&lt;f32&gt;&gt;</span><br><span class="line">      %<span class="number">2</span> = stream.binding.subspan %arg2[%c0] : !stream.binding -&gt; !flow.dispatch.tensor&lt;writeonly:tensor&lt;<span class="number">1</span>x10xf32&gt;&gt;</span><br><span class="line">      %<span class="number">3</span> = flow.dispatch.tensor.load %<span class="number">0</span>, offsets = [<span class="number">0</span>, <span class="number">0</span>], sizes = [<span class="number">1</span>, <span class="number">10</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">1</span>x10xf32&gt;&gt; -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt;</span><br><span class="line">      %<span class="number">4</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [], sizes = [], strides = [] : !flow.dispatch.tensor&lt;readonly:tensor&lt;f32&gt;&gt; -&gt; tensor&lt;f32&gt;</span><br><span class="line">      %<span class="number">5</span> = tensor.<span class="built_in">empty</span>() : tensor&lt;<span class="number">1</span>x10xf32&gt;</span><br><span class="line">      %<span class="number">6</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; ()&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;parallel&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">3</span>, %<span class="number">4</span> : tensor&lt;<span class="number">1</span>x10xf32&gt;, tensor&lt;f32&gt;) <span class="built_in">outs</span>(%<span class="number">5</span> : tensor&lt;<span class="number">1</span>x10xf32&gt;) &#123;</span><br><span class="line">      ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">        %<span class="number">7</span> = arith.subf %in, %in_0 : f32</span><br><span class="line">        %<span class="number">8</span> = math.exp %<span class="number">7</span> : f32</span><br><span class="line">        linalg.yield %<span class="number">8</span> : f32</span><br><span class="line">      &#125; -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt;</span><br><span class="line">      flow.dispatch.tensor.store %<span class="number">6</span>, %<span class="number">2</span>, offsets = [<span class="number">0</span>, <span class="number">0</span>], sizes = [<span class="number">1</span>, <span class="number">10</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;<span class="number">1</span>x10xf32&gt; -&gt; !flow.dispatch.tensor&lt;writeonly:tensor&lt;<span class="number">1</span>x10xf32&gt;&gt;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func.func @<span class="built_in">predict</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">  ...</span><br><span class="line">  %<span class="number">2</span> = stream.cmd.execute <span class="built_in">await</span>(%result_timepoint) =&gt; <span class="built_in">with</span>(%<span class="number">0</span> as %arg1: !stream.resource&lt;external&gt;&#123;%c8&#125;, %<span class="number">1</span> as %arg2: !stream.resource&lt;external&gt;&#123;%c40&#125;, %result as %arg3: !stream.resource&lt;transient&gt;&#123;%c192&#125;) &#123;</span><br><span class="line">    ...</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_2::@predict_dispatch_2_generic_1x10[%c1, %c10] &#123;</span><br><span class="line">        ro %arg3[%c0 <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%c192&#125;,</span><br><span class="line">        ro %arg3[%c64 <span class="keyword">for</span> %c4] : !stream.resource&lt;transient&gt;&#123;%c192&#125;,</span><br><span class="line">        wo %arg3[%c128 <span class="keyword">for</span> %c40] : !stream.resource&lt;transient&gt;&#123;%c192&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">stream.executable <span class="keyword">private</span> @predict_dispatch_2 &#123;</span><br><span class="line">  stream.executable.<span class="keyword">export</span> <span class="keyword">public</span> @<span class="function">predict_dispatch_2_generic_1x10 <span class="title">workgroups</span><span class="params">(%arg0: index, %arg1: index)</span> -&gt; <span class="params">(index, index, index)</span> </span>&#123;</span><br><span class="line">    %x, %y, %z = flow.dispatch.workgroup_count_from_dag_root %arg0, %arg1</span><br><span class="line">    stream.<span class="keyword">return</span> %x, %y, %z : index, index, index</span><br><span class="line">  &#125;</span><br><span class="line">  builtin.<span class="keyword">module</span> &#123;</span><br><span class="line">    func.func @<span class="built_in">predict_dispatch_2_generic_1x10</span>(%arg0: !stream.binding, %arg1: !stream.binding, %arg2: index, %arg3: index, %arg4: index) &#123;</span><br><span class="line">      %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">      %<span class="number">0</span> = arith.addi %c0, %arg2 : index</span><br><span class="line">      %<span class="number">1</span> = stream.binding.subspan %arg0[%<span class="number">0</span>] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">1</span>x10xf32&gt;&gt;</span><br><span class="line">      %<span class="number">2</span> = arith.addi %c0, %arg3 : index</span><br><span class="line">      %<span class="number">3</span> = stream.binding.subspan %arg0[%<span class="number">2</span>] : !stream.binding -&gt; !flow.dispatch.tensor&lt;readonly:tensor&lt;f32&gt;&gt;</span><br><span class="line">      %<span class="number">4</span> = arith.addi %c0, %arg4 : index</span><br><span class="line">      %<span class="number">5</span> = stream.binding.subspan %arg1[%<span class="number">4</span>] : !stream.binding -&gt; !flow.dispatch.tensor&lt;writeonly:tensor&lt;<span class="number">1</span>x10xf32&gt;&gt;</span><br><span class="line">      %<span class="number">6</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [<span class="number">0</span>, <span class="number">0</span>], sizes = [<span class="number">1</span>, <span class="number">10</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">1</span>x10xf32&gt;&gt; -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt;</span><br><span class="line">      %<span class="number">7</span> = flow.dispatch.tensor.load %<span class="number">3</span>, offsets = [], sizes = [], strides = [] : !flow.dispatch.tensor&lt;readonly:tensor&lt;f32&gt;&gt; -&gt; tensor&lt;f32&gt;</span><br><span class="line">      %<span class="number">8</span> = tensor.<span class="built_in">empty</span>() : tensor&lt;<span class="number">1</span>x10xf32&gt;</span><br><span class="line">      %<span class="number">9</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; ()&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;parallel&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">6</span>, %<span class="number">7</span> : tensor&lt;<span class="number">1</span>x10xf32&gt;, tensor&lt;f32&gt;) <span class="built_in">outs</span>(%<span class="number">8</span> : tensor&lt;<span class="number">1</span>x10xf32&gt;) &#123;</span><br><span class="line">      ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">        %<span class="number">10</span> = arith.subf %in, %in_0 : f32</span><br><span class="line">        %<span class="number">11</span> = math.exp %<span class="number">10</span> : f32</span><br><span class="line">        linalg.yield %<span class="number">11</span> : f32</span><br><span class="line">      &#125; -&gt; tensor&lt;<span class="number">1</span>x10xf32&gt;</span><br><span class="line">      flow.dispatch.tensor.store %<span class="number">9</span>, %<span class="number">5</span>, offsets = [<span class="number">0</span>, <span class="number">0</span>], sizes = [<span class="number">1</span>, <span class="number">10</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;<span class="number">1</span>x10xf32&gt; -&gt; !flow.dispatch.tensor&lt;writeonly:tensor&lt;<span class="number">1</span>x10xf32&gt;&gt;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func.func @<span class="built_in">predict</span>(%arg0: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">  ...</span><br><span class="line">  %<span class="number">2</span> = stream.cmd.execute <span class="built_in">await</span>(%result_timepoint) =&gt; <span class="built_in">with</span>(%<span class="number">0</span> as %arg1: !stream.resource&lt;external&gt;&#123;%c8&#125;, %<span class="number">1</span> as %arg2: !stream.resource&lt;external&gt;&#123;%c40&#125;, %result as %arg3: !stream.resource&lt;transient&gt;&#123;%c192&#125;) &#123;</span><br><span class="line">    ...</span><br><span class="line">    stream.cmd.dispatch @predict_dispatch_2::@predict_dispatch_2_generic_1x10[%c1, %c10](%c0, %c64, %c128 : index, index, index) &#123;</span><br><span class="line">      ro %arg3[%c0_0 <span class="keyword">for</span> %c192] : !stream.resource&lt;transient&gt;&#123;%c192&#125;,</span><br><span class="line">      wo %arg3[%c0_0 <span class="keyword">for</span> %c192] : !stream.resource&lt;transient&gt;&#123;%c192&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>stream.cmd.dispatch @predict_dispatch_2</code>的resource被合并为2个，<code>predict_dispatch_2_generic_1x10</code>
dispatch
executable参数中的binding也减少为2个，但增加了3个表示offset的index，被合并的binding根据offset来截取。</p></li>
<li><p>IREE::Stream::createPackDispatchOperandsPass</p>
<p>将dispatch executable参数中的标量/index类型转换成i32或i64类型。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">predict_dispatch_2_generic_1x10</span>(%arg0: !stream.binding, %arg1: !stream.binding, %arg2: index, %arg3: index, %arg4: index) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">predict_dispatch_2_generic_1x10</span>(%arg0: !stream.binding, %arg1: !stream.binding, %arg2: i32, %arg3: i32, %arg4: i32) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>mlir::createCSEPass</p></li>
<li><p>IREE::Stream::createFoldUniformOperandsPass</p>
<p>折叠dispatch executable的所有调用中相同的参数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stream.cmd.dispatch @<span class="built_in">foo</span>(%c1, %c100 : index, index)</span><br><span class="line">stream.cmd.dispatch @<span class="built_in">foo</span>(%c1, %c101 : index, index)</span><br><span class="line">stream.cmd.dispatch @<span class="built_in">foo2</span>(%c1, %c101 : index, index)</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stream.cmd.dispatch @<span class="built_in">foo</span>(%c100 : index)</span><br><span class="line">stream.cmd.dispatch @<span class="built_in">foo</span>(%c101 : index)</span><br><span class="line">stream.cmd.dispatch @<span class="built_in">foo2</span>()</span><br></pre></td></tr></table></figure>
<p><code>@foo</code>内联了<code>%c1</code>，<code>@foo2</code>内联了<code>%c1</code>和<code>%c101</code>。</p></li>
<li><p>IREE::Stream::createAnnotateDispatchArgumentsPass</p>
<p>给dispatch executable的参数添加potential value和alignment信息。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">predict_dispatch_2_generic_1x10</span>(%arg0: !stream.binding, %arg1: !stream.binding) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换为</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">predict_dispatch_2_generic_1x10</span>(%arg0: !stream.binding &#123;stream.alignment = <span class="number">64</span> : index&#125;, %arg1: !stream.binding &#123;stream.alignment = <span class="number">64</span> : index&#125;) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><p>IREE::Stream::createMemoizeChannelsPass</p>
<p>找出所有<code>stream.channel.default</code>
ops，为每一个<code>stream.channel.default</code>
op创建一个全局缓冲区，同时在初始化时创建对应的channel，并将channel结果写入全局缓冲区，最后将该<code>stream.channel.default</code>
op替换为全局缓冲区的<code>util.global.load</code> op。</p></li>
<li><p>addCleanupPatterns</p></li>
<li><p>mlir::createSymbolDCEPass</p></li>
</ul>

      
    </div>
      
      <footer>
        
  
  <div class="categories">
    <a href="/categories/DL-Compiler/">DL Compiler</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Deep-Learning-Compiler/">Deep Learning Compiler</a>, <a href="/tags/IREE/">IREE</a>
  </div>

        
  <div class="addthis addthis_toolbox addthis_default_style">
    
      <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
    
    
      <a class="addthis_button_tweet"></a>
    
    
      <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    
    
      <a class="addthis_button_pinterest_pinit" pi:pinit:layout="horizontal"></a>
    
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script>

      
      <div class="clearfix"></div>
      </footer>
  </div>
</article>


<section id="comment">
  
</section>


</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:hjchen2.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Recent Posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/2023/02/24/IREE编译流程6/">IREE编译流程解析(六)</a>
      </li>
    
      <li>
        <a href="/2023/02/13/IREE编译流程5/">IREE编译流程解析(五)</a>
      </li>
    
      <li>
        <a href="/2023/01/04/IREE编译流程4/">IREE编译流程解析(四)</a>
      </li>
    
      <li>
        <a href="/2023/01/04/IREE编译流程3/">IREE编译流程解析(三)</a>
      </li>
    
      <li>
        <a href="/2023/01/04/IREE编译流程2/">IREE编译流程解析(二)</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/DL-Compiler/">DL Compiler</a><small>8</small></li>
  
    <li><a href="/categories/Daily/">Daily</a><small>1</small></li>
  
    <li><a href="/categories/ML-framework/">ML framework</a><small>2</small></li>
  
    <li><a href="/categories/XRT/">XRT</a><small>1</small></li>
  
    <li><a href="/categories/code/">code</a><small>1</small></li>
  
    <li><a href="/categories/deep-learning/">deep learning</a><small>1</small></li>
  
    <li><a href="/categories/graph-optimization-图优化/">graph optimization, 图优化</a><small>1</small></li>
  
    <li><a href="/categories/kaldi-decision-tree-决策树/">kaldi, decision tree, 决策树</a><small>1</small></li>
  
    <li><a href="/categories/low-bitwidth/">low bitwidth</a><small>1</small></li>
  
    <li><a href="/categories/model-compression/">model compression</a><small>1</small></li>
  
    <li><a href="/categories/neural-machine-translation/">neural machine translation</a><small>1</small></li>
  
    <li><a href="/categories/reinforcement-learning/">reinforcement learning</a><small>3</small></li>
  
    <li><a href="/categories/tvm-knowledge/">tvm knowledge</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">Tag Cloud</h3>
  <div class="entry">
    <a href="/tags/Attention/" style="font-size: 10px;">Attention</a> <a href="/tags/Compiler/" style="font-size: 10px;">Compiler</a> <a href="/tags/Deep-Learning-Compiler/" style="font-size: 20px;">Deep Learning Compiler</a> <a href="/tags/Encoder-Decoder/" style="font-size: 10px;">Encoder-Decoder</a> <a href="/tags/FusionStitching/" style="font-size: 10px;">FusionStitching</a> <a href="/tags/HMM/" style="font-size: 10px;">HMM</a> <a href="/tags/IREE/" style="font-size: 17.5px;">IREE</a> <a href="/tags/KunPeng/" style="font-size: 10px;">KunPeng</a> <a href="/tags/PackedFunc/" style="font-size: 10px;">PackedFunc</a> <a href="/tags/QVNNI16/" style="font-size: 10px;">QVNNI16</a> <a href="/tags/TVM/" style="font-size: 10px;">TVM</a> <a href="/tags/TensorFlow-XLA/" style="font-size: 10px;">TensorFlow XLA</a> <a href="/tags/TensorRT/" style="font-size: 10px;">TensorRT</a> <a href="/tags/XLA/" style="font-size: 10px;">XLA</a> <a href="/tags/XRT/" style="font-size: 10px;">XRT</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/caffe/" style="font-size: 12.5px;">caffe</a> <a href="/tags/decision-tree/" style="font-size: 10px;">decision tree</a> <a href="/tags/deep-learning/" style="font-size: 12.5px;">deep learning</a> <a href="/tags/embedding/" style="font-size: 10px;">embedding</a> <a href="/tags/fp16/" style="font-size: 10px;">fp16</a> <a href="/tags/framework/" style="font-size: 10px;">framework</a> <a href="/tags/graph-optimization/" style="font-size: 10px;">graph optimization</a> <a href="/tags/int16/" style="font-size: 10px;">int16</a> <a href="/tags/kaldi/" style="font-size: 10px;">kaldi</a> <a href="/tags/large-scale-ML-framework/" style="font-size: 10px;">large scale ML framework</a> <a href="/tags/loss-scaling/" style="font-size: 10px;">loss scaling</a> <a href="/tags/machine-learning/" style="font-size: 12.5px;">machine learning</a> <a href="/tags/machine-learning%EF%BC%8C%E8%B4%9D%E5%B0%94%E6%9B%BC%E5%85%AC%E5%BC%8F%E6%8E%A8%E5%AF%BC/" style="font-size: 10px;">machine learning，贝尔曼公式推导</a> <a href="/tags/machine-translation/" style="font-size: 10px;">machine translation</a> <a href="/tags/momentum/" style="font-size: 10px;">momentum</a> <a href="/tags/pruning/" style="font-size: 10px;">pruning</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/reinforcement-learning/" style="font-size: 15px;">reinforcement learning</a> <a href="/tags/seq2seq/" style="font-size: 10px;">seq2seq</a> <a href="/tags/substitution/" style="font-size: 10px;">substitution</a> <a href="/tags/super-optimization/" style="font-size: 10px;">super optimization</a> <a href="/tags/web-technology/" style="font-size: 10px;">web technology</a> <a href="/tags/%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9B%B8%E5%85%B3%E9%9F%B3%E7%B4%A0/" style="font-size: 10px;">上下文相关音素</a> <a href="/tags/%E5%86%B3%E7%AD%96%E6%A0%91/" style="font-size: 10px;">决策树</a> <a href="/tags/%E5%9B%BE%E6%9B%BF%E6%8D%A2/" style="font-size: 10px;">图替换</a> <a href="/tags/%E6%B7%B7%E5%90%88%E7%B2%BE%E5%BA%A6%E8%AE%AD%E7%BB%83/" style="font-size: 10px;">混合精度训练</a> <a href="/tags/%E8%B6%85%E4%BC%98%E5%8C%96/" style="font-size: 10px;">超优化</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2023 Dou Jiang
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



</body>
</html>

