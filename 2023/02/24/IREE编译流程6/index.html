
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>IREE编译流程解析(六) | Don&#39;t Respond</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Dou Jiang">
    

    
    <meta name="description" content="HAL::HALTransformPassPipeline的主要作用是进行tiling、vectorization和bufferization等操作，分配计算负载，最终生成target device的代码。比如cuda target的dispatch source code会被递降为NVVM IR。">
<meta property="og:type" content="article">
<meta property="og:title" content="IREE编译流程解析(六)">
<meta property="og:url" content="https://hjchen2.github.io/2023/02/24/IREE%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B6/index.html">
<meta property="og:site_name" content="Don&#39;t Respond">
<meta property="og:description" content="HAL::HALTransformPassPipeline的主要作用是进行tiling、vectorization和bufferization等操作，分配计算负载，最终生成target device的代码。比如cuda target的dispatch source code会被递降为NVVM IR。">
<meta property="og:locale">
<meta property="article:published_time" content="2023-02-24T10:47:11.000Z">
<meta property="article:modified_time" content="2023-02-24T11:03:14.679Z">
<meta property="article:author" content="Dou Jiang">
<meta property="article:tag" content="Deep Learning Compiler">
<meta property="article:tag" content="IREE">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="Don&#39;t Respond" type="application/atom+xml">
    
    
    
    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Don&#39;t Respond">Don&#39;t Respond</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:hjchen2.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2023/02/24/IREE编译流程6/" title="IREE编译流程解析(六)" itemprop="url">IREE编译流程解析(六)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Dou Jiang" target="_blank" itemprop="author">Dou Jiang</a>
		
  <p class="article-time">
    <time datetime="2023-02-24T10:47:11.000Z" itemprop="datePublished"> Published 2023-02-24</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			
		
		</div>
		
		<p>HAL::HALTransformPassPipeline的主要作用是进行tiling、vectorization和bufferization等操作，分配计算负载，最终生成target
device的代码。比如cuda target的dispatch source code会被递降为NVVM
IR。</p>
<span id="more"></span>
<ul>
<li><p>buildHALConfigurationPassPipeline</p>
<ul>
<li><p>addCleanupPatterns</p></li>
<li><p>createAssignTargetDevicesPass</p>
<p>在最外层的module上添加device targets属性，可以指定多个target
devices。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> attributes &#123;hal.device.targets = [<span class="meta">#hal.device.target<span class="string">&lt;&quot;cuda&quot;, &#123;executable_targets = [#hal.executable.target&lt;&quot;cuda&quot;, &quot;cuda-nvptx-fb&quot;, &#123;target_arch = &quot;sm_35&quot;&#125;&gt;</span>], legacy_sync&#125;&gt;]&#125; &#123;</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>createVerifyTargetEnvironmentPass</p>
<p>验证device tagets是否正确设置，以及编译后端是否被注册过。</p></li>
<li><p>createMaterializeInterfacesPass</p>
<p>为每个executable创建device target相关的变体（variant），每一种device
target对应一个executable variant。将executable的export和source
func都转换为无参数的func，统一dispatch、export和source
func的调用接口，dispatch指定输入和bindings的关系，source
func则通过binding id来获取输入参数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">stream.executable <span class="keyword">private</span> @test_dispatch_0 &#123;</span><br><span class="line">  stream.executable.<span class="keyword">export</span> <span class="keyword">public</span> @<span class="function">test_dispatch_0_generic_100000x100 <span class="title">workgroups</span><span class="params">(%arg0: index, %arg1: index)</span> -&gt; <span class="params">(index, index, index)</span> </span>&#123;</span><br><span class="line">    %x, %y, %z = flow.dispatch.workgroup_count_from_dag_root %arg0, %arg1</span><br><span class="line">    stream.<span class="keyword">return</span> %x, %y, %z : index, index, index</span><br><span class="line">  &#125;</span><br><span class="line">  builtin.<span class="keyword">module</span> &#123;</span><br><span class="line">    func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>(%arg0: !stream.binding &#123;stream.alignment = <span class="number">64</span> : index&#125;, %arg1: !stream.binding &#123;stream.alignment = <span class="number">64</span> : index&#125;, %arg2: !stream.binding &#123;stream.alignment = <span class="number">64</span> : index&#125;) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func.func @<span class="built_in">test</span>(%arg0: !hal.buffer_view, %arg1: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">  ...</span><br><span class="line">  %<span class="number">3</span> = stream.cmd.execute <span class="built_in">with</span>(%<span class="number">0</span> as %arg2: !stream.resource&lt;external&gt;&#123;%c40000000&#125;, %<span class="number">1</span> as %arg3: !stream.resource&lt;external&gt;&#123;%c40000000&#125;, %<span class="number">2</span> as %arg4: !stream.resource&lt;external&gt;&#123;%c400000&#125;) &#123;</span><br><span class="line">    stream.cmd.fill %c0_i8, %arg4[%c0 <span class="keyword">for</span> %c400000] : i8 -&gt; !stream.resource&lt;external&gt;&#123;%c400000&#125;</span><br><span class="line">    stream.cmd.dispatch @test_dispatch_0::@test_dispatch_0_generic_100000x100[%c100000, %c1] &#123;</span><br><span class="line">      ro %arg2[%c0 <span class="keyword">for</span> %c40000000] : !stream.resource&lt;external&gt;&#123;%c40000000&#125;,</span><br><span class="line">      ro %arg3[%c0 <span class="keyword">for</span> %c40000000] : !stream.resource&lt;external&gt;&#123;%c40000000&#125;,</span><br><span class="line">      rw %arg4[%c0 <span class="keyword">for</span> %c400000] : !stream.resource&lt;external&gt;&#123;%c400000&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; =&gt; !stream.timepoint</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换为</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">hal.executable <span class="keyword">private</span> @test_dispatch_0 &#123;</span><br><span class="line">  hal.executable.variant <span class="keyword">public</span> @cuda_nvptx_fb, target = &lt;<span class="string">&quot;cuda&quot;</span>, <span class="string">&quot;cuda-nvptx-fb&quot;</span>, &#123;target_arch = <span class="string">&quot;sm_35&quot;</span>&#125;&gt; &#123;</span><br><span class="line">    hal.executable.<span class="keyword">export</span> <span class="keyword">public</span> @test_dispatch_0_generic_100000x100 <span class="built_in">ordinal</span>(<span class="number">0</span>) <span class="built_in">layout</span>(<span class="meta">#hal.pipeline.layout<span class="string">&lt;push_constants = 0, sets = [&lt;0, bindings = [&lt;0, storage_buffer, ReadOnly&gt;</span>, <span class="string">&lt;1, storage_buffer, ReadOnly&gt;</span>, <span class="string">&lt;2, storage_buffer&gt;</span>]&gt;]&gt;) &#123;</span></span><br><span class="line">    ^<span class="built_in">bb0</span>(%arg0: !hal.device, %arg1: index, %arg2: index):</span><br><span class="line">      %x, %y, %z = flow.dispatch.workgroup_count_from_dag_root %arg1, %arg2</span><br><span class="line">      hal.<span class="keyword">return</span> %x, %y, %z : index, index, index</span><br><span class="line">    &#125;</span><br><span class="line">    builtin.<span class="keyword">module</span> &#123;</span><br><span class="line">      func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">        %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">        %<span class="number">0</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">0</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt;</span><br><span class="line">        %<span class="number">1</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">1</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt;</span><br><span class="line">        %<span class="number">2</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">2</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt;</span><br><span class="line">         ...</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func.func @<span class="built_in">test</span>(%arg0: !hal.buffer_view, %arg1: !hal.buffer_view) -&gt; !hal.buffer_view attributes &#123;iree.abi.stub&#125; &#123;</span><br><span class="line">  ...</span><br><span class="line">  %<span class="number">3</span> = stream.cmd.execute <span class="built_in">with</span>(%<span class="number">0</span> as %arg2: !stream.resource&lt;external&gt;&#123;%c40000000&#125;, %<span class="number">1</span> as %arg3: !stream.resource&lt;external&gt;&#123;%c40000000&#125;, %<span class="number">2</span> as %arg4: !stream.resource&lt;external&gt;&#123;%c400000&#125;) &#123;</span><br><span class="line">    stream.cmd.fill %c0_i8, %arg4[%c0 <span class="keyword">for</span> %c400000] : i8 -&gt; !stream.resource&lt;external&gt;&#123;%c400000&#125;</span><br><span class="line">    stream.cmd.dispatch @test_dispatch_0::@test_dispatch_0_generic_100000x100[%c100000, %c1] &#123;</span><br><span class="line">      ro %arg2[%c0 <span class="keyword">for</span> %c40000000] : !stream.resource&lt;external&gt;&#123;%c40000000&#125;,</span><br><span class="line">      ro %arg3[%c0 <span class="keyword">for</span> %c40000000] : !stream.resource&lt;external&gt;&#123;%c40000000&#125;,</span><br><span class="line">      rw %arg4[%c0 <span class="keyword">for</span> %c400000] : !stream.resource&lt;external&gt;&#123;%c400000&#125;</span><br><span class="line">    &#125; attributes &#123;hal.interface.bindings = [<span class="meta">#hal.interface.binding<span class="string">&lt;0, 0&gt;</span>, #hal.interface.binding<span class="string">&lt;0, 1&gt;</span>, #hal.interface.binding<span class="string">&lt;0, 2&gt;</span>]&#125;</span></span><br><span class="line">  &#125; =&gt; !stream.timepoint</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><p>createTranslateExecutablesPass</p>
<p>根据每一个<code>hal.executable.variant</code> 的target
device调用对应的后端进行编译。比如cuda会调用CUDATargetBackend，CUDATargetBackend实际执行的是下面一序列passes。</p>
<ul>
<li><p>buildLLVMGPUTransformPassPipeline</p>
<ul>
<li><p>createTypePropagationPass</p>
<p>对integer的element type进行标准化，并传播修改过的type。</p></li>
<li><p>createBufferizeCopyOnlyDispatchesPass</p>
<p>将纯数据拷贝的dispatch（只有tensor load和store）转换成linalg generic
op，并bufferize化。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0</span>() &#123;</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %<span class="number">0</span> = hal.interface.constant.load[<span class="number">0</span>] : i32</span><br><span class="line">  %<span class="number">1</span> = arith.index_castui %<span class="number">0</span> : i32 to index</span><br><span class="line">  %<span class="number">2</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">0</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : !flow.dispatch.tensor&lt;readonly:tensor&lt;?xf32&gt;&gt;&#123;%<span class="number">1</span>&#125;</span><br><span class="line">  %<span class="number">3</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">1</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : !flow.dispatch.tensor&lt;writeonly:tensor&lt;?xf32&gt;&gt;&#123;%<span class="number">1</span>&#125;</span><br><span class="line">  %<span class="number">4</span> = flow.dispatch.tensor.load %<span class="number">2</span>, offsets = [<span class="number">0</span>], sizes = [%<span class="number">1</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;?xf32&gt;&gt;&#123;%<span class="number">1</span>&#125; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">  flow.dispatch.tensor.store %<span class="number">4</span>, %<span class="number">3</span>, offsets = [<span class="number">0</span>], sizes = [%<span class="number">1</span>], strides = [<span class="number">1</span>] : tensor&lt;?xf32&gt; -&gt; !flow.dispatch.tensor&lt;writeonly:tensor&lt;?xf32&gt;&gt;&#123;%<span class="number">1</span>&#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0</span>() &#123;</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %<span class="number">0</span> = hal.interface.constant.load[<span class="number">0</span>] : i32</span><br><span class="line">  %<span class="number">1</span> = arith.index_castui %<span class="number">0</span> : i32 to index</span><br><span class="line">  %<span class="number">2</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">0</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;?xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;&#123;%1&#125;</span></span><br><span class="line">  memref.assume_alignment %<span class="number">2</span>, <span class="number">64</span> : memref&lt;?xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">  %<span class="number">3</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">1</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;?xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;&#123;%1&#125;</span></span><br><span class="line">  memref.assume_alignment %<span class="number">3</span>, <span class="number">64</span> : memref&lt;?xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">  linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;, <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">2</span> : memref&lt;?xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;) outs(%3 : memref<span class="string">&lt;?xf32, #hal.descriptor_type&lt;storage_buffer&gt;</span>&gt;) &#123;</span></span><br><span class="line">  ^<span class="built_in">bb0</span>(%in: f32, %out: f32):</span><br><span class="line">    linalg.yield %in : f32</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>createEraseHALDescriptorTypeFromMemRefPass</p>
<p>将memory space为hal descriptor type的value转换成memref。</p></li>
<li><p>createLLVMGPULowerExecutableTargetPass</p>
<ul>
<li><p>initGPULaunchConfig</p>
<p>根据具体的计算负载和类型，计算gpu launch的配置，包括分块策略、group
count、thread num以及后续lowering分发的流程等。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">hal.executable.variant <span class="keyword">public</span> @cuda_nvptx_fb, target = &lt;<span class="string">&quot;cuda&quot;</span>, <span class="string">&quot;cuda-nvptx-fb&quot;</span>, &#123;target_arch = <span class="string">&quot;sm_35&quot;</span>&#125;&gt; &#123;</span><br><span class="line">  hal.executable.<span class="keyword">export</span> <span class="keyword">public</span> @test_dispatch_0_generic_100000x100 <span class="built_in">ordinal</span>(<span class="number">0</span>) <span class="built_in">layout</span>(<span class="meta">#hal.pipeline.layout<span class="string">&lt;push_constants = 0, sets = [&lt;0, bindings = [&lt;0, storage_buffer, ReadOnly&gt;</span>, <span class="string">&lt;1, storage_buffer, ReadOnly&gt;</span>, <span class="string">&lt;2, storage_buffer&gt;</span>]&gt;]&gt;) &#123;</span></span><br><span class="line">  ^<span class="built_in">bb0</span>(%arg0: !hal.device, %arg1: index, %arg2: index):</span><br><span class="line">    %x, %y, %z = flow.dispatch.workgroup_count_from_dag_root %arg1, %arg2</span><br><span class="line">    hal.<span class="keyword">return</span> %x, %y, %z : index, index, index</span><br><span class="line">  &#125;</span><br><span class="line">  builtin.<span class="keyword">module</span> &#123;</span><br><span class="line">    func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">      ...</span><br><span class="line">      %<span class="number">6</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">3</span>, %<span class="number">4</span> : tensor&lt;<span class="number">100000</span>x100xf32&gt;, tensor&lt;<span class="number">100000</span>x100xf32&gt;) <span class="built_in">outs</span>(%<span class="number">5</span> : tensor&lt;<span class="number">100000</span>xf32&gt;) &#123;</span><br><span class="line">      ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">        %<span class="number">7</span> = arith.addf %in, %in_0 : f32</span><br><span class="line">        %<span class="number">8</span> = arith.addf %<span class="number">7</span>, %out : f32</span><br><span class="line">        linalg.yield %<span class="number">8</span> : f32</span><br><span class="line">      &#125; -&gt; tensor&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">hal.executable.variant <span class="keyword">public</span> @cuda_nvptx_fb, target = &lt;<span class="string">&quot;cuda&quot;</span>, <span class="string">&quot;cuda-nvptx-fb&quot;</span>, &#123;target_arch = <span class="string">&quot;sm_35&quot;</span>&#125;&gt; &#123;</span><br><span class="line">  hal.executable.<span class="keyword">export</span> <span class="keyword">public</span> @test_dispatch_0_generic_100000x100 <span class="built_in">ordinal</span>(<span class="number">0</span>) <span class="built_in">layout</span>(<span class="meta">#hal.pipeline.layout<span class="string">&lt;push_constants = 0, sets = [&lt;0, bindings = [&lt;0, storage_buffer, ReadOnly&gt;</span>, <span class="string">&lt;1, storage_buffer, ReadOnly&gt;</span>, <span class="string">&lt;2, storage_buffer&gt;</span>]&gt;]&gt;) attributes &#123;translation_info = #iree_codegen.translation_info<span class="string">&lt;LLVMGPUVectorize&gt;</span>, workgroup_size = [64 : index, 1 : index, 1 : index]&#125; &#123;</span></span><br><span class="line">  ^<span class="built_in">bb0</span>(%arg0: !hal.device, %arg1: index, %arg2: index):</span><br><span class="line">    %x, %y, %z = flow.dispatch.workgroup_count_from_dag_root %arg1, %arg2</span><br><span class="line">    hal.<span class="keyword">return</span> %x, %y, %z : index, index, index</span><br><span class="line">  &#125;</span><br><span class="line">  builtin.<span class="keyword">module</span> &#123;</span><br><span class="line">    func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">      ...</span><br><span class="line">      %<span class="number">6</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">3</span>, %<span class="number">4</span> : tensor&lt;<span class="number">100000</span>x100xf32&gt;, tensor&lt;<span class="number">100000</span>x100xf32&gt;) <span class="built_in">outs</span>(%<span class="number">5</span> : tensor&lt;<span class="number">100000</span>xf32&gt;) attrs =  &#123;lowering_config = #iree_codegen.lowering_config&lt;tile_sizes = [[<span class="number">256</span>, <span class="number">4</span>]]&gt;&#125; &#123;</span><br><span class="line">      ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">        %<span class="number">7</span> = arith.addf %in, %in_0 : f32</span><br><span class="line">        %<span class="number">8</span> = arith.addf %<span class="number">7</span>, %out : f32</span><br><span class="line">        linalg.yield %<span class="number">8</span> : f32</span><br><span class="line">      &#125; -&gt; tensor&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到export
func多了translation_info和workgroup_size两个属性，而source
func也多了一个lowering_config属性。translation_info表示后续lowering分发到LLVMGPUVectorize这个pipeline。workgroup_size可以认为是3维的gpu
block
dim，这里表示每个线程块有64个线程。lowering_config指明了每层循环的分块策略，这里表示一个线程块计算256个100xf32的数据，而且每个线程一次计算一个4xf32的向量。</p></li>
<li><p>DispatchLoweringPassPipeline</p>
<p>根据translation_info分发到下面的pipeline继续lowering。</p>
<ul>
<li><p>GPUSimpleDistributePassPipeline</p></li>
<li><p>GPUVectorizationPassPipeline</p>
<ul>
<li><p>getTileAndDistributeConfig</p>
<p>定位到dispatch的root节点（一般是最后一个linalg reduction
op，如果没有reduction op，则会选择最后一个linalg generic
op），从节点属性中取出lowering_config（tile size），将非parallel
loop对应的tile size置0，表示接下来只会对parallel
loop进行vectorize，并计算parallel loop的loop range。</p></li>
<li><p>LowerDispatchWorkgroupCountForDagRootOp</p>
<p>根据loop range和tile size计算workgroup count。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hal.executable.<span class="keyword">export</span> <span class="keyword">public</span> @<span class="function">test_dispatch_0_generic_100000x100 <span class="title">ordinal</span><span class="params">(<span class="number">0</span>)</span> <span class="title">layout</span><span class="params">(#hal.pipeline.layout&lt;push_constants = <span class="number">0</span>, sets = [&lt;<span class="number">0</span>, bindings = [&lt;<span class="number">0</span>, storage_buffer, ReadOnly&gt;, &lt;<span class="number">1</span>, storage_buffer, ReadOnly&gt;, &lt;<span class="number">2</span>, storage_buffer&gt;]&gt;]&gt;)</span> attributes </span>&#123;translation_info = #iree_codegen.translation_info&lt;LLVMGPUVectorize&gt;, workgroup_size = [<span class="number">64</span> : index, <span class="number">1</span> : index, <span class="number">1</span> : index]&#125; &#123;</span><br><span class="line">^<span class="built_in">bb0</span>(%arg0: !hal.device, %arg1: index, %arg2: index):</span><br><span class="line">  %x, %y, %z = flow.dispatch.workgroup_count_from_dag_root %arg1, %arg2</span><br><span class="line">  hal.<span class="keyword">return</span> %x, %y, %z : index, index, index</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hal.executable.<span class="keyword">export</span> <span class="keyword">public</span> @<span class="function">test_dispatch_0_generic_100000x100 <span class="title">ordinal</span><span class="params">(<span class="number">0</span>)</span> <span class="title">layout</span><span class="params">(#hal.pipeline.layout&lt;push_constants = <span class="number">0</span>, sets = [&lt;<span class="number">0</span>, bindings = [&lt;<span class="number">0</span>, storage_buffer, ReadOnly&gt;, &lt;<span class="number">1</span>, storage_buffer, ReadOnly&gt;, &lt;<span class="number">2</span>, storage_buffer&gt;]&gt;]&gt;)</span> attributes </span>&#123;translation_info = #iree_codegen.translation_info&lt;LLVMGPUVectorize&gt;, workgroup_size = [<span class="number">64</span> : index, <span class="number">1</span> : index, <span class="number">1</span> : index]&#125; &#123;</span><br><span class="line">^<span class="built_in">bb0</span>(%arg0: !hal.device, %arg1: index, %arg2: index):</span><br><span class="line">  %c391 = arith.constant <span class="number">391</span> : index</span><br><span class="line">  %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">  hal.<span class="keyword">return</span> %c391, %c1, %c1 : index, index, index</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到计算的group count为（391, 1, 1）。391 = UDIV(100000,
256)。</p></li>
<li><p>populateTileAndDistributeToWorkgroupsPatterns</p>
<p>对parallel loop进行分块，将source func转换成单个work
group的计算逻辑。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">  ...</span><br><span class="line">  %<span class="number">6</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">3</span>, %<span class="number">4</span> : tensor&lt;<span class="number">100000</span>x100xf32&gt;, tensor&lt;<span class="number">100000</span>x100xf32&gt;) <span class="built_in">outs</span>(%<span class="number">5</span> : tensor&lt;<span class="number">100000</span>xf32&gt;) attrs =  &#123;__internal_linalg_transform__ = <span class="string">&quot;__workgroup_tiling__&quot;</span>, lowering_config = #iree_codegen.lowering_config&lt;tile_sizes = [[<span class="number">256</span>, <span class="number">4</span>]]&gt;&#125; &#123;</span><br><span class="line">  ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">    %<span class="number">7</span> = arith.addf %in, %in_0 : f32</span><br><span class="line">    %<span class="number">8</span> = arith.addf %<span class="number">7</span>, %out : f32</span><br><span class="line">    linalg.yield %<span class="number">8</span> : f32</span><br><span class="line">  &#125; -&gt; tensor&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">  ...</span><br><span class="line">  %workgroup_id_x = hal.interface.workgroup.id[<span class="number">0</span>] : index</span><br><span class="line">  %workgroup_count_x = hal.interface.workgroup.count[<span class="number">0</span>] : index</span><br><span class="line">  %<span class="number">3</span> = affine.apply <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">256</span>)&gt;()[%workgroup_id_x]</span><br><span class="line">  %<span class="number">4</span> = affine.apply <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">256</span>)&gt;()[%workgroup_count_x]</span><br><span class="line">  scf.<span class="keyword">for</span> %arg0 = %<span class="number">3</span> to %c100000 step %<span class="number">4</span> &#123;</span><br><span class="line">    %<span class="number">5</span> = affine.min <span class="built_in">affine_map</span>&lt;(d0) -&gt; (<span class="number">256</span>, -d0 + <span class="number">100000</span>)&gt;(%arg0)</span><br><span class="line">    %<span class="number">6</span> = flow.dispatch.tensor.load %<span class="number">0</span>, offsets = [%arg0, <span class="number">0</span>], sizes = [%<span class="number">5</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;?x100xf32&gt;</span><br><span class="line">    %<span class="number">7</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [%arg0, <span class="number">0</span>], sizes = [%<span class="number">5</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;?x100xf32&gt;</span><br><span class="line">    %<span class="number">8</span> = flow.dispatch.tensor.load %<span class="number">2</span>, offsets = [%arg0], sizes = [%<span class="number">5</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">    %<span class="number">9</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">6</span>, %<span class="number">7</span> : tensor&lt;?x100xf32&gt;, tensor&lt;?x100xf32&gt;) <span class="built_in">outs</span>(%<span class="number">8</span> : tensor&lt;?xf32&gt;) attrs =  &#123;lowering_config = #iree_codegen.lowering_config&lt;tile_sizes = [[<span class="number">256</span>, <span class="number">4</span>]]&gt;&#125; &#123;</span><br><span class="line">    ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">      %<span class="number">10</span> = arith.addf %in, %in_0 : f32</span><br><span class="line">      %<span class="number">11</span> = arith.addf %<span class="number">10</span>, %out : f32</span><br><span class="line">      linalg.yield %<span class="number">11</span> : f32</span><br><span class="line">    &#125; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>createWorkgroupSpecializationPass</p>
<p>将分块之后的计算逻辑分成固定形状和剩余部分动态形状两部分计算逻辑。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">  ...</span><br><span class="line">  %workgroup_id_x = hal.interface.workgroup.id[<span class="number">0</span>] : index</span><br><span class="line">  %workgroup_count_x = hal.interface.workgroup.count[<span class="number">0</span>] : index</span><br><span class="line">  %<span class="number">3</span> = affine.apply <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">256</span>)&gt;()[%workgroup_id_x]</span><br><span class="line">  %<span class="number">4</span> = affine.apply <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">256</span>)&gt;()[%workgroup_count_x]</span><br><span class="line">  scf.<span class="keyword">for</span> %arg0 = %<span class="number">3</span> to %c100000 step %<span class="number">4</span> &#123;</span><br><span class="line">    %<span class="number">5</span> = affine.min <span class="built_in">affine_map</span>&lt;(d0) -&gt; (<span class="number">256</span>, -d0 + <span class="number">100000</span>)&gt;(%arg0)</span><br><span class="line">    %<span class="number">6</span> = flow.dispatch.tensor.load %<span class="number">0</span>, offsets = [%arg0, <span class="number">0</span>], sizes = [%<span class="number">5</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;?x100xf32&gt;</span><br><span class="line">    %<span class="number">7</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [%arg0, <span class="number">0</span>], sizes = [%<span class="number">5</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;?x100xf32&gt;</span><br><span class="line">    %<span class="number">8</span> = flow.dispatch.tensor.load %<span class="number">2</span>, offsets = [%arg0], sizes = [%<span class="number">5</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">    %<span class="number">9</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">6</span>, %<span class="number">7</span> : tensor&lt;?x100xf32&gt;, tensor&lt;?x100xf32&gt;) <span class="built_in">outs</span>(%<span class="number">8</span> : tensor&lt;?xf32&gt;) attrs =  &#123;lowering_config = #iree_codegen.lowering_config&lt;tile_sizes = [[<span class="number">256</span>, <span class="number">4</span>]]&gt;&#125; &#123;</span><br><span class="line">    ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">      %<span class="number">10</span> = arith.addf %in, %in_0 : f32</span><br><span class="line">      %<span class="number">11</span> = arith.addf %<span class="number">10</span>, %out : f32</span><br><span class="line">      linalg.yield %<span class="number">11</span> : f32</span><br><span class="line">    &#125; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">  ...</span><br><span class="line">  %workgroup_id_x = hal.interface.workgroup.id[<span class="number">0</span>] : index</span><br><span class="line">  %workgroup_count_x = hal.interface.workgroup.count[<span class="number">0</span>] : index</span><br><span class="line">  %<span class="number">3</span> = affine.apply <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">256</span>)&gt;()[%workgroup_id_x]</span><br><span class="line">  %<span class="number">4</span> = affine.apply <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">256</span>)&gt;()[%workgroup_count_x]</span><br><span class="line">  scf.<span class="keyword">for</span> %arg0 = %<span class="number">3</span> to %c100000 step %<span class="number">4</span> &#123;</span><br><span class="line">    %<span class="number">5</span> = affine.min <span class="built_in">affine_map</span>&lt;(d0) -&gt; (-d0 + <span class="number">100000</span>, <span class="number">256</span>)&gt;(%arg0)</span><br><span class="line">    %c256 = arith.constant <span class="number">256</span> : index</span><br><span class="line">    %<span class="number">6</span> = arith.cmpi eq, %<span class="number">5</span>, %c256 : index</span><br><span class="line">    scf.<span class="keyword">if</span> %<span class="number">6</span> &#123;</span><br><span class="line">      <span class="comment">// 计算[256，100]静态形状的分块</span></span><br><span class="line">      %<span class="number">7</span> = flow.dispatch.tensor.load %<span class="number">0</span>, offsets = [%arg0, <span class="number">0</span>], sizes = [%c256, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;?x100xf32&gt;</span><br><span class="line">      %<span class="number">8</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [%arg0, <span class="number">0</span>], sizes = [%c256, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;?x100xf32&gt;</span><br><span class="line">      %<span class="number">9</span> = flow.dispatch.tensor.load %<span class="number">2</span>, offsets = [%arg0], sizes = [%c256], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">      %<span class="number">10</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">7</span>, %<span class="number">8</span> : tensor&lt;?x100xf32&gt;, tensor&lt;?x100xf32&gt;) <span class="built_in">outs</span>(%<span class="number">9</span> : tensor&lt;?xf32&gt;) attrs =  &#123;lowering_config = #iree_codegen.lowering_config&lt;tile_sizes = [[<span class="number">256</span>, <span class="number">4</span>]]&gt;&#125; &#123;</span><br><span class="line">      ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">        %<span class="number">11</span> = arith.addf %in, %in_0 : f32</span><br><span class="line">        %<span class="number">12</span> = arith.addf %<span class="number">11</span>, %out : f32</span><br><span class="line">        linalg.yield %<span class="number">12</span> : f32</span><br><span class="line">      &#125; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">      flow.dispatch.tensor.store %<span class="number">10</span>, %<span class="number">2</span>, offsets = [%arg0], sizes = [%c256], strides = [<span class="number">1</span>] : tensor&lt;?xf32&gt; -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 计算剩下的[%5, 100]动态形状的分块</span></span><br><span class="line">      %<span class="number">7</span> = flow.dispatch.tensor.load %<span class="number">0</span>, offsets = [%arg0, <span class="number">0</span>], sizes = [%<span class="number">5</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;?x100xf32&gt;</span><br><span class="line">      %<span class="number">8</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [%arg0, <span class="number">0</span>], sizes = [%<span class="number">5</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;?x100xf32&gt;</span><br><span class="line">      %<span class="number">9</span> = flow.dispatch.tensor.load %<span class="number">2</span>, offsets = [%arg0], sizes = [%<span class="number">5</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">      %<span class="number">10</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">7</span>, %<span class="number">8</span> : tensor&lt;?x100xf32&gt;, tensor&lt;?x100xf32&gt;) <span class="built_in">outs</span>(%<span class="number">9</span> : tensor&lt;?xf32&gt;) attrs =  &#123;lowering_config = #iree_codegen.lowering_config&lt;tile_sizes = [[<span class="number">256</span>, <span class="number">4</span>]]&gt;&#125; &#123;</span><br><span class="line">      ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">        %<span class="number">11</span> = arith.addf %in, %in_0 : f32</span><br><span class="line">        %<span class="number">12</span> = arith.addf %<span class="number">11</span>, %out : f32</span><br><span class="line">        linalg.yield %<span class="number">12</span> : f32</span><br><span class="line">      &#125; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">      flow.dispatch.tensor.store %<span class="number">10</span>, %<span class="number">2</span>, offsets = [%arg0], sizes = [%<span class="number">5</span>], strides = [<span class="number">1</span>] : tensor&lt;?xf32&gt; -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>createRemoveSingleIterationLoopPass</p>
<p>移除确信只会循环1次的loop。比如上面的<code>scf.for %arg0 = %3 to %c100000 step %4</code>就只会被循环一次，因为step
= 256 * 391 = 100096 &gt;
100000，因此这个循环会被消除，转换成如下代码。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">  ...</span><br><span class="line">  %c256 = arith.constant <span class="number">256</span> : index</span><br><span class="line">  %workgroup_id_x = hal.interface.workgroup.id[<span class="number">0</span>] : index</span><br><span class="line">  %<span class="number">3</span> = affine.apply <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">256</span>)&gt;()[%workgroup_id_x]</span><br><span class="line">  %<span class="number">4</span> = affine.min <span class="built_in">affine_map</span>&lt;(d0) -&gt; (-d0 + <span class="number">100000</span>, <span class="number">256</span>)&gt;(%<span class="number">3</span>)</span><br><span class="line">  %<span class="number">5</span> = arith.cmpi eq, %<span class="number">4</span>, %c256 : index</span><br><span class="line">  scf.<span class="keyword">if</span> %<span class="number">5</span> &#123;</span><br><span class="line">    %<span class="number">6</span> = flow.dispatch.tensor.load %<span class="number">0</span>, offsets = [%<span class="number">3</span>, <span class="number">0</span>], sizes = [<span class="number">256</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;<span class="number">256</span>x100xf32&gt;</span><br><span class="line">    %<span class="number">7</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [%<span class="number">3</span>, <span class="number">0</span>], sizes = [<span class="number">256</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;<span class="number">256</span>x100xf32&gt;</span><br><span class="line">    %<span class="number">8</span> = flow.dispatch.tensor.load %<span class="number">2</span>, offsets = [%<span class="number">3</span>], sizes = [<span class="number">256</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt; -&gt; tensor&lt;<span class="number">256</span>xf32&gt;</span><br><span class="line">    %<span class="number">9</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">6</span>, %<span class="number">7</span> : tensor&lt;<span class="number">256</span>x100xf32&gt;, tensor&lt;<span class="number">256</span>x100xf32&gt;) <span class="built_in">outs</span>(%<span class="number">8</span> : tensor&lt;<span class="number">256</span>xf32&gt;) attrs =  &#123;lowering_config = #iree_codegen.lowering_config&lt;tile_sizes = [[<span class="number">256</span>, <span class="number">4</span>]]&gt;&#125; &#123;</span><br><span class="line">    ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">      %<span class="number">10</span> = arith.addf %in, %in_0 : f32</span><br><span class="line">      %<span class="number">11</span> = arith.addf %<span class="number">10</span>, %out : f32</span><br><span class="line">      linalg.yield %<span class="number">11</span> : f32</span><br><span class="line">    &#125; -&gt; tensor&lt;<span class="number">256</span>xf32&gt;</span><br><span class="line">    flow.dispatch.tensor.store %<span class="number">9</span>, %<span class="number">2</span>, offsets = [%<span class="number">3</span>], sizes = [<span class="number">256</span>], strides = [<span class="number">1</span>] : tensor&lt;<span class="number">256</span>xf32&gt; -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    %<span class="number">6</span> = flow.dispatch.tensor.load %<span class="number">0</span>, offsets = [%<span class="number">3</span>, <span class="number">0</span>], sizes = [%<span class="number">4</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;?x100xf32&gt;</span><br><span class="line">    %<span class="number">7</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [%<span class="number">3</span>, <span class="number">0</span>], sizes = [%<span class="number">4</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;?x100xf32&gt;</span><br><span class="line">    %<span class="number">8</span> = flow.dispatch.tensor.load %<span class="number">2</span>, offsets = [%<span class="number">3</span>], sizes = [%<span class="number">4</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">    %<span class="number">9</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%<span class="number">6</span>, %<span class="number">7</span> : tensor&lt;?x100xf32&gt;, tensor&lt;?x100xf32&gt;) <span class="built_in">outs</span>(%<span class="number">8</span> : tensor&lt;?xf32&gt;) attrs =  &#123;lowering_config = #iree_codegen.lowering_config&lt;tile_sizes = [[<span class="number">256</span>, <span class="number">4</span>]]&gt;&#125; &#123;</span><br><span class="line">    ^<span class="built_in">bb0</span>(%in: f32, %in_0: f32, %out: f32):</span><br><span class="line">      %<span class="number">10</span> = arith.addf %in, %in_0 : f32</span><br><span class="line">      %<span class="number">11</span> = arith.addf %<span class="number">10</span>, %out : f32</span><br><span class="line">      linalg.yield %<span class="number">11</span> : f32</span><br><span class="line">    &#125; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">    flow.dispatch.tensor.store %<span class="number">9</span>, %<span class="number">2</span>, offsets = [%<span class="number">3</span>], sizes = [%<span class="number">4</span>], strides = [<span class="number">1</span>] : tensor&lt;?xf32&gt; -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>createLLVMGPUTileTensor</p>
<p>前面pass主要针对的是外层parallel
loop的vectorize，生成的是一个线程块的计算逻辑，接下来继续将负载分布到每一个线程，并且对内层的reduction也做vectorize。上面的代码继续转换成如下代码，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">  %c100 = arith.constant <span class="number">100</span> : index</span><br><span class="line">  %c4 = arith.constant <span class="number">4</span> : index</span><br><span class="line">  %c64 = arith.constant <span class="number">64</span> : index</span><br><span class="line">  %c256 = arith.constant <span class="number">256</span> : index</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  ...</span><br><span class="line">  %workgroup_id_x = hal.interface.workgroup.id[<span class="number">0</span>] : index</span><br><span class="line">  %<span class="number">3</span> = affine.apply <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">256</span>)&gt;()[%workgroup_id_x]</span><br><span class="line">  %<span class="number">4</span> = affine.min <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">-256</span> + <span class="number">100000</span>, <span class="number">256</span>)&gt;()[%workgroup_id_x]</span><br><span class="line">  %<span class="number">5</span> = arith.cmpi eq, %<span class="number">4</span>, %c256 : index</span><br><span class="line">  scf.<span class="keyword">if</span> %<span class="number">5</span> &#123;</span><br><span class="line">    %<span class="number">6</span> = flow.dispatch.tensor.load %<span class="number">0</span>, offsets = [%<span class="number">3</span>, <span class="number">0</span>], sizes = [<span class="number">256</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;<span class="number">256</span>x100xf32&gt;</span><br><span class="line">    %<span class="number">7</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [%<span class="number">3</span>, <span class="number">0</span>], sizes = [<span class="number">256</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;<span class="number">256</span>x100xf32&gt;</span><br><span class="line">    %<span class="number">8</span> = flow.dispatch.tensor.load %<span class="number">2</span>, offsets = [%<span class="number">3</span>], sizes = [<span class="number">256</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt; -&gt; tensor&lt;<span class="number">256</span>xf32&gt;</span><br><span class="line">    <span class="comment">// 64个线程并发计算，每个线程计算[4, 100]的分块</span></span><br><span class="line">    %<span class="number">9</span> = scf.foreach_thread (%arg0) <span class="built_in">in</span> (%c64) <span class="built_in">shared_outs</span>(%arg1 = %<span class="number">8</span>) -&gt; (tensor&lt;<span class="number">256</span>xf32&gt;) &#123;</span><br><span class="line">      %<span class="number">10</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0 * <span class="number">4</span>)&gt;(%arg0)</span><br><span class="line">      %<span class="number">11</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0 * <span class="number">4</span>)&gt;(%arg0)</span><br><span class="line">      %<span class="number">12</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0 * <span class="number">4</span>)&gt;(%arg0)</span><br><span class="line">      %extracted_slice = tensor.extract_slice %<span class="number">6</span>[%<span class="number">10</span>, <span class="number">0</span>] [<span class="number">4</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;<span class="number">256</span>x100xf32&gt; to tensor&lt;<span class="number">4</span>x100xf32&gt;</span><br><span class="line">      %extracted_slice_0 = tensor.extract_slice %<span class="number">7</span>[%<span class="number">11</span>, <span class="number">0</span>] [<span class="number">4</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;<span class="number">256</span>x100xf32&gt; to tensor&lt;<span class="number">4</span>x100xf32&gt;</span><br><span class="line">      %extracted_slice_1 = tensor.extract_slice %arg1[%<span class="number">12</span>] [<span class="number">4</span>] [<span class="number">1</span>] : tensor&lt;<span class="number">256</span>xf32&gt; to tensor&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      <span class="comment">// 内层reduction loop的vectorize</span></span><br><span class="line">      %<span class="number">13</span> = scf.<span class="keyword">for</span> %arg2 = %c0 to %c100 step %c4 <span class="built_in">iter_args</span>(%arg3 = %extracted_slice_1) -&gt; (tensor&lt;<span class="number">4</span>xf32&gt;) &#123;</span><br><span class="line">        %extracted_slice_2 = tensor.extract_slice %extracted_slice[<span class="number">0</span>, %arg2] [<span class="number">4</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;<span class="number">4</span>x100xf32&gt; to tensor&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">        %extracted_slice_3 = tensor.extract_slice %extracted_slice_0[<span class="number">0</span>, %arg2] [<span class="number">4</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;<span class="number">4</span>x100xf32&gt; to tensor&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">        %<span class="number">15</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%extracted_slice_2, %extracted_slice_3 : tensor&lt;<span class="number">4</span>x4xf32&gt;, tensor&lt;<span class="number">4</span>x4xf32&gt;) <span class="built_in">outs</span>(%arg3 : tensor&lt;<span class="number">4</span>xf32&gt;) attrs =  &#123;__internal_linalg_transform__ = <span class="string">&quot;workgroup_k_tiled&quot;</span>, lowering_config = #iree_codegen.lowering_config&lt;tile_sizes = [[<span class="number">256</span>, <span class="number">4</span>]]&gt;&#125; &#123;</span><br><span class="line">        ^<span class="built_in">bb0</span>(%in: f32, %in_4: f32, %out: f32):</span><br><span class="line">          %<span class="number">16</span> = arith.addf %in, %in_4 : f32</span><br><span class="line">          %<span class="number">17</span> = arith.addf %<span class="number">16</span>, %out : f32</span><br><span class="line">          linalg.yield %<span class="number">17</span> : f32</span><br><span class="line">        &#125; -&gt; tensor&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">        scf.yield %<span class="number">15</span> : tensor&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      &#125;</span><br><span class="line">      %<span class="number">14</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0 * <span class="number">4</span>)&gt;(%arg0)</span><br><span class="line">      scf.foreach_thread.perform_concurrently &#123;</span><br><span class="line">        tensor.parallel_insert_slice %<span class="number">13</span> into %arg1[%<span class="number">14</span>] [<span class="number">4</span>] [<span class="number">1</span>] : tensor&lt;<span class="number">4</span>xf32&gt; into tensor&lt;<span class="number">256</span>xf32&gt;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; &#123;mapping = [<span class="meta">#gpu.thread<span class="string">&lt;x&gt;</span>]&#125;</span></span><br><span class="line">    flow.dispatch.tensor.store %<span class="number">9</span>, %<span class="number">2</span>, offsets = [%<span class="number">3</span>], sizes = [<span class="number">256</span>], strides = [<span class="number">1</span>] : tensor&lt;<span class="number">256</span>xf32&gt; -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    %<span class="number">6</span> = flow.dispatch.tensor.load %<span class="number">0</span>, offsets = [%<span class="number">3</span>, <span class="number">0</span>], sizes = [%<span class="number">4</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;?x100xf32&gt;</span><br><span class="line">    %<span class="number">7</span> = flow.dispatch.tensor.load %<span class="number">1</span>, offsets = [%<span class="number">3</span>, <span class="number">0</span>], sizes = [%<span class="number">4</span>, <span class="number">100</span>], strides = [<span class="number">1</span>, <span class="number">1</span>] : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt; -&gt; tensor&lt;?x100xf32&gt;</span><br><span class="line">    %<span class="number">8</span> = flow.dispatch.tensor.load %<span class="number">2</span>, offsets = [%<span class="number">3</span>], sizes = [%<span class="number">4</span>], strides = [<span class="number">1</span>] : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">    %dim = tensor.dim %<span class="number">6</span>, %c0 : tensor&lt;?x100xf32&gt;</span><br><span class="line">    <span class="comment">// 64个线程并发计算，每个线程计算[%11, 100]的分块</span></span><br><span class="line">    %<span class="number">9</span> = scf.foreach_thread (%arg0) <span class="built_in">in</span> (%c64) <span class="built_in">shared_outs</span>(%arg1 = %<span class="number">8</span>) -&gt; (tensor&lt;?xf32&gt;) &#123;</span><br><span class="line">      %<span class="number">10</span> = affine.min <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (-(d0 * (s0 ceildiv <span class="number">64</span>)) + s0, s0 ceildiv <span class="number">64</span>)&gt;(%arg0)[%dim]</span><br><span class="line">      %<span class="number">11</span> = affine.max <span class="built_in">affine_map</span>&lt;(d0) -&gt; (<span class="number">0</span>, d0)&gt;(%<span class="number">10</span>)</span><br><span class="line">      %<span class="number">12</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (d0 * (s0 ceildiv <span class="number">64</span>))&gt;(%arg0)[%dim]</span><br><span class="line">      %<span class="number">13</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (d0 * (s0 ceildiv <span class="number">64</span>))&gt;(%arg0)[%dim]</span><br><span class="line">      %<span class="number">14</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (d0 * (s0 ceildiv <span class="number">64</span>))&gt;(%arg0)[%dim]</span><br><span class="line">      %extracted_slice = tensor.extract_slice %<span class="number">6</span>[%<span class="number">12</span>, <span class="number">0</span>] [%<span class="number">11</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;?x100xf32&gt; to tensor&lt;?x100xf32&gt;</span><br><span class="line">      %extracted_slice_0 = tensor.extract_slice %<span class="number">7</span>[%<span class="number">13</span>, <span class="number">0</span>] [%<span class="number">11</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;?x100xf32&gt; to tensor&lt;?x100xf32&gt;</span><br><span class="line">      %extracted_slice_1 = tensor.extract_slice %arg1[%<span class="number">14</span>] [%<span class="number">11</span>] [<span class="number">1</span>] : tensor&lt;?xf32&gt; to tensor&lt;?xf32&gt;</span><br><span class="line">      <span class="comment">// 内层reduction loop的vectorize</span></span><br><span class="line">      %<span class="number">15</span> = scf.<span class="keyword">for</span> %arg2 = %c0 to %c100 step %c4 <span class="built_in">iter_args</span>(%arg3 = %extracted_slice_1) -&gt; (tensor&lt;?xf32&gt;) &#123;</span><br><span class="line">        %extracted_slice_2 = tensor.extract_slice %extracted_slice[<span class="number">0</span>, %arg2] [%<span class="number">11</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;?x100xf32&gt; to tensor&lt;?x4xf32&gt;</span><br><span class="line">        %extracted_slice_3 = tensor.extract_slice %extracted_slice_0[<span class="number">0</span>, %arg2] [%<span class="number">11</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;?x100xf32&gt; to tensor&lt;?x4xf32&gt;</span><br><span class="line">        %extracted_slice_4 = tensor.extract_slice %arg3[<span class="number">0</span>] [%<span class="number">11</span>] [<span class="number">1</span>] : tensor&lt;?xf32&gt; to tensor&lt;?xf32&gt;</span><br><span class="line">        %<span class="number">17</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%extracted_slice_2, %extracted_slice_3 : tensor&lt;?x4xf32&gt;, tensor&lt;?x4xf32&gt;) <span class="built_in">outs</span>(%extracted_slice_4 : tensor&lt;?xf32&gt;) attrs =  &#123;__internal_linalg_transform__ = <span class="string">&quot;workgroup_k_tiled&quot;</span>, lowering_config = #iree_codegen.lowering_config&lt;tile_sizes = [[<span class="number">256</span>, <span class="number">4</span>]]&gt;&#125; &#123;</span><br><span class="line">        ^<span class="built_in">bb0</span>(%in: f32, %in_5: f32, %out: f32):</span><br><span class="line">          %<span class="number">18</span> = arith.addf %in, %in_5 : f32</span><br><span class="line">          %<span class="number">19</span> = arith.addf %<span class="number">18</span>, %out : f32</span><br><span class="line">          linalg.yield %<span class="number">19</span> : f32</span><br><span class="line">        &#125; -&gt; tensor&lt;?xf32&gt;</span><br><span class="line">        %inserted_slice = tensor.insert_slice %<span class="number">17</span> into %arg3[<span class="number">0</span>] [%<span class="number">11</span>] [<span class="number">1</span>] : tensor&lt;?xf32&gt; into tensor&lt;?xf32&gt;</span><br><span class="line">        scf.yield %inserted_slice : tensor&lt;?xf32&gt;</span><br><span class="line">      &#125;</span><br><span class="line">      %<span class="number">16</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (d0 * (s0 ceildiv <span class="number">64</span>))&gt;(%arg0)[%dim]</span><br><span class="line">      scf.foreach_thread.perform_concurrently &#123;</span><br><span class="line">        tensor.parallel_insert_slice %<span class="number">15</span> into %arg1[%<span class="number">16</span>] [%<span class="number">11</span>] [<span class="number">1</span>] : tensor&lt;?xf32&gt; into tensor&lt;?xf32&gt;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; &#123;mapping = [<span class="meta">#gpu.thread<span class="string">&lt;x&gt;</span>]&#125;</span></span><br><span class="line">    flow.dispatch.tensor.store %<span class="number">9</span>, %<span class="number">2</span>, offsets = [%<span class="number">3</span>], sizes = [%<span class="number">4</span>], strides = [<span class="number">1</span>] : tensor&lt;?xf32&gt; -&gt; !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>createRemoveSingleIterationLoopPass</p></li>
<li><p>createGPUVectorizationPass</p>
<p>将内层可被向量化的linalg op转换成vector op。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">11</span> = scf.<span class="keyword">for</span> %arg2 = %c0 to %c100 step %c4 <span class="built_in">iter_args</span>(%arg3 = %extracted_slice_1) -&gt; (tensor&lt;<span class="number">4</span>xf32&gt;) &#123;</span><br><span class="line">  %extracted_slice_2 = tensor.extract_slice %extracted_slice[<span class="number">0</span>, %arg2] [<span class="number">4</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;<span class="number">4</span>x100xf32&gt; to tensor&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">  %extracted_slice_3 = tensor.extract_slice %extracted_slice_0[<span class="number">0</span>, %arg2] [<span class="number">4</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;<span class="number">4</span>x100xf32&gt; to tensor&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">  %<span class="number">12</span> = linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%extracted_slice_2, %extracted_slice_3 : tensor&lt;<span class="number">4</span>x4xf32&gt;, tensor&lt;<span class="number">4</span>x4xf32&gt;) <span class="built_in">outs</span>(%arg3 : tensor&lt;<span class="number">4</span>xf32&gt;) attrs =  &#123;__internal_linalg_transform__ = <span class="string">&quot;workgroup_k_tiled&quot;</span>, lowering_config = #iree_codegen.lowering_config&lt;tile_sizes = [[<span class="number">256</span>, <span class="number">4</span>]]&gt;&#125; &#123;</span><br><span class="line">  ^<span class="built_in">bb0</span>(%in: f32, %in_4: f32, %out: f32):</span><br><span class="line">    %<span class="number">13</span> = arith.addf %in, %in_4 : f32</span><br><span class="line">    %<span class="number">14</span> = arith.addf %<span class="number">13</span>, %out : f32</span><br><span class="line">    linalg.yield %<span class="number">14</span> : f32</span><br><span class="line">  &#125; -&gt; tensor&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">  scf.yield %<span class="number">12</span> : tensor&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转换成</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">11</span> = vector.transfer_read %extracted_slice_1[%c0], %cst &#123;in_bounds = [<span class="literal">true</span>]&#125; : tensor&lt;<span class="number">4</span>xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">%<span class="number">12</span> = scf.<span class="keyword">for</span> %arg2 = %c0 to %c100 step %c4 <span class="built_in">iter_args</span>(%arg3 = %<span class="number">11</span>) -&gt; (vector&lt;<span class="number">4</span>xf32&gt;) &#123;</span><br><span class="line">  %extracted_slice_2 = tensor.extract_slice %extracted_slice[<span class="number">0</span>, %arg2] [<span class="number">4</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;<span class="number">4</span>x100xf32&gt; to tensor&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">  %extracted_slice_3 = tensor.extract_slice %extracted_slice_0[<span class="number">0</span>, %arg2] [<span class="number">4</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : tensor&lt;<span class="number">4</span>x100xf32&gt; to tensor&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">  %<span class="number">14</span> = vector.transfer_read %extracted_slice_2[%c0, %c0], %cst &#123;in_bounds = [<span class="literal">true</span>, <span class="literal">true</span>]&#125; : tensor&lt;<span class="number">4</span>x4xf32&gt;, vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">  %<span class="number">15</span> = vector.transfer_read %extracted_slice_3[%c0, %c0], %cst &#123;in_bounds = [<span class="literal">true</span>, <span class="literal">true</span>]&#125; : tensor&lt;<span class="number">4</span>x4xf32&gt;, vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">  %<span class="number">16</span> = arith.addf %<span class="number">14</span>, %<span class="number">15</span> : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">  %<span class="number">17</span> = vector.multi_reduction &lt;add&gt;, %<span class="number">16</span>, %arg3 [<span class="number">1</span>] : vector&lt;<span class="number">4</span>x4xf32&gt; to vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">  scf.yield %<span class="number">17</span> : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">&#125;</span><br><span class="line">%<span class="number">13</span> = vector.transfer_write %<span class="number">12</span>, %extracted_slice_1[%c0] &#123;in_bounds = [<span class="literal">true</span>]&#125; : vector&lt;<span class="number">4</span>xf32&gt;, tensor&lt;<span class="number">4</span>xf32&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>addBufferizePasses</p>
<p>将tensor语义转换成memref语义。上面完整的source
func代码会转换成如下代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">  %cst = arith.constant <span class="number">0.000000e+00</span> : f32</span><br><span class="line">  %c100 = arith.constant <span class="number">100</span> : index</span><br><span class="line">  %c4 = arith.constant <span class="number">4</span> : index</span><br><span class="line">  %c64 = arith.constant <span class="number">64</span> : index</span><br><span class="line">  %c256 = arith.constant <span class="number">256</span> : index</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %<span class="number">0</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">0</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>x100xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">  memref.assume_alignment %<span class="number">0</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>x100xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">  %<span class="number">1</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">0</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt;</span><br><span class="line">  %<span class="number">2</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">1</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>x100xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">  memref.assume_alignment %<span class="number">2</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>x100xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">  %<span class="number">3</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">1</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : !flow.dispatch.tensor&lt;readonly:tensor&lt;<span class="number">100000</span>x100xf32&gt;&gt;</span><br><span class="line">  %<span class="number">4</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">2</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">  memref.assume_alignment %<span class="number">4</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">  %<span class="number">5</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">2</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : !flow.dispatch.tensor&lt;readwrite:tensor&lt;<span class="number">100000</span>xf32&gt;&gt;</span><br><span class="line">  %workgroup_id_x = hal.interface.workgroup.id[<span class="number">0</span>] : index</span><br><span class="line">  %<span class="number">6</span> = affine.apply <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">256</span>)&gt;()[%workgroup_id_x]</span><br><span class="line">  %<span class="number">7</span> = affine.min <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">-256</span> + <span class="number">100000</span>, <span class="number">256</span>)&gt;()[%workgroup_id_x]</span><br><span class="line">  %<span class="number">8</span> = arith.cmpi eq, %<span class="number">7</span>, %c256 : index</span><br><span class="line">  scf.<span class="keyword">if</span> %<span class="number">8</span> &#123;</span><br><span class="line">    %subview = memref.subview %<span class="number">0</span>[%<span class="number">6</span>, <span class="number">0</span>] [<span class="number">256</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;<span class="number">100000</span>x100xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt; to memref<span class="string">&lt;256x100xf32, strided&lt;[100, 1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">    %subview_0 = memref.subview %<span class="number">2</span>[%<span class="number">6</span>, <span class="number">0</span>] [<span class="number">256</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;<span class="number">100000</span>x100xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt; to memref<span class="string">&lt;256x100xf32, strided&lt;[100, 1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">    %subview_1 = memref.subview %<span class="number">4</span>[%<span class="number">6</span>] [<span class="number">256</span>] [<span class="number">1</span>] : memref&lt;<span class="number">100000</span>xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt; to memref<span class="string">&lt;256xf32, strided&lt;[1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">    scf.foreach_thread (%arg0) <span class="built_in">in</span> (%c64) &#123;</span><br><span class="line">      %<span class="number">9</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0 * <span class="number">4</span>)&gt;(%arg0)</span><br><span class="line">      %subview_2 = memref.subview %subview_1[%<span class="number">9</span>] [<span class="number">4</span>] [<span class="number">1</span>] : memref&lt;<span class="number">256</span>xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt; to memref<span class="string">&lt;4xf32, strided&lt;[1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">      %<span class="number">10</span> = vector.transfer_read %subview_1[%<span class="number">9</span>], %cst &#123;in_bounds = [<span class="literal">true</span>]&#125; : memref&lt;<span class="number">256</span>xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;, vector<span class="string">&lt;4xf32&gt;</span></span></span><br><span class="line">      %<span class="number">11</span> = scf.<span class="keyword">for</span> %arg1 = %c0 to %c100 step %c4 <span class="built_in">iter_args</span>(%arg2 = %<span class="number">10</span>) -&gt; (vector&lt;<span class="number">4</span>xf32&gt;) &#123;</span><br><span class="line">        %<span class="number">12</span> = vector.transfer_read %subview[%<span class="number">9</span>, %arg1], %cst &#123;in_bounds = [<span class="literal">true</span>, <span class="literal">true</span>]&#125; : memref&lt;<span class="number">256</span>x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;, vector<span class="string">&lt;4x4xf32&gt;</span></span></span><br><span class="line">        %<span class="number">13</span> = vector.transfer_read %subview_0[%<span class="number">9</span>, %arg1], %cst &#123;in_bounds = [<span class="literal">true</span>, <span class="literal">true</span>]&#125; : memref&lt;<span class="number">256</span>x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;, vector<span class="string">&lt;4x4xf32&gt;</span></span></span><br><span class="line">        %<span class="number">14</span> = arith.addf %<span class="number">12</span>, %<span class="number">13</span> : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">        %<span class="number">15</span> = vector.multi_reduction &lt;add&gt;, %<span class="number">14</span>, %arg2 [<span class="number">1</span>] : vector&lt;<span class="number">4</span>x4xf32&gt; to vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">        scf.yield %<span class="number">15</span> : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      &#125;</span><br><span class="line">      vector.transfer_write %<span class="number">11</span>, %subview_2[%c0] &#123;in_bounds = [<span class="literal">true</span>]&#125; : vector&lt;<span class="number">4</span>xf32&gt;, memref&lt;<span class="number">4</span>xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">    &#125; &#123;mapping = [<span class="meta">#gpu.thread<span class="string">&lt;x&gt;</span>]&#125;</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    %subview = memref.subview %<span class="number">0</span>[%<span class="number">6</span>, <span class="number">0</span>] [%<span class="number">7</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;<span class="number">100000</span>x100xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt; to memref<span class="string">&lt;?x100xf32, strided&lt;[100, 1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">    %subview_0 = memref.subview %<span class="number">2</span>[%<span class="number">6</span>, <span class="number">0</span>] [%<span class="number">7</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;<span class="number">100000</span>x100xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt; to memref<span class="string">&lt;?x100xf32, strided&lt;[100, 1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">    %subview_1 = memref.subview %<span class="number">4</span>[%<span class="number">6</span>] [%<span class="number">7</span>] [<span class="number">1</span>] : memref&lt;<span class="number">100000</span>xf32, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt; to memref<span class="string">&lt;?xf32, strided&lt;[1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">    scf.foreach_thread (%arg0) <span class="built_in">in</span> (%c64) &#123;</span><br><span class="line">      %<span class="number">9</span> = affine.min <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (-(d0 * (s0 ceildiv <span class="number">64</span>)) + s0, s0 ceildiv <span class="number">64</span>)&gt;(%arg0)[%<span class="number">7</span>]</span><br><span class="line">      %<span class="number">10</span> = affine.max <span class="built_in">affine_map</span>&lt;(d0) -&gt; (<span class="number">0</span>, d0)&gt;(%<span class="number">9</span>)</span><br><span class="line">      %<span class="number">11</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (d0 * (s0 ceildiv <span class="number">64</span>))&gt;(%arg0)[%<span class="number">7</span>]</span><br><span class="line">      %subview_2 = memref.subview %subview[%<span class="number">11</span>, <span class="number">0</span>] [%<span class="number">10</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;?x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt; to memref<span class="string">&lt;?x100xf32, strided&lt;[100, 1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">      %subview_3 = memref.subview %subview_0[%<span class="number">11</span>, <span class="number">0</span>] [%<span class="number">10</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;?x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt; to memref<span class="string">&lt;?x100xf32, strided&lt;[100, 1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">      %subview_4 = memref.subview %subview_1[%<span class="number">11</span>] [%<span class="number">10</span>] [<span class="number">1</span>] : memref&lt;?xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt; to memref<span class="string">&lt;?xf32, strided&lt;[1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">      scf.<span class="keyword">for</span> %arg1 = %c0 to %c100 step %c4 &#123;</span><br><span class="line">        %subview_5 = memref.subview %subview_2[<span class="number">0</span>, %arg1] [%<span class="number">10</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;?x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt; to memref<span class="string">&lt;?x4xf32, strided&lt;[100, 1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">        %subview_6 = memref.subview %subview_3[<span class="number">0</span>, %arg1] [%<span class="number">10</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;?x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt; to memref<span class="string">&lt;?x4xf32, strided&lt;[100, 1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;</span></span><br><span class="line">        linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%subview_5, %subview_6 : memref&lt;?x4xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;, <span class="meta">#hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;, memref<span class="string">&lt;?x4xf32, strided&lt;[100, 1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;) outs(%subview_4 : memref<span class="string">&lt;?xf32, strided&lt;[1], offset: ?&gt;</span>, #hal.descriptor_type<span class="string">&lt;storage_buffer&gt;</span>&gt;) attrs =  &#123;__internal_linalg_transform__ = <span class="string">&quot;workgroup_k_tiled&quot;</span>, lowering_config = #iree_codegen.lowering_config<span class="string">&lt;tile_sizes = [[256, 4]]&gt;</span>&#125; &#123;</span></span><br><span class="line">        ^<span class="built_in">bb0</span>(%in: f32, %in_7: f32, %out: f32):</span><br><span class="line">          %<span class="number">12</span> = arith.addf %in, %in_7 : f32</span><br><span class="line">          %<span class="number">13</span> = arith.addf %<span class="number">12</span>, %out : f32</span><br><span class="line">          linalg.yield %<span class="number">13</span> : f32</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; &#123;mapping = [<span class="meta">#gpu.thread<span class="string">&lt;x&gt;</span>]&#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>createLLVMGPUDistribute</p>
<p>将任务分配到每一个线程，source
func从线程块的计算逻辑转换成每个线程的计算逻辑，即用gpu.thread_id（x, y,
z）替换scf.foreach_thread。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">  %cst = arith.constant <span class="number">0.000000e+00</span> : f32</span><br><span class="line">  %c100 = arith.constant <span class="number">100</span> : index</span><br><span class="line">  %c4 = arith.constant <span class="number">4</span> : index</span><br><span class="line">  %c64 = arith.constant <span class="number">64</span> : index</span><br><span class="line">  %c256 = arith.constant <span class="number">256</span> : index</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %<span class="number">0</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">0</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">  memref.assume_alignment %<span class="number">0</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">  %<span class="number">1</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">1</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">  memref.assume_alignment %<span class="number">1</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">  %<span class="number">2</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">2</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">  memref.assume_alignment %<span class="number">2</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">  %workgroup_id_x = hal.interface.workgroup.id[<span class="number">0</span>] : index</span><br><span class="line">  %<span class="number">3</span> = affine.apply <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">256</span>)&gt;()[%workgroup_id_x]</span><br><span class="line">  %<span class="number">4</span> = affine.min <span class="built_in">affine_map</span>&lt;()[s0] -&gt; (s0 * <span class="number">-256</span> + <span class="number">100000</span>, <span class="number">256</span>)&gt;()[%workgroup_id_x]</span><br><span class="line">  %<span class="number">5</span> = arith.cmpi eq, %<span class="number">4</span>, %c256 : index</span><br><span class="line">  scf.<span class="keyword">if</span> %<span class="number">5</span> &#123;</span><br><span class="line">    %subview = memref.subview %<span class="number">0</span>[%<span class="number">3</span>, <span class="number">0</span>] [<span class="number">256</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt; to memref&lt;<span class="number">256</span>x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">    %subview_0 = memref.subview %<span class="number">1</span>[%<span class="number">3</span>, <span class="number">0</span>] [<span class="number">256</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt; to memref&lt;<span class="number">256</span>x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">    %subview_1 = memref.subview %<span class="number">2</span>[%<span class="number">3</span>] [<span class="number">256</span>] [<span class="number">1</span>] : memref&lt;<span class="number">100000</span>xf32&gt; to memref&lt;<span class="number">256</span>xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">    %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">    %<span class="number">6</span> = gpu.thread_id  x</span><br><span class="line">    %<span class="number">7</span> = gpu.thread_id  y</span><br><span class="line">    %<span class="number">8</span> = gpu.thread_id  z</span><br><span class="line">    %<span class="number">9</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0 * <span class="number">4</span>)&gt;(%<span class="number">6</span>)</span><br><span class="line">    %subview_2 = memref.subview %subview_1[%<span class="number">9</span>] [<span class="number">4</span>] [<span class="number">1</span>] : memref&lt;<span class="number">256</span>xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;&gt; to memref&lt;<span class="number">4</span>xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">    %<span class="number">10</span> = vector.transfer_read %subview_1[%<span class="number">9</span>], %cst &#123;in_bounds = [<span class="literal">true</span>]&#125; : memref&lt;<span class="number">256</span>xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">11</span> = scf.<span class="keyword">for</span> %arg0 = %c0 to %c100 step %c4 <span class="built_in">iter_args</span>(%arg1 = %<span class="number">10</span>) -&gt; (vector&lt;<span class="number">4</span>xf32&gt;) &#123;</span><br><span class="line">      %<span class="number">12</span> = vector.transfer_read %subview[%<span class="number">9</span>, %arg0], %cst &#123;in_bounds = [<span class="literal">true</span>, <span class="literal">true</span>]&#125; : memref&lt;<span class="number">256</span>x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;, vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">13</span> = vector.transfer_read %subview_0[%<span class="number">9</span>, %arg0], %cst &#123;in_bounds = [<span class="literal">true</span>, <span class="literal">true</span>]&#125; : memref&lt;<span class="number">256</span>x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;, vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">14</span> = arith.addf %<span class="number">12</span>, %<span class="number">13</span> : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">15</span> = vector.multi_reduction &lt;add&gt;, %<span class="number">14</span>, %arg1 [<span class="number">1</span>] : vector&lt;<span class="number">4</span>x4xf32&gt; to vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      scf.yield %<span class="number">15</span> : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    &#125;</span><br><span class="line">    vector.transfer_write %<span class="number">11</span>, %subview_2[%c0] &#123;in_bounds = [<span class="literal">true</span>]&#125; : vector&lt;<span class="number">4</span>xf32&gt;, memref&lt;<span class="number">4</span>xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    %subview = memref.subview %<span class="number">0</span>[%<span class="number">3</span>, <span class="number">0</span>] [%<span class="number">4</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt; to memref&lt;?x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">    %subview_0 = memref.subview %<span class="number">1</span>[%<span class="number">3</span>, <span class="number">0</span>] [%<span class="number">4</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt; to memref&lt;?x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">    %subview_1 = memref.subview %<span class="number">2</span>[%<span class="number">3</span>] [%<span class="number">4</span>] [<span class="number">1</span>] : memref&lt;<span class="number">100000</span>xf32&gt; to memref&lt;?xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">    %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">    %<span class="number">6</span> = gpu.thread_id  x</span><br><span class="line">    %<span class="number">7</span> = gpu.thread_id  y</span><br><span class="line">    %<span class="number">8</span> = gpu.thread_id  z</span><br><span class="line">    %<span class="number">9</span> = affine.min <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (-(d0 * (s0 ceildiv <span class="number">64</span>)) + s0, s0 ceildiv <span class="number">64</span>)&gt;(%<span class="number">6</span>)[%<span class="number">4</span>]</span><br><span class="line">    %<span class="number">10</span> = affine.max <span class="built_in">affine_map</span>&lt;(d0) -&gt; (<span class="number">0</span>, d0)&gt;(%<span class="number">9</span>)</span><br><span class="line">    %<span class="number">11</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (d0 * (s0 ceildiv <span class="number">64</span>))&gt;(%<span class="number">6</span>)[%<span class="number">4</span>]</span><br><span class="line">    %subview_2 = memref.subview %subview[%<span class="number">11</span>, <span class="number">0</span>] [%<span class="number">10</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;?x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt; to memref&lt;?x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">    %subview_3 = memref.subview %subview_0[%<span class="number">11</span>, <span class="number">0</span>] [%<span class="number">10</span>, <span class="number">100</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;?x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt; to memref&lt;?x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">    %subview_4 = memref.subview %subview_1[%<span class="number">11</span>] [%<span class="number">10</span>] [<span class="number">1</span>] : memref&lt;?xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;&gt; to memref&lt;?xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">    scf.<span class="keyword">for</span> %arg0 = %c0 to %c100 step %c4 &#123;</span><br><span class="line">      %subview_5 = memref.subview %subview_2[<span class="number">0</span>, %arg0] [%<span class="number">10</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;?x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt; to memref&lt;?x4xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">      %subview_6 = memref.subview %subview_3[<span class="number">0</span>, %arg0] [%<span class="number">10</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;?x100xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt; to memref&lt;?x4xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">      linalg.generic &#123;indexing_maps = [<span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0, d1)&gt;, <span class="built_in">affine_map</span>&lt;(d0, d1) -&gt; (d0)&gt;], iterator_types = [<span class="string">&quot;parallel&quot;</span>, <span class="string">&quot;reduction&quot;</span>]&#125; <span class="built_in">ins</span>(%subview_5, %subview_6 : memref&lt;?x4xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;, memref&lt;?x4xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;) <span class="built_in">outs</span>(%subview_4 : memref&lt;?xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;&gt;) attrs =  &#123;__internal_linalg_transform__ = <span class="string">&quot;workgroup_k_tiled&quot;</span>, lowering_config = #iree_codegen.lowering_config&lt;tile_sizes = [[<span class="number">256</span>, <span class="number">4</span>]]&gt;&#125; &#123;</span><br><span class="line">      ^<span class="built_in">bb0</span>(%in: f32, %in_7: f32, %out: f32):</span><br><span class="line">        %<span class="number">12</span> = arith.addf %in, %in_7 : f32</span><br><span class="line">        %<span class="number">13</span> = arith.addf %<span class="number">12</span>, %out : f32</span><br><span class="line">        linalg.yield %<span class="number">13</span> : f32</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>createLoopInvariantCodeMotionPass</p></li>
<li><p>memref::createFoldMemRefAliasOpsPass</p></li>
<li><p>createOptimizeVectorTransferPass</p></li>
</ul></li>
<li><p>GPUMatmulSimtPassPipeline</p></li>
<li><p>GPUMatmulTensorCorePassPipeline</p></li>
<li><p>GPUTransposePassPipeline</p></li>
<li><p>GPUWarpReductionPassPipeline</p></li>
<li><p>GPUTransformDialectPasses</p></li>
</ul></li>
</ul></li>
<li><p>addLowerToLLVMGPUPasses</p>
<p>继续将device代码递降到affine和gpu dialect，最终转换到NVVM IR或ROCDL
IR。</p>
<ul>
<li><p>IREE::LinalgExt::createLinalgExtToLoopsPass</p>
<p>将LinalgExt op转换成loops。</p></li>
<li><p>createMemrefCopyToLinalgPass</p>
<p>将<code>memref.copy</code>转换成linalg generic op。</p></li>
<li><p>createConvertLinalgToLoopsPass</p>
<p>将linalg generic op转换成loops。</p></li>
<li><p>createPadDynamicAlloc</p>
<p>以pad的方式申请动态大小的内存。比如需要申请的内存大小和dim相关，<code>%dim = affine_max(0, %src)</code>，那么这里就会以<code>%dim = %src</code>的最大size来申请内存。</p></li>
<li><p>createLowerAffinePass</p>
<p>递降到affine dialect。上面完整的source func代码会转换成如下代码，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">  %c<span class="number">-1</span> = arith.constant <span class="number">-1</span> : index</span><br><span class="line">  %c64 = arith.constant <span class="number">64</span> : index</span><br><span class="line">  %c100000 = arith.constant <span class="number">100000</span> : index</span><br><span class="line">  %c<span class="number">-256</span> = arith.constant <span class="number">-256</span> : index</span><br><span class="line">  %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">  %cst = arith.constant <span class="number">0.000000e+00</span> : f32</span><br><span class="line">  %c100 = arith.constant <span class="number">100</span> : index</span><br><span class="line">  %c4 = arith.constant <span class="number">4</span> : index</span><br><span class="line">  %c256 = arith.constant <span class="number">256</span> : index</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %<span class="number">0</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">0</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">  memref.assume_alignment %<span class="number">0</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">  %<span class="number">1</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">1</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">  memref.assume_alignment %<span class="number">1</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">  %<span class="number">2</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">2</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">  memref.assume_alignment %<span class="number">2</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">  %workgroup_id_x = hal.interface.workgroup.id[<span class="number">0</span>] : index</span><br><span class="line">  %<span class="number">3</span> = arith.muli %workgroup_id_x, %c<span class="number">-256</span> : index</span><br><span class="line">  %<span class="number">4</span> = arith.addi %<span class="number">3</span>, %c100000 : index</span><br><span class="line">  %<span class="number">5</span> = arith.cmpi slt, %<span class="number">4</span>, %c256 : index</span><br><span class="line">  %<span class="number">6</span> = arith.select %<span class="number">5</span>, %<span class="number">4</span>, %c256 : index</span><br><span class="line">  %<span class="number">7</span> = arith.cmpi eq, %<span class="number">6</span>, %c256 : index</span><br><span class="line">  scf.<span class="keyword">if</span> %<span class="number">7</span> &#123;</span><br><span class="line">    %<span class="number">8</span> = gpu.thread_id  x</span><br><span class="line">    %<span class="number">9</span> = arith.muli %<span class="number">8</span>, %c4 : index</span><br><span class="line">    %<span class="number">10</span> = arith.muli %workgroup_id_x, %c256 : index</span><br><span class="line">    %<span class="number">11</span> = arith.addi %<span class="number">9</span>, %<span class="number">10</span> : index</span><br><span class="line">    %<span class="number">12</span> = vector.transfer_read %<span class="number">2</span>[%<span class="number">11</span>], %cst &#123;in_bounds = [<span class="literal">true</span>]&#125; : memref&lt;<span class="number">100000</span>xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">13</span> = scf.<span class="keyword">for</span> %arg0 = %c0 to %c100 step %c4 <span class="built_in">iter_args</span>(%arg1 = %<span class="number">12</span>) -&gt; (vector&lt;<span class="number">4</span>xf32&gt;) &#123;</span><br><span class="line">      %<span class="number">14</span> = vector.transfer_read %<span class="number">0</span>[%<span class="number">11</span>, %arg0], %cst &#123;in_bounds = [<span class="literal">true</span>, <span class="literal">true</span>]&#125; : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">15</span> = vector.transfer_read %<span class="number">1</span>[%<span class="number">11</span>, %arg0], %cst &#123;in_bounds = [<span class="literal">true</span>, <span class="literal">true</span>]&#125; : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">16</span> = arith.addf %<span class="number">14</span>, %<span class="number">15</span> : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">17</span> = vector.multi_reduction &lt;add&gt;, %<span class="number">16</span>, %arg1 [<span class="number">1</span>] : vector&lt;<span class="number">4</span>x4xf32&gt; to vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      scf.yield %<span class="number">17</span> : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    &#125;</span><br><span class="line">    vector.transfer_write %<span class="number">13</span>, %<span class="number">2</span>[%<span class="number">11</span>] &#123;in_bounds = [<span class="literal">true</span>]&#125; : vector&lt;<span class="number">4</span>xf32&gt;, memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    %<span class="number">8</span> = gpu.thread_id  x</span><br><span class="line">    %<span class="number">9</span> = arith.cmpi sle, %<span class="number">6</span>, %c0 : index</span><br><span class="line">    %<span class="number">10</span> = arith.subi %c0, %<span class="number">6</span> : index</span><br><span class="line">    %<span class="number">11</span> = arith.subi %<span class="number">6</span>, %c1 : index</span><br><span class="line">    %<span class="number">12</span> = arith.select %<span class="number">9</span>, %<span class="number">10</span>, %<span class="number">11</span> : index</span><br><span class="line">    %<span class="number">13</span> = arith.divsi %<span class="number">12</span>, %c64 : index</span><br><span class="line">    %<span class="number">14</span> = arith.subi %c0, %<span class="number">13</span> : index</span><br><span class="line">    %<span class="number">15</span> = arith.addi %<span class="number">13</span>, %c1 : index</span><br><span class="line">    %<span class="number">16</span> = arith.select %<span class="number">9</span>, %<span class="number">14</span>, %<span class="number">15</span> : index</span><br><span class="line">    %<span class="number">17</span> = arith.muli %<span class="number">8</span>, %<span class="number">16</span> : index</span><br><span class="line">    %<span class="number">18</span> = arith.muli %<span class="number">17</span>, %c<span class="number">-1</span> : index</span><br><span class="line">    %<span class="number">19</span> = arith.addi %<span class="number">18</span>, %<span class="number">6</span> : index</span><br><span class="line">    %<span class="number">20</span> = arith.cmpi slt, %<span class="number">19</span>, %<span class="number">16</span> : index</span><br><span class="line">    %<span class="number">21</span> = arith.select %<span class="number">20</span>, %<span class="number">19</span>, %<span class="number">16</span> : index</span><br><span class="line">    %<span class="number">22</span> = arith.cmpi slt, %<span class="number">21</span>, %c0 : index</span><br><span class="line">    %<span class="number">23</span> = arith.select %<span class="number">22</span>, %c0, %<span class="number">21</span> : index</span><br><span class="line">    %<span class="number">24</span> = arith.muli %workgroup_id_x, %c256 : index</span><br><span class="line">    %<span class="number">25</span> = arith.addi %<span class="number">17</span>, %<span class="number">24</span> : index</span><br><span class="line">    %subview = memref.subview %<span class="number">2</span>[%<span class="number">25</span>] [%<span class="number">23</span>] [<span class="number">1</span>] : memref&lt;<span class="number">100000</span>xf32&gt; to memref&lt;?xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">    scf.<span class="keyword">for</span> %arg0 = %c0 to %c100 step %c4 &#123;</span><br><span class="line">      %subview_0 = memref.subview %<span class="number">0</span>[%<span class="number">25</span>, %arg0] [%<span class="number">23</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt; to memref&lt;?x4xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">      %subview_1 = memref.subview %<span class="number">1</span>[%<span class="number">25</span>, %arg0] [%<span class="number">23</span>, <span class="number">4</span>] [<span class="number">1</span>, <span class="number">1</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt; to memref&lt;?x4xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">      scf.<span class="keyword">for</span> %arg1 = %c0 to %<span class="number">23</span> step %c1 &#123;</span><br><span class="line">        scf.<span class="keyword">for</span> %arg2 = %c0 to %c4 step %c1 &#123;</span><br><span class="line">          %<span class="number">26</span> = memref.load %subview_0[%arg1, %arg2] : memref&lt;?x4xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">          %<span class="number">27</span> = memref.load %subview_1[%arg1, %arg2] : memref&lt;?x4xf32, strided&lt;[<span class="number">100</span>, <span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">          %<span class="number">28</span> = memref.load %subview[%arg1] : memref&lt;?xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">          %<span class="number">29</span> = arith.addf %<span class="number">26</span>, %<span class="number">27</span> : f32</span><br><span class="line">          %<span class="number">30</span> = arith.addf %<span class="number">29</span>, %<span class="number">28</span> : f32</span><br><span class="line">          memref.store %<span class="number">30</span>, %subview[%arg1] : memref&lt;?xf32, strided&lt;[<span class="number">1</span>], offset: ?&gt;&gt;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>arith::createConstantBufferizePass</p></li>
<li><p>createFoldTensorExtractOpPass</p></li>
<li><p>createLLVMGPUVectorLoweringPass</p>
<p>将多维vector op展开成一维的vector op。上面完整的source
func代码会转换成如下代码，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">  %cst = arith.constant dense&lt;<span class="number">0.000000e+00</span>&gt; : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">  %c<span class="number">-1</span> = arith.constant <span class="number">-1</span> : index</span><br><span class="line">  %c64 = arith.constant <span class="number">64</span> : index</span><br><span class="line">  %c100000 = arith.constant <span class="number">100000</span> : index</span><br><span class="line">  %c<span class="number">-256</span> = arith.constant <span class="number">-256</span> : index</span><br><span class="line">  %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">  %c100 = arith.constant <span class="number">100</span> : index</span><br><span class="line">  %c4 = arith.constant <span class="number">4</span> : index</span><br><span class="line">  %c256 = arith.constant <span class="number">256</span> : index</span><br><span class="line">  %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">  %<span class="number">0</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">0</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">  memref.assume_alignment %<span class="number">0</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">  %<span class="number">1</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">1</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">  memref.assume_alignment %<span class="number">1</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">  %<span class="number">2</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">2</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">  memref.assume_alignment %<span class="number">2</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">  %workgroup_id_x = hal.interface.workgroup.id[<span class="number">0</span>] : index</span><br><span class="line">  %<span class="number">3</span> = arith.muli %workgroup_id_x, %c<span class="number">-256</span> : index</span><br><span class="line">  %<span class="number">4</span> = arith.addi %<span class="number">3</span>, %c100000 : index</span><br><span class="line">  %<span class="number">5</span> = arith.cmpi slt, %<span class="number">4</span>, %c256 : index</span><br><span class="line">  %<span class="number">6</span> = arith.select %<span class="number">5</span>, %<span class="number">4</span>, %c256 : index</span><br><span class="line">  %<span class="number">7</span> = arith.cmpi eq, %<span class="number">6</span>, %c256 : index</span><br><span class="line">  scf.<span class="keyword">if</span> %<span class="number">7</span> &#123;</span><br><span class="line">    %<span class="number">8</span> = gpu.thread_id  x</span><br><span class="line">    %<span class="number">9</span> = arith.muli %<span class="number">8</span>, %c4 : index</span><br><span class="line">    %<span class="number">10</span> = arith.muli %workgroup_id_x, %c256 : index</span><br><span class="line">    %<span class="number">11</span> = arith.addi %<span class="number">9</span>, %<span class="number">10</span> : index</span><br><span class="line">    %<span class="number">12</span> = vector.load %<span class="number">2</span>[%<span class="number">11</span>] : memref&lt;<span class="number">100000</span>xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">13</span> = scf.<span class="keyword">for</span> %arg0 = %c0 to %c100 step %c4 <span class="built_in">iter_args</span>(%arg1 = %<span class="number">12</span>) -&gt; (vector&lt;<span class="number">4</span>xf32&gt;) &#123;</span><br><span class="line">      %<span class="number">14</span> = vector.load %<span class="number">0</span>[%<span class="number">11</span>, %arg0] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      %<span class="number">15</span> = vector.insert %<span class="number">14</span>, %cst [<span class="number">0</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">16</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0 + <span class="number">1</span>)&gt;(%<span class="number">11</span>)</span><br><span class="line">      %<span class="number">17</span> = vector.load %<span class="number">0</span>[%<span class="number">16</span>, %arg0] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      %<span class="number">18</span> = vector.insert %<span class="number">17</span>, %<span class="number">15</span> [<span class="number">1</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">19</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0 + <span class="number">2</span>)&gt;(%<span class="number">11</span>)</span><br><span class="line">      %<span class="number">20</span> = vector.load %<span class="number">0</span>[%<span class="number">19</span>, %arg0] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      %<span class="number">21</span> = vector.insert %<span class="number">20</span>, %<span class="number">18</span> [<span class="number">2</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">22</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0 + <span class="number">3</span>)&gt;(%<span class="number">11</span>)</span><br><span class="line">      %<span class="number">23</span> = vector.load %<span class="number">0</span>[%<span class="number">22</span>, %arg0] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      %<span class="number">24</span> = vector.insert %<span class="number">23</span>, %<span class="number">21</span> [<span class="number">3</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">25</span> = vector.load %<span class="number">1</span>[%<span class="number">11</span>, %arg0] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      %<span class="number">26</span> = vector.insert %<span class="number">25</span>, %cst [<span class="number">0</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">27</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0 + <span class="number">1</span>)&gt;(%<span class="number">11</span>)</span><br><span class="line">      %<span class="number">28</span> = vector.load %<span class="number">1</span>[%<span class="number">27</span>, %arg0] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      %<span class="number">29</span> = vector.insert %<span class="number">28</span>, %<span class="number">26</span> [<span class="number">1</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">30</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0 + <span class="number">2</span>)&gt;(%<span class="number">11</span>)</span><br><span class="line">      %<span class="number">31</span> = vector.load %<span class="number">1</span>[%<span class="number">30</span>, %arg0] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      %<span class="number">32</span> = vector.insert %<span class="number">31</span>, %<span class="number">29</span> [<span class="number">2</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">33</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0) -&gt; (d0 + <span class="number">3</span>)&gt;(%<span class="number">11</span>)</span><br><span class="line">      %<span class="number">34</span> = vector.load %<span class="number">1</span>[%<span class="number">33</span>, %arg0] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      %<span class="number">35</span> = vector.insert %<span class="number">34</span>, %<span class="number">32</span> [<span class="number">3</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">36</span> = arith.addf %<span class="number">24</span>, %<span class="number">35</span> : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">37</span> = vector.transpose %<span class="number">36</span>, [<span class="number">1</span>, <span class="number">0</span>] : vector&lt;<span class="number">4</span>x4xf32&gt; to vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">38</span> = vector.extract %<span class="number">37</span>[<span class="number">0</span>] : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">39</span> = arith.addf %<span class="number">38</span>, %arg1 : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      %<span class="number">40</span> = vector.extract %<span class="number">37</span>[<span class="number">1</span>] : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">41</span> = arith.addf %<span class="number">40</span>, %<span class="number">39</span> : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      %<span class="number">42</span> = vector.extract %<span class="number">37</span>[<span class="number">2</span>] : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">43</span> = arith.addf %<span class="number">42</span>, %<span class="number">41</span> : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      %<span class="number">44</span> = vector.extract %<span class="number">37</span>[<span class="number">3</span>] : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">      %<span class="number">45</span> = arith.addf %<span class="number">44</span>, %<span class="number">43</span> : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">      scf.yield %<span class="number">45</span> : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    &#125;</span><br><span class="line">    vector.store %<span class="number">13</span>, %<span class="number">2</span>[%<span class="number">11</span>] : memref&lt;<span class="number">100000</span>xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    %<span class="number">8</span> = gpu.thread_id  x</span><br><span class="line">    %<span class="number">9</span> = arith.cmpi sle, %<span class="number">6</span>, %c0 : index</span><br><span class="line">    %<span class="number">10</span> = arith.subi %c0, %<span class="number">6</span> : index</span><br><span class="line">    %<span class="number">11</span> = arith.subi %<span class="number">6</span>, %c1 : index</span><br><span class="line">    %<span class="number">12</span> = arith.select %<span class="number">9</span>, %<span class="number">10</span>, %<span class="number">11</span> : index</span><br><span class="line">    %<span class="number">13</span> = arith.divsi %<span class="number">12</span>, %c64 : index</span><br><span class="line">    %<span class="number">14</span> = arith.subi %c0, %<span class="number">13</span> : index</span><br><span class="line">    %<span class="number">15</span> = arith.addi %<span class="number">13</span>, %c1 : index</span><br><span class="line">    %<span class="number">16</span> = arith.select %<span class="number">9</span>, %<span class="number">14</span>, %<span class="number">15</span> : index</span><br><span class="line">    %<span class="number">17</span> = arith.muli %<span class="number">8</span>, %<span class="number">16</span> : index</span><br><span class="line">    %<span class="number">18</span> = arith.muli %<span class="number">17</span>, %c<span class="number">-1</span> : index</span><br><span class="line">    %<span class="number">19</span> = arith.addi %<span class="number">18</span>, %<span class="number">6</span> : index</span><br><span class="line">    %<span class="number">20</span> = arith.cmpi slt, %<span class="number">19</span>, %<span class="number">16</span> : index</span><br><span class="line">    %<span class="number">21</span> = arith.select %<span class="number">20</span>, %<span class="number">19</span>, %<span class="number">16</span> : index</span><br><span class="line">    %<span class="number">22</span> = arith.cmpi slt, %<span class="number">21</span>, %c0 : index</span><br><span class="line">    %<span class="number">23</span> = arith.select %<span class="number">22</span>, %c0, %<span class="number">21</span> : index</span><br><span class="line">    %<span class="number">24</span> = arith.muli %workgroup_id_x, %c256 : index</span><br><span class="line">    %<span class="number">25</span> = arith.addi %<span class="number">17</span>, %<span class="number">24</span> : index</span><br><span class="line">    scf.<span class="keyword">for</span> %arg0 = %c0 to %c100 step %c4 &#123;</span><br><span class="line">      scf.<span class="keyword">for</span> %arg1 = %c0 to %<span class="number">23</span> step %c1 &#123;</span><br><span class="line">        scf.<span class="keyword">for</span> %arg2 = %c0 to %c4 step %c1 &#123;</span><br><span class="line">          %<span class="number">26</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (d0 + s0)&gt;(%arg1)[%<span class="number">25</span>]</span><br><span class="line">          %<span class="number">27</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (d0 + s0)&gt;(%arg2)[%arg0]</span><br><span class="line">          %<span class="number">28</span> = memref.load %<span class="number">0</span>[%<span class="number">26</span>, %<span class="number">27</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">          %<span class="number">29</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (d0 + s0)&gt;(%arg1)[%<span class="number">25</span>]</span><br><span class="line">          %<span class="number">30</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (d0 + s0)&gt;(%arg2)[%arg0]</span><br><span class="line">          %<span class="number">31</span> = memref.load %<span class="number">1</span>[%<span class="number">29</span>, %<span class="number">30</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">          %<span class="number">32</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (d0 + s0)&gt;(%arg1)[%<span class="number">25</span>]</span><br><span class="line">          %<span class="number">33</span> = memref.load %<span class="number">2</span>[%<span class="number">32</span>] : memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">          %<span class="number">34</span> = arith.addf %<span class="number">28</span>, %<span class="number">31</span> : f32</span><br><span class="line">          %<span class="number">35</span> = arith.addf %<span class="number">34</span>, %<span class="number">33</span> : f32</span><br><span class="line">          %<span class="number">36</span> = affine.apply <span class="built_in">affine_map</span>&lt;(d0)[s0] -&gt; (d0 + s0)&gt;(%arg1)[%<span class="number">25</span>]</span><br><span class="line">          memref.store %<span class="number">35</span>, %<span class="number">2</span>[%<span class="number">36</span>] : memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>createConvertSCFToCFPass</p>
<p>将structure的control flow转换成CFG的控制流。上面完整的source
func代码会转换成如下代码，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">func.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>() &#123;</span><br><span class="line">    %cst = arith.constant dense&lt;<span class="number">0.000000e+00</span>&gt; : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %c<span class="number">-1</span> = arith.constant <span class="number">-1</span> : index</span><br><span class="line">    %c64 = arith.constant <span class="number">64</span> : index</span><br><span class="line">    %c100000 = arith.constant <span class="number">100000</span> : index</span><br><span class="line">    %c<span class="number">-256</span> = arith.constant <span class="number">-256</span> : index</span><br><span class="line">    %c1 = arith.constant <span class="number">1</span> : index</span><br><span class="line">    %c100 = arith.constant <span class="number">100</span> : index</span><br><span class="line">    %c4 = arith.constant <span class="number">4</span> : index</span><br><span class="line">    %c256 = arith.constant <span class="number">256</span> : index</span><br><span class="line">    %c0 = arith.constant <span class="number">0</span> : index</span><br><span class="line">    %<span class="number">0</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">0</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">    memref.assume_alignment %<span class="number">0</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">    %<span class="number">1</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">1</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">    memref.assume_alignment %<span class="number">1</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">    %<span class="number">2</span> = hal.interface.binding.subspan <span class="built_in">set</span>(<span class="number">0</span>) <span class="built_in">binding</span>(<span class="number">2</span>) <span class="built_in">type</span>(storage_buffer) <span class="built_in">offset</span>(%c0) <span class="built_in">alignment</span>(<span class="number">64</span>) : memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">    memref.assume_alignment %<span class="number">2</span>, <span class="number">64</span> : memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">    %workgroup_id_x = hal.interface.workgroup.id[<span class="number">0</span>] : index</span><br><span class="line">    %<span class="number">3</span> = arith.muli %workgroup_id_x, %c<span class="number">-256</span> : index</span><br><span class="line">    %<span class="number">4</span> = arith.addi %<span class="number">3</span>, %c100000 : index</span><br><span class="line">    %<span class="number">5</span> = arith.cmpi slt, %<span class="number">4</span>, %c256 : index</span><br><span class="line">    %<span class="number">6</span> = arith.select %<span class="number">5</span>, %<span class="number">4</span>, %c256 : index</span><br><span class="line">    %<span class="number">7</span> = arith.cmpi eq, %<span class="number">6</span>, %c256 : index</span><br><span class="line">    cf.cond_br %<span class="number">7</span>, ^bb1, ^bb5</span><br><span class="line">  ^bb1:  <span class="comment">// pred: ^bb0</span></span><br><span class="line">    %<span class="number">8</span> = gpu.thread_id  x</span><br><span class="line">    %<span class="number">9</span> = arith.muli %<span class="number">8</span>, %c4 : index</span><br><span class="line">    %<span class="number">10</span> = arith.muli %workgroup_id_x, %c256 : index</span><br><span class="line">    %<span class="number">11</span> = arith.addi %<span class="number">9</span>, %<span class="number">10</span> : index</span><br><span class="line">    %<span class="number">12</span> = vector.load %<span class="number">2</span>[%<span class="number">11</span>] : memref&lt;<span class="number">100000</span>xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    cf.br ^<span class="built_in">bb2</span>(%c0, %<span class="number">12</span> : index, vector&lt;<span class="number">4</span>xf32&gt;)</span><br><span class="line">  ^<span class="built_in">bb2</span>(%<span class="number">13</span>: index, %<span class="number">14</span>: vector&lt;<span class="number">4</span>xf32&gt;):  <span class="comment">// 2 preds: ^bb1, ^bb3</span></span><br><span class="line">    %<span class="number">15</span> = arith.cmpi slt, %<span class="number">13</span>, %c100 : index</span><br><span class="line">    cf.cond_br %<span class="number">15</span>, ^bb3, ^bb4</span><br><span class="line">  ^bb3:  <span class="comment">// pred: ^bb2</span></span><br><span class="line">    %<span class="number">16</span> = vector.load %<span class="number">0</span>[%<span class="number">11</span>, %<span class="number">13</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">17</span> = vector.insert %<span class="number">16</span>, %cst [<span class="number">0</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %c1_0 = arith.constant <span class="number">1</span> : index</span><br><span class="line">    %<span class="number">18</span> = arith.addi %<span class="number">11</span>, %c1_0 : index</span><br><span class="line">    %<span class="number">19</span> = vector.load %<span class="number">0</span>[%<span class="number">18</span>, %<span class="number">13</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">20</span> = vector.insert %<span class="number">19</span>, %<span class="number">17</span> [<span class="number">1</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %c2 = arith.constant <span class="number">2</span> : index</span><br><span class="line">    %<span class="number">21</span> = arith.addi %<span class="number">11</span>, %c2 : index</span><br><span class="line">    %<span class="number">22</span> = vector.load %<span class="number">0</span>[%<span class="number">21</span>, %<span class="number">13</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">23</span> = vector.insert %<span class="number">22</span>, %<span class="number">20</span> [<span class="number">2</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %c3 = arith.constant <span class="number">3</span> : index</span><br><span class="line">    %<span class="number">24</span> = arith.addi %<span class="number">11</span>, %c3 : index</span><br><span class="line">    %<span class="number">25</span> = vector.load %<span class="number">0</span>[%<span class="number">24</span>, %<span class="number">13</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">26</span> = vector.insert %<span class="number">25</span>, %<span class="number">23</span> [<span class="number">3</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %<span class="number">27</span> = vector.load %<span class="number">1</span>[%<span class="number">11</span>, %<span class="number">13</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">28</span> = vector.insert %<span class="number">27</span>, %cst [<span class="number">0</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %<span class="number">29</span> = vector.load %<span class="number">1</span>[%<span class="number">18</span>, %<span class="number">13</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">30</span> = vector.insert %<span class="number">29</span>, %<span class="number">28</span> [<span class="number">1</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %<span class="number">31</span> = vector.load %<span class="number">1</span>[%<span class="number">21</span>, %<span class="number">13</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">32</span> = vector.insert %<span class="number">31</span>, %<span class="number">30</span> [<span class="number">2</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %<span class="number">33</span> = vector.load %<span class="number">1</span>[%<span class="number">24</span>, %<span class="number">13</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">34</span> = vector.insert %<span class="number">33</span>, %<span class="number">32</span> [<span class="number">3</span>] : vector&lt;<span class="number">4</span>xf32&gt; into vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %<span class="number">35</span> = arith.addf %<span class="number">26</span>, %<span class="number">34</span> : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %<span class="number">36</span> = vector.transpose %<span class="number">35</span>, [<span class="number">1</span>, <span class="number">0</span>] : vector&lt;<span class="number">4</span>x4xf32&gt; to vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %<span class="number">37</span> = vector.extract %<span class="number">36</span>[<span class="number">0</span>] : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %<span class="number">38</span> = arith.addf %<span class="number">37</span>, %<span class="number">14</span> : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">39</span> = vector.extract %<span class="number">36</span>[<span class="number">1</span>] : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %<span class="number">40</span> = arith.addf %<span class="number">39</span>, %<span class="number">38</span> : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">41</span> = vector.extract %<span class="number">36</span>[<span class="number">2</span>] : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %<span class="number">42</span> = arith.addf %<span class="number">41</span>, %<span class="number">40</span> : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">43</span> = vector.extract %<span class="number">36</span>[<span class="number">3</span>] : vector&lt;<span class="number">4</span>x4xf32&gt;</span><br><span class="line">    %<span class="number">44</span> = arith.addf %<span class="number">43</span>, %<span class="number">42</span> : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">45</span> = arith.addi %<span class="number">13</span>, %c4 : index</span><br><span class="line">    cf.br ^<span class="built_in">bb2</span>(%<span class="number">45</span>, %<span class="number">44</span> : index, vector&lt;<span class="number">4</span>xf32&gt;)</span><br><span class="line">  ^bb4:  <span class="comment">// pred: ^bb2</span></span><br><span class="line">    vector.store %<span class="number">14</span>, %<span class="number">2</span>[%<span class="number">11</span>] : memref&lt;<span class="number">100000</span>xf32&gt;, vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    cf.br ^bb12</span><br><span class="line">  ^bb5:  <span class="comment">// pred: ^bb0</span></span><br><span class="line">    %<span class="number">46</span> = gpu.thread_id  x</span><br><span class="line">    %<span class="number">47</span> = arith.cmpi sle, %<span class="number">6</span>, %c0 : index</span><br><span class="line">    %<span class="number">48</span> = arith.subi %c0, %<span class="number">6</span> : index</span><br><span class="line">    %<span class="number">49</span> = arith.subi %<span class="number">6</span>, %c1 : index</span><br><span class="line">    %<span class="number">50</span> = arith.select %<span class="number">47</span>, %<span class="number">48</span>, %<span class="number">49</span> : index</span><br><span class="line">    %<span class="number">51</span> = arith.divsi %<span class="number">50</span>, %c64 : index</span><br><span class="line">    %<span class="number">52</span> = arith.subi %c0, %<span class="number">51</span> : index</span><br><span class="line">    %<span class="number">53</span> = arith.addi %<span class="number">51</span>, %c1 : index</span><br><span class="line">    %<span class="number">54</span> = arith.select %<span class="number">47</span>, %<span class="number">52</span>, %<span class="number">53</span> : index</span><br><span class="line">    %<span class="number">55</span> = arith.muli %<span class="number">46</span>, %<span class="number">54</span> : index</span><br><span class="line">    %<span class="number">56</span> = arith.muli %<span class="number">55</span>, %c<span class="number">-1</span> : index</span><br><span class="line">    %<span class="number">57</span> = arith.addi %<span class="number">56</span>, %<span class="number">6</span> : index</span><br><span class="line">    %<span class="number">58</span> = arith.cmpi slt, %<span class="number">57</span>, %<span class="number">54</span> : index</span><br><span class="line">    %<span class="number">59</span> = arith.select %<span class="number">58</span>, %<span class="number">57</span>, %<span class="number">54</span> : index</span><br><span class="line">    %<span class="number">60</span> = arith.cmpi slt, %<span class="number">59</span>, %c0 : index</span><br><span class="line">    %<span class="number">61</span> = arith.select %<span class="number">60</span>, %c0, %<span class="number">59</span> : index</span><br><span class="line">    %<span class="number">62</span> = arith.muli %workgroup_id_x, %c256 : index</span><br><span class="line">    %<span class="number">63</span> = arith.addi %<span class="number">55</span>, %<span class="number">62</span> : index</span><br><span class="line">    cf.br ^<span class="built_in">bb6</span>(%c0 : index)</span><br><span class="line">  ^<span class="built_in">bb6</span>(%<span class="number">64</span>: index):  <span class="comment">// 2 preds: ^bb5, ^bb11</span></span><br><span class="line">    %<span class="number">65</span> = arith.cmpi slt, %<span class="number">64</span>, %c100 : index</span><br><span class="line">    cf.cond_br %<span class="number">65</span>, ^<span class="built_in">bb7</span>(%c0 : index), ^bb12</span><br><span class="line">  ^<span class="built_in">bb7</span>(%<span class="number">66</span>: index):  <span class="comment">// 2 preds: ^bb6, ^bb10</span></span><br><span class="line">    %<span class="number">67</span> = arith.cmpi slt, %<span class="number">66</span>, %<span class="number">61</span> : index</span><br><span class="line">    cf.cond_br %<span class="number">67</span>, ^<span class="built_in">bb8</span>(%c0 : index), ^bb11</span><br><span class="line">  ^<span class="built_in">bb8</span>(%<span class="number">68</span>: index):  <span class="comment">// 2 preds: ^bb7, ^bb9</span></span><br><span class="line">    %<span class="number">69</span> = arith.cmpi slt, %<span class="number">68</span>, %c4 : index</span><br><span class="line">    cf.cond_br %<span class="number">69</span>, ^bb9, ^bb10</span><br><span class="line">  ^bb9:  <span class="comment">// pred: ^bb8</span></span><br><span class="line">    %<span class="number">70</span> = arith.addi %<span class="number">63</span>, %<span class="number">66</span> : index</span><br><span class="line">    %<span class="number">71</span> = arith.addi %<span class="number">64</span>, %<span class="number">68</span> : index</span><br><span class="line">    %<span class="number">72</span> = memref.load %<span class="number">0</span>[%<span class="number">70</span>, %<span class="number">71</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">    %<span class="number">73</span> = memref.load %<span class="number">1</span>[%<span class="number">70</span>, %<span class="number">71</span>] : memref&lt;<span class="number">100000</span>x100xf32&gt;</span><br><span class="line">    %<span class="number">74</span> = memref.load %<span class="number">2</span>[%<span class="number">70</span>] : memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">    %<span class="number">75</span> = arith.addf %<span class="number">72</span>, %<span class="number">73</span> : f32</span><br><span class="line">    %<span class="number">76</span> = arith.addf %<span class="number">75</span>, %<span class="number">74</span> : f32</span><br><span class="line">    memref.store %<span class="number">76</span>, %<span class="number">2</span>[%<span class="number">70</span>] : memref&lt;<span class="number">100000</span>xf32&gt;</span><br><span class="line">    %<span class="number">77</span> = arith.addi %<span class="number">68</span>, %c1 : index</span><br><span class="line">    cf.br ^<span class="built_in">bb8</span>(%<span class="number">77</span> : index)</span><br><span class="line">  ^bb10:  <span class="comment">// pred: ^bb8</span></span><br><span class="line">    %<span class="number">78</span> = arith.addi %<span class="number">66</span>, %c1 : index</span><br><span class="line">    cf.br ^<span class="built_in">bb7</span>(%<span class="number">78</span> : index)</span><br><span class="line">  ^bb11:  <span class="comment">// pred: ^bb7</span></span><br><span class="line">    %<span class="number">79</span> = arith.addi %<span class="number">64</span>, %c4 : index</span><br><span class="line">    cf.br ^<span class="built_in">bb6</span>(%<span class="number">79</span> : index)</span><br><span class="line">  ^bb12:  <span class="comment">// 2 preds: ^bb4, ^bb6</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>createPolynomialApproximationPass</p></li>
<li><p>arith::createArithExpandOpsPass</p></li>
<li><p>memref::createExpandOpsPass</p></li>
<li><p>memref::createExpandStridedMetadataPass</p></li>
<li><p>createLowerAffinePass</p></li>
<li><p>createStripDebugInfoPass</p></li>
<li><p>createConvertToROCDLPass或createConvertToNVVMPass</p>
<p>转换到ROCDL IR或NVVM IR。上面完整的source
func代码会转换成如下代码，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br></pre></td><td class="code"><pre><span class="line">llvm.func @<span class="built_in">test_dispatch_0_generic_100000x100</span>(%arg0: !llvm.ptr&lt;f32&gt; &#123;llvm.align = <span class="number">16</span> : i32&#125;, %arg1: !llvm.ptr&lt;f32&gt; &#123;llvm.align = <span class="number">16</span> : i32&#125;, %arg2: !llvm.ptr&lt;f32&gt; &#123;llvm.align = <span class="number">16</span> : i32&#125;) &#123;</span><br><span class="line">    %<span class="number">0</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">3</span> : index) : i64</span><br><span class="line">    %<span class="number">1</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">2</span> : index) : i64</span><br><span class="line">    %<span class="number">2</span> = llvm.mlir.<span class="built_in">constant</span>(dense&lt;<span class="number">0.000000e+00</span>&gt; : vector&lt;<span class="number">4</span>x4xf32&gt;) : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">3</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">-1</span> : index) : i64</span><br><span class="line">    %<span class="number">4</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">64</span> : index) : i64</span><br><span class="line">    %<span class="number">5</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100000</span> : index) : i64</span><br><span class="line">    %<span class="number">6</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">-256</span> : index) : i64</span><br><span class="line">    %<span class="number">7</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">1</span> : index) : i64</span><br><span class="line">    %<span class="number">8</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">9</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">4</span> : index) : i64</span><br><span class="line">    %<span class="number">10</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">256</span> : index) : i64</span><br><span class="line">    %<span class="number">11</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : index) : i64</span><br><span class="line">    %<span class="number">12</span> = llvm.bitcast %arg0 : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;i8&gt;</span><br><span class="line">    %<span class="number">13</span> = llvm.getelementptr %<span class="number">12</span>[%<span class="number">11</span>] : (!llvm.ptr&lt;i8&gt;, i64) -&gt; !llvm.ptr&lt;i8&gt;</span><br><span class="line">    %<span class="number">14</span> = llvm.bitcast %<span class="number">13</span> : !llvm.ptr&lt;i8&gt; to !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">15</span> = llvm.mlir.undef : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">16</span> = llvm.insertvalue %<span class="number">14</span>, %<span class="number">15</span>[<span class="number">0</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">17</span> = llvm.insertvalue %<span class="number">14</span>, %<span class="number">16</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">18</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : index) : i64</span><br><span class="line">    %<span class="number">19</span> = llvm.insertvalue %<span class="number">18</span>, %<span class="number">17</span>[<span class="number">2</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">20</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100000</span> : index) : i64</span><br><span class="line">    %<span class="number">21</span> = llvm.insertvalue %<span class="number">20</span>, %<span class="number">19</span>[<span class="number">3</span>, <span class="number">0</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">22</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">23</span> = llvm.insertvalue %<span class="number">22</span>, %<span class="number">21</span>[<span class="number">4</span>, <span class="number">0</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">24</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">25</span> = llvm.insertvalue %<span class="number">24</span>, %<span class="number">23</span>[<span class="number">3</span>, <span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">26</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">1</span> : index) : i64</span><br><span class="line">    %<span class="number">27</span> = llvm.insertvalue %<span class="number">26</span>, %<span class="number">25</span>[<span class="number">4</span>, <span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">28</span> = llvm.extractvalue %<span class="number">27</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">29</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : index) : i64</span><br><span class="line">    %<span class="number">30</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">63</span> : index) : i64</span><br><span class="line">    %<span class="number">31</span> = llvm.ptrtoint %<span class="number">28</span> : !llvm.ptr&lt;f32&gt; to i64</span><br><span class="line">    %<span class="number">32</span> = llvm.<span class="keyword">and</span> %<span class="number">31</span>, %<span class="number">30</span>  : i64</span><br><span class="line">    %<span class="number">33</span> = llvm.icmp <span class="string">&quot;eq&quot;</span> %<span class="number">32</span>, %<span class="number">29</span> : i64</span><br><span class="line">    <span class="string">&quot;llvm.intr.assume&quot;</span>(%<span class="number">33</span>) : (i1) -&gt; ()</span><br><span class="line">    %<span class="number">34</span> = llvm.bitcast %arg1 : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;i8&gt;</span><br><span class="line">    %<span class="number">35</span> = llvm.getelementptr %<span class="number">34</span>[%<span class="number">11</span>] : (!llvm.ptr&lt;i8&gt;, i64) -&gt; !llvm.ptr&lt;i8&gt;</span><br><span class="line">    %<span class="number">36</span> = llvm.bitcast %<span class="number">35</span> : !llvm.ptr&lt;i8&gt; to !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">37</span> = llvm.mlir.undef : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">38</span> = llvm.insertvalue %<span class="number">36</span>, %<span class="number">37</span>[<span class="number">0</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">39</span> = llvm.insertvalue %<span class="number">36</span>, %<span class="number">38</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">40</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : index) : i64</span><br><span class="line">    %<span class="number">41</span> = llvm.insertvalue %<span class="number">40</span>, %<span class="number">39</span>[<span class="number">2</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">42</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100000</span> : index) : i64</span><br><span class="line">    %<span class="number">43</span> = llvm.insertvalue %<span class="number">42</span>, %<span class="number">41</span>[<span class="number">3</span>, <span class="number">0</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">44</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">45</span> = llvm.insertvalue %<span class="number">44</span>, %<span class="number">43</span>[<span class="number">4</span>, <span class="number">0</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">46</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">47</span> = llvm.insertvalue %<span class="number">46</span>, %<span class="number">45</span>[<span class="number">3</span>, <span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">48</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">1</span> : index) : i64</span><br><span class="line">    %<span class="number">49</span> = llvm.insertvalue %<span class="number">48</span>, %<span class="number">47</span>[<span class="number">4</span>, <span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">50</span> = llvm.extractvalue %<span class="number">49</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">51</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : index) : i64</span><br><span class="line">    %<span class="number">52</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">63</span> : index) : i64</span><br><span class="line">    %<span class="number">53</span> = llvm.ptrtoint %<span class="number">50</span> : !llvm.ptr&lt;f32&gt; to i64</span><br><span class="line">    %<span class="number">54</span> = llvm.<span class="keyword">and</span> %<span class="number">53</span>, %<span class="number">52</span>  : i64</span><br><span class="line">    %<span class="number">55</span> = llvm.icmp <span class="string">&quot;eq&quot;</span> %<span class="number">54</span>, %<span class="number">51</span> : i64</span><br><span class="line">    <span class="string">&quot;llvm.intr.assume&quot;</span>(%<span class="number">55</span>) : (i1) -&gt; ()</span><br><span class="line">    %<span class="number">56</span> = llvm.bitcast %arg2 : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;i8&gt;</span><br><span class="line">    %<span class="number">57</span> = llvm.getelementptr %<span class="number">56</span>[%<span class="number">11</span>] : (!llvm.ptr&lt;i8&gt;, i64) -&gt; !llvm.ptr&lt;i8&gt;</span><br><span class="line">    %<span class="number">58</span> = llvm.bitcast %<span class="number">57</span> : !llvm.ptr&lt;i8&gt; to !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">59</span> = llvm.mlir.undef : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">1</span> x i64&gt;, array&lt;<span class="number">1</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">60</span> = llvm.insertvalue %<span class="number">58</span>, %<span class="number">59</span>[<span class="number">0</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">1</span> x i64&gt;, array&lt;<span class="number">1</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">61</span> = llvm.insertvalue %<span class="number">58</span>, %<span class="number">60</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">1</span> x i64&gt;, array&lt;<span class="number">1</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">62</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : index) : i64</span><br><span class="line">    %<span class="number">63</span> = llvm.insertvalue %<span class="number">62</span>, %<span class="number">61</span>[<span class="number">2</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">1</span> x i64&gt;, array&lt;<span class="number">1</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">64</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100000</span> : index) : i64</span><br><span class="line">    %<span class="number">65</span> = llvm.insertvalue %<span class="number">64</span>, %<span class="number">63</span>[<span class="number">3</span>, <span class="number">0</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">1</span> x i64&gt;, array&lt;<span class="number">1</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">66</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">1</span> : index) : i64</span><br><span class="line">    %<span class="number">67</span> = llvm.insertvalue %<span class="number">66</span>, %<span class="number">65</span>[<span class="number">4</span>, <span class="number">0</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">1</span> x i64&gt;, array&lt;<span class="number">1</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">68</span> = llvm.extractvalue %<span class="number">67</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">1</span> x i64&gt;, array&lt;<span class="number">1</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">69</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : index) : i64</span><br><span class="line">    %<span class="number">70</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">63</span> : index) : i64</span><br><span class="line">    %<span class="number">71</span> = llvm.ptrtoint %<span class="number">68</span> : !llvm.ptr&lt;f32&gt; to i64</span><br><span class="line">    %<span class="number">72</span> = llvm.<span class="keyword">and</span> %<span class="number">71</span>, %<span class="number">70</span>  : i64</span><br><span class="line">    %<span class="number">73</span> = llvm.icmp <span class="string">&quot;eq&quot;</span> %<span class="number">72</span>, %<span class="number">69</span> : i64</span><br><span class="line">    <span class="string">&quot;llvm.intr.assume&quot;</span>(%<span class="number">73</span>) : (i1) -&gt; ()</span><br><span class="line">    %<span class="number">74</span> = nvvm.read.ptx.sreg.ctaid.x : i32</span><br><span class="line">    %<span class="number">75</span> = llvm.sext %<span class="number">74</span> : i32 to i64</span><br><span class="line">    %<span class="number">76</span> = llvm.mul %<span class="number">75</span>, %<span class="number">6</span>  : i64</span><br><span class="line">    %<span class="number">77</span> = llvm.add %<span class="number">76</span>, %<span class="number">5</span>  : i64</span><br><span class="line">    %<span class="number">78</span> = llvm.icmp <span class="string">&quot;slt&quot;</span> %<span class="number">77</span>, %<span class="number">10</span> : i64</span><br><span class="line">    %<span class="number">79</span> = llvm.select %<span class="number">78</span>, %<span class="number">77</span>, %<span class="number">10</span> : i1, i64</span><br><span class="line">    %<span class="number">80</span> = llvm.icmp <span class="string">&quot;eq&quot;</span> %<span class="number">79</span>, %<span class="number">10</span> : i64</span><br><span class="line">    llvm.cond_br %<span class="number">80</span>, ^bb1, ^bb5</span><br><span class="line">  ^bb1:  <span class="comment">// pred: ^bb0</span></span><br><span class="line">    %<span class="number">81</span> = nvvm.read.ptx.sreg.tid.x : i32</span><br><span class="line">    %<span class="number">82</span> = llvm.sext %<span class="number">81</span> : i32 to i64</span><br><span class="line">    %<span class="number">83</span> = llvm.mul %<span class="number">82</span>, %<span class="number">9</span>  : i64</span><br><span class="line">    %<span class="number">84</span> = llvm.mul %<span class="number">75</span>, %<span class="number">10</span>  : i64</span><br><span class="line">    %<span class="number">85</span> = llvm.add %<span class="number">83</span>, %<span class="number">84</span>  : i64</span><br><span class="line">    %<span class="number">86</span> = llvm.extractvalue %<span class="number">67</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">1</span> x i64&gt;, array&lt;<span class="number">1</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">87</span> = llvm.getelementptr %<span class="number">86</span>[%<span class="number">85</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">88</span> = llvm.bitcast %<span class="number">87</span> : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">89</span> = llvm.load %<span class="number">88</span> &#123;alignment = <span class="number">4</span> : i64&#125; : !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    llvm.br ^<span class="built_in">bb2</span>(%<span class="number">11</span>, %<span class="number">89</span> : i64, vector&lt;<span class="number">4</span>xf32&gt;)</span><br><span class="line">  ^<span class="built_in">bb2</span>(%<span class="number">90</span>: i64, %<span class="number">91</span>: vector&lt;<span class="number">4</span>xf32&gt;):  <span class="comment">// 2 preds: ^bb1, ^bb3</span></span><br><span class="line">    %<span class="number">92</span> = llvm.icmp <span class="string">&quot;slt&quot;</span> %<span class="number">90</span>, %<span class="number">8</span> : i64</span><br><span class="line">    llvm.cond_br %<span class="number">92</span>, ^bb3, ^bb4</span><br><span class="line">  ^bb3:  <span class="comment">// pred: ^bb2</span></span><br><span class="line">    %<span class="number">93</span> = llvm.extractvalue %<span class="number">27</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">94</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">95</span> = llvm.mul %<span class="number">85</span>, %<span class="number">94</span>  : i64</span><br><span class="line">    %<span class="number">96</span> = llvm.add %<span class="number">95</span>, %<span class="number">90</span>  : i64</span><br><span class="line">    %<span class="number">97</span> = llvm.getelementptr %<span class="number">93</span>[%<span class="number">96</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">98</span> = llvm.bitcast %<span class="number">97</span> : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">99</span> = llvm.load %<span class="number">98</span> &#123;alignment = <span class="number">4</span> : i64&#125; : !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">100</span> = llvm.insertvalue %<span class="number">99</span>, %<span class="number">2</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">101</span> = llvm.add %<span class="number">85</span>, %<span class="number">7</span>  : i64</span><br><span class="line">    %<span class="number">102</span> = llvm.extractvalue %<span class="number">27</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">103</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">104</span> = llvm.mul %<span class="number">101</span>, %<span class="number">103</span>  : i64</span><br><span class="line">    %<span class="number">105</span> = llvm.add %<span class="number">104</span>, %<span class="number">90</span>  : i64</span><br><span class="line">    %<span class="number">106</span> = llvm.getelementptr %<span class="number">102</span>[%<span class="number">105</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">107</span> = llvm.bitcast %<span class="number">106</span> : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">108</span> = llvm.load %<span class="number">107</span> &#123;alignment = <span class="number">4</span> : i64&#125; : !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">109</span> = llvm.insertvalue %<span class="number">108</span>, %<span class="number">100</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">110</span> = llvm.add %<span class="number">85</span>, %<span class="number">1</span>  : i64</span><br><span class="line">    %<span class="number">111</span> = llvm.extractvalue %<span class="number">27</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">112</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">113</span> = llvm.mul %<span class="number">110</span>, %<span class="number">112</span>  : i64</span><br><span class="line">    %<span class="number">114</span> = llvm.add %<span class="number">113</span>, %<span class="number">90</span>  : i64</span><br><span class="line">    %<span class="number">115</span> = llvm.getelementptr %<span class="number">111</span>[%<span class="number">114</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">116</span> = llvm.bitcast %<span class="number">115</span> : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">117</span> = llvm.load %<span class="number">116</span> &#123;alignment = <span class="number">4</span> : i64&#125; : !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">118</span> = llvm.insertvalue %<span class="number">117</span>, %<span class="number">109</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">119</span> = llvm.add %<span class="number">85</span>, %<span class="number">0</span>  : i64</span><br><span class="line">    %<span class="number">120</span> = llvm.extractvalue %<span class="number">27</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">121</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">122</span> = llvm.mul %<span class="number">119</span>, %<span class="number">121</span>  : i64</span><br><span class="line">    %<span class="number">123</span> = llvm.add %<span class="number">122</span>, %<span class="number">90</span>  : i64</span><br><span class="line">    %<span class="number">124</span> = llvm.getelementptr %<span class="number">120</span>[%<span class="number">123</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">125</span> = llvm.bitcast %<span class="number">124</span> : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">126</span> = llvm.load %<span class="number">125</span> &#123;alignment = <span class="number">4</span> : i64&#125; : !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">127</span> = llvm.insertvalue %<span class="number">126</span>, %<span class="number">118</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">128</span> = llvm.extractvalue %<span class="number">49</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">129</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">130</span> = llvm.mul %<span class="number">85</span>, %<span class="number">129</span>  : i64</span><br><span class="line">    %<span class="number">131</span> = llvm.add %<span class="number">130</span>, %<span class="number">90</span>  : i64</span><br><span class="line">    %<span class="number">132</span> = llvm.getelementptr %<span class="number">128</span>[%<span class="number">131</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">133</span> = llvm.bitcast %<span class="number">132</span> : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">134</span> = llvm.load %<span class="number">133</span> &#123;alignment = <span class="number">4</span> : i64&#125; : !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">135</span> = llvm.insertvalue %<span class="number">134</span>, %<span class="number">2</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">136</span> = llvm.extractvalue %<span class="number">49</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">137</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">138</span> = llvm.mul %<span class="number">101</span>, %<span class="number">137</span>  : i64</span><br><span class="line">    %<span class="number">139</span> = llvm.add %<span class="number">138</span>, %<span class="number">90</span>  : i64</span><br><span class="line">    %<span class="number">140</span> = llvm.getelementptr %<span class="number">136</span>[%<span class="number">139</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">141</span> = llvm.bitcast %<span class="number">140</span> : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">142</span> = llvm.load %<span class="number">141</span> &#123;alignment = <span class="number">4</span> : i64&#125; : !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">143</span> = llvm.insertvalue %<span class="number">142</span>, %<span class="number">135</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">144</span> = llvm.extractvalue %<span class="number">49</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">145</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">146</span> = llvm.mul %<span class="number">110</span>, %<span class="number">145</span>  : i64</span><br><span class="line">    %<span class="number">147</span> = llvm.add %<span class="number">146</span>, %<span class="number">90</span>  : i64</span><br><span class="line">    %<span class="number">148</span> = llvm.getelementptr %<span class="number">144</span>[%<span class="number">147</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">149</span> = llvm.bitcast %<span class="number">148</span> : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">150</span> = llvm.load %<span class="number">149</span> &#123;alignment = <span class="number">4</span> : i64&#125; : !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">151</span> = llvm.insertvalue %<span class="number">150</span>, %<span class="number">143</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">152</span> = llvm.extractvalue %<span class="number">49</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">153</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">154</span> = llvm.mul %<span class="number">119</span>, %<span class="number">153</span>  : i64</span><br><span class="line">    %<span class="number">155</span> = llvm.add %<span class="number">154</span>, %<span class="number">90</span>  : i64</span><br><span class="line">    %<span class="number">156</span> = llvm.getelementptr %<span class="number">152</span>[%<span class="number">155</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">157</span> = llvm.bitcast %<span class="number">156</span> : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">158</span> = llvm.load %<span class="number">157</span> &#123;alignment = <span class="number">4</span> : i64&#125; : !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">159</span> = llvm.insertvalue %<span class="number">158</span>, %<span class="number">151</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">160</span> = llvm.mlir.undef : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">161</span> = llvm.extractvalue %<span class="number">127</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">162</span> = llvm.extractvalue %<span class="number">159</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">163</span> = llvm.fadd %<span class="number">161</span>, %<span class="number">162</span>  : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">164</span> = llvm.insertvalue %<span class="number">163</span>, %<span class="number">160</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">165</span> = llvm.extractvalue %<span class="number">127</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">166</span> = llvm.extractvalue %<span class="number">159</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">167</span> = llvm.fadd %<span class="number">165</span>, %<span class="number">166</span>  : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">168</span> = llvm.insertvalue %<span class="number">167</span>, %<span class="number">164</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">169</span> = llvm.extractvalue %<span class="number">127</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">170</span> = llvm.extractvalue %<span class="number">159</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">171</span> = llvm.fadd %<span class="number">169</span>, %<span class="number">170</span>  : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">172</span> = llvm.insertvalue %<span class="number">171</span>, %<span class="number">168</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">173</span> = llvm.extractvalue %<span class="number">127</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">174</span> = llvm.extractvalue %<span class="number">159</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">175</span> = llvm.fadd %<span class="number">173</span>, %<span class="number">174</span>  : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">176</span> = llvm.insertvalue %<span class="number">175</span>, %<span class="number">172</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">177</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">178</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : i64) : i64</span><br><span class="line">    %<span class="number">179</span> = llvm.extractelement %<span class="number">177</span>[%<span class="number">178</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">180</span> = llvm.extractvalue %<span class="number">2</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">181</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : i64) : i64</span><br><span class="line">    %<span class="number">182</span> = llvm.insertelement %<span class="number">179</span>, %<span class="number">180</span>[%<span class="number">181</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">183</span> = llvm.insertvalue %<span class="number">182</span>, %<span class="number">2</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">184</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">185</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">1</span> : i64) : i64</span><br><span class="line">    %<span class="number">186</span> = llvm.extractelement %<span class="number">184</span>[%<span class="number">185</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">187</span> = llvm.extractvalue %<span class="number">183</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">188</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : i64) : i64</span><br><span class="line">    %<span class="number">189</span> = llvm.insertelement %<span class="number">186</span>, %<span class="number">187</span>[%<span class="number">188</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">190</span> = llvm.insertvalue %<span class="number">189</span>, %<span class="number">183</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">191</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">192</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">2</span> : i64) : i64</span><br><span class="line">    %<span class="number">193</span> = llvm.extractelement %<span class="number">191</span>[%<span class="number">192</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">194</span> = llvm.extractvalue %<span class="number">190</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">195</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : i64) : i64</span><br><span class="line">    %<span class="number">196</span> = llvm.insertelement %<span class="number">193</span>, %<span class="number">194</span>[%<span class="number">195</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">197</span> = llvm.insertvalue %<span class="number">196</span>, %<span class="number">190</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">198</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">199</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">3</span> : i64) : i64</span><br><span class="line">    %<span class="number">200</span> = llvm.extractelement %<span class="number">198</span>[%<span class="number">199</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">201</span> = llvm.extractvalue %<span class="number">197</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">202</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : i64) : i64</span><br><span class="line">    %<span class="number">203</span> = llvm.insertelement %<span class="number">200</span>, %<span class="number">201</span>[%<span class="number">202</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">204</span> = llvm.insertvalue %<span class="number">203</span>, %<span class="number">197</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">205</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">206</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : i64) : i64</span><br><span class="line">    %<span class="number">207</span> = llvm.extractelement %<span class="number">205</span>[%<span class="number">206</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">208</span> = llvm.extractvalue %<span class="number">204</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">209</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">1</span> : i64) : i64</span><br><span class="line">    %<span class="number">210</span> = llvm.insertelement %<span class="number">207</span>, %<span class="number">208</span>[%<span class="number">209</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">211</span> = llvm.insertvalue %<span class="number">210</span>, %<span class="number">204</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">212</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">213</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">1</span> : i64) : i64</span><br><span class="line">    %<span class="number">214</span> = llvm.extractelement %<span class="number">212</span>[%<span class="number">213</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">215</span> = llvm.extractvalue %<span class="number">211</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">216</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">1</span> : i64) : i64</span><br><span class="line">    %<span class="number">217</span> = llvm.insertelement %<span class="number">214</span>, %<span class="number">215</span>[%<span class="number">216</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">218</span> = llvm.insertvalue %<span class="number">217</span>, %<span class="number">211</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">219</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">220</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">2</span> : i64) : i64</span><br><span class="line">    %<span class="number">221</span> = llvm.extractelement %<span class="number">219</span>[%<span class="number">220</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">222</span> = llvm.extractvalue %<span class="number">218</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">223</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">1</span> : i64) : i64</span><br><span class="line">    %<span class="number">224</span> = llvm.insertelement %<span class="number">221</span>, %<span class="number">222</span>[%<span class="number">223</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">225</span> = llvm.insertvalue %<span class="number">224</span>, %<span class="number">218</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">226</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">227</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">3</span> : i64) : i64</span><br><span class="line">    %<span class="number">228</span> = llvm.extractelement %<span class="number">226</span>[%<span class="number">227</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">229</span> = llvm.extractvalue %<span class="number">225</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">230</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">1</span> : i64) : i64</span><br><span class="line">    %<span class="number">231</span> = llvm.insertelement %<span class="number">228</span>, %<span class="number">229</span>[%<span class="number">230</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">232</span> = llvm.insertvalue %<span class="number">231</span>, %<span class="number">225</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">233</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">234</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : i64) : i64</span><br><span class="line">    %<span class="number">235</span> = llvm.extractelement %<span class="number">233</span>[%<span class="number">234</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">236</span> = llvm.extractvalue %<span class="number">232</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">237</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">2</span> : i64) : i64</span><br><span class="line">    %<span class="number">238</span> = llvm.insertelement %<span class="number">235</span>, %<span class="number">236</span>[%<span class="number">237</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">239</span> = llvm.insertvalue %<span class="number">238</span>, %<span class="number">232</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">240</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">241</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">1</span> : i64) : i64</span><br><span class="line">    %<span class="number">242</span> = llvm.extractelement %<span class="number">240</span>[%<span class="number">241</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">243</span> = llvm.extractvalue %<span class="number">239</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">244</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">2</span> : i64) : i64</span><br><span class="line">    %<span class="number">245</span> = llvm.insertelement %<span class="number">242</span>, %<span class="number">243</span>[%<span class="number">244</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">246</span> = llvm.insertvalue %<span class="number">245</span>, %<span class="number">239</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">247</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">248</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">2</span> : i64) : i64</span><br><span class="line">    %<span class="number">249</span> = llvm.extractelement %<span class="number">247</span>[%<span class="number">248</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">250</span> = llvm.extractvalue %<span class="number">246</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">251</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">2</span> : i64) : i64</span><br><span class="line">    %<span class="number">252</span> = llvm.insertelement %<span class="number">249</span>, %<span class="number">250</span>[%<span class="number">251</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">253</span> = llvm.insertvalue %<span class="number">252</span>, %<span class="number">246</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">254</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">255</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">3</span> : i64) : i64</span><br><span class="line">    %<span class="number">256</span> = llvm.extractelement %<span class="number">254</span>[%<span class="number">255</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">257</span> = llvm.extractvalue %<span class="number">253</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">258</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">2</span> : i64) : i64</span><br><span class="line">    %<span class="number">259</span> = llvm.insertelement %<span class="number">256</span>, %<span class="number">257</span>[%<span class="number">258</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">260</span> = llvm.insertvalue %<span class="number">259</span>, %<span class="number">253</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">261</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">262</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">0</span> : i64) : i64</span><br><span class="line">    %<span class="number">263</span> = llvm.extractelement %<span class="number">261</span>[%<span class="number">262</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">264</span> = llvm.extractvalue %<span class="number">260</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">265</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">3</span> : i64) : i64</span><br><span class="line">    %<span class="number">266</span> = llvm.insertelement %<span class="number">263</span>, %<span class="number">264</span>[%<span class="number">265</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">267</span> = llvm.insertvalue %<span class="number">266</span>, %<span class="number">260</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">268</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">269</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">1</span> : i64) : i64</span><br><span class="line">    %<span class="number">270</span> = llvm.extractelement %<span class="number">268</span>[%<span class="number">269</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">271</span> = llvm.extractvalue %<span class="number">267</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">272</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">3</span> : i64) : i64</span><br><span class="line">    %<span class="number">273</span> = llvm.insertelement %<span class="number">270</span>, %<span class="number">271</span>[%<span class="number">272</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">274</span> = llvm.insertvalue %<span class="number">273</span>, %<span class="number">267</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">275</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">276</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">2</span> : i64) : i64</span><br><span class="line">    %<span class="number">277</span> = llvm.extractelement %<span class="number">275</span>[%<span class="number">276</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">278</span> = llvm.extractvalue %<span class="number">274</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">279</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">3</span> : i64) : i64</span><br><span class="line">    %<span class="number">280</span> = llvm.insertelement %<span class="number">277</span>, %<span class="number">278</span>[%<span class="number">279</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">281</span> = llvm.insertvalue %<span class="number">280</span>, %<span class="number">274</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">282</span> = llvm.extractvalue %<span class="number">176</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">283</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">3</span> : i64) : i64</span><br><span class="line">    %<span class="number">284</span> = llvm.extractelement %<span class="number">282</span>[%<span class="number">283</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">285</span> = llvm.extractvalue %<span class="number">281</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">286</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">3</span> : i64) : i64</span><br><span class="line">    %<span class="number">287</span> = llvm.insertelement %<span class="number">284</span>, %<span class="number">285</span>[%<span class="number">286</span> : i64] : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">288</span> = llvm.insertvalue %<span class="number">287</span>, %<span class="number">281</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">289</span> = llvm.extractvalue %<span class="number">288</span>[<span class="number">0</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">290</span> = llvm.fadd %<span class="number">289</span>, %<span class="number">91</span>  : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">291</span> = llvm.extractvalue %<span class="number">288</span>[<span class="number">1</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">292</span> = llvm.fadd %<span class="number">291</span>, %<span class="number">290</span>  : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">293</span> = llvm.extractvalue %<span class="number">288</span>[<span class="number">2</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">294</span> = llvm.fadd %<span class="number">293</span>, %<span class="number">292</span>  : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">295</span> = llvm.extractvalue %<span class="number">288</span>[<span class="number">3</span>] : !llvm.array&lt;<span class="number">4</span> x vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    %<span class="number">296</span> = llvm.fadd %<span class="number">295</span>, %<span class="number">294</span>  : vector&lt;<span class="number">4</span>xf32&gt;</span><br><span class="line">    %<span class="number">297</span> = llvm.add %<span class="number">90</span>, %<span class="number">9</span>  : i64</span><br><span class="line">    llvm.br ^<span class="built_in">bb2</span>(%<span class="number">297</span>, %<span class="number">296</span> : i64, vector&lt;<span class="number">4</span>xf32&gt;)</span><br><span class="line">  ^bb4:  <span class="comment">// pred: ^bb2</span></span><br><span class="line">    %<span class="number">298</span> = llvm.extractvalue %<span class="number">67</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">1</span> x i64&gt;, array&lt;<span class="number">1</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">299</span> = llvm.getelementptr %<span class="number">298</span>[%<span class="number">85</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">300</span> = llvm.bitcast %<span class="number">299</span> : !llvm.ptr&lt;f32&gt; to !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    llvm.store %<span class="number">91</span>, %<span class="number">300</span> &#123;alignment = <span class="number">4</span> : i64&#125; : !llvm.ptr&lt;vector&lt;<span class="number">4</span>xf32&gt;&gt;</span><br><span class="line">    llvm.br ^bb12</span><br><span class="line">  ^bb5:  <span class="comment">// pred: ^bb0</span></span><br><span class="line">    %<span class="number">301</span> = nvvm.read.ptx.sreg.tid.x : i32</span><br><span class="line">    %<span class="number">302</span> = llvm.sext %<span class="number">301</span> : i32 to i64</span><br><span class="line">    %<span class="number">303</span> = llvm.icmp <span class="string">&quot;sle&quot;</span> %<span class="number">79</span>, %<span class="number">11</span> : i64</span><br><span class="line">    %<span class="number">304</span> = llvm.sub %<span class="number">11</span>, %<span class="number">79</span>  : i64</span><br><span class="line">    %<span class="number">305</span> = llvm.sub %<span class="number">79</span>, %<span class="number">7</span>  : i64</span><br><span class="line">    %<span class="number">306</span> = llvm.select %<span class="number">303</span>, %<span class="number">304</span>, %<span class="number">305</span> : i1, i64</span><br><span class="line">    %<span class="number">307</span> = llvm.sdiv %<span class="number">306</span>, %<span class="number">4</span>  : i64</span><br><span class="line">    %<span class="number">308</span> = llvm.sub %<span class="number">11</span>, %<span class="number">307</span>  : i64</span><br><span class="line">    %<span class="number">309</span> = llvm.add %<span class="number">307</span>, %<span class="number">7</span>  : i64</span><br><span class="line">    %<span class="number">310</span> = llvm.select %<span class="number">303</span>, %<span class="number">308</span>, %<span class="number">309</span> : i1, i64</span><br><span class="line">    %<span class="number">311</span> = llvm.mul %<span class="number">302</span>, %<span class="number">310</span>  : i64</span><br><span class="line">    %<span class="number">312</span> = llvm.mul %<span class="number">311</span>, %<span class="number">3</span>  : i64</span><br><span class="line">    %<span class="number">313</span> = llvm.add %<span class="number">312</span>, %<span class="number">79</span>  : i64</span><br><span class="line">    %<span class="number">314</span> = llvm.icmp <span class="string">&quot;slt&quot;</span> %<span class="number">313</span>, %<span class="number">310</span> : i64</span><br><span class="line">    %<span class="number">315</span> = llvm.select %<span class="number">314</span>, %<span class="number">313</span>, %<span class="number">310</span> : i1, i64</span><br><span class="line">    %<span class="number">316</span> = llvm.icmp <span class="string">&quot;slt&quot;</span> %<span class="number">315</span>, %<span class="number">11</span> : i64</span><br><span class="line">    %<span class="number">317</span> = llvm.select %<span class="number">316</span>, %<span class="number">11</span>, %<span class="number">315</span> : i1, i64</span><br><span class="line">    %<span class="number">318</span> = llvm.mul %<span class="number">75</span>, %<span class="number">10</span>  : i64</span><br><span class="line">    %<span class="number">319</span> = llvm.add %<span class="number">311</span>, %<span class="number">318</span>  : i64</span><br><span class="line">    llvm.br ^<span class="built_in">bb6</span>(%<span class="number">11</span> : i64)</span><br><span class="line">  ^<span class="built_in">bb6</span>(%<span class="number">320</span>: i64):  <span class="comment">// 2 preds: ^bb5, ^bb11</span></span><br><span class="line">    %<span class="number">321</span> = llvm.icmp <span class="string">&quot;slt&quot;</span> %<span class="number">320</span>, %<span class="number">8</span> : i64</span><br><span class="line">    llvm.cond_br %<span class="number">321</span>, ^<span class="built_in">bb7</span>(%<span class="number">11</span> : i64), ^bb12</span><br><span class="line">  ^<span class="built_in">bb7</span>(%<span class="number">322</span>: i64):  <span class="comment">// 2 preds: ^bb6, ^bb10</span></span><br><span class="line">    %<span class="number">323</span> = llvm.icmp <span class="string">&quot;slt&quot;</span> %<span class="number">322</span>, %<span class="number">317</span> : i64</span><br><span class="line">    llvm.cond_br %<span class="number">323</span>, ^<span class="built_in">bb8</span>(%<span class="number">11</span> : i64), ^bb11</span><br><span class="line">  ^<span class="built_in">bb8</span>(%<span class="number">324</span>: i64):  <span class="comment">// 2 preds: ^bb7, ^bb9</span></span><br><span class="line">    %<span class="number">325</span> = llvm.icmp <span class="string">&quot;slt&quot;</span> %<span class="number">324</span>, %<span class="number">9</span> : i64</span><br><span class="line">    llvm.cond_br %<span class="number">325</span>, ^bb9, ^bb10</span><br><span class="line">  ^bb9:  <span class="comment">// pred: ^bb8</span></span><br><span class="line">    %<span class="number">326</span> = llvm.add %<span class="number">319</span>, %<span class="number">322</span>  : i64</span><br><span class="line">    %<span class="number">327</span> = llvm.add %<span class="number">320</span>, %<span class="number">324</span>  : i64</span><br><span class="line">    %<span class="number">328</span> = llvm.extractvalue %<span class="number">27</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">329</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">330</span> = llvm.mul %<span class="number">326</span>, %<span class="number">329</span>  : i64</span><br><span class="line">    %<span class="number">331</span> = llvm.add %<span class="number">330</span>, %<span class="number">327</span>  : i64</span><br><span class="line">    %<span class="number">332</span> = llvm.getelementptr %<span class="number">328</span>[%<span class="number">331</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">333</span> = llvm.load %<span class="number">332</span> : !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">334</span> = llvm.extractvalue %<span class="number">49</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">2</span> x i64&gt;, array&lt;<span class="number">2</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">335</span> = llvm.mlir.<span class="built_in">constant</span>(<span class="number">100</span> : index) : i64</span><br><span class="line">    %<span class="number">336</span> = llvm.mul %<span class="number">326</span>, %<span class="number">335</span>  : i64</span><br><span class="line">    %<span class="number">337</span> = llvm.add %<span class="number">336</span>, %<span class="number">327</span>  : i64</span><br><span class="line">    %<span class="number">338</span> = llvm.getelementptr %<span class="number">334</span>[%<span class="number">337</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">339</span> = llvm.load %<span class="number">338</span> : !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">340</span> = llvm.extractvalue %<span class="number">67</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">1</span> x i64&gt;, array&lt;<span class="number">1</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">341</span> = llvm.getelementptr %<span class="number">340</span>[%<span class="number">326</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">342</span> = llvm.load %<span class="number">341</span> : !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">343</span> = llvm.fadd %<span class="number">333</span>, %<span class="number">339</span>  : f32</span><br><span class="line">    %<span class="number">344</span> = llvm.fadd %<span class="number">343</span>, %<span class="number">342</span>  : f32</span><br><span class="line">    %<span class="number">345</span> = llvm.extractvalue %<span class="number">67</span>[<span class="number">1</span>] : !llvm.<span class="keyword">struct</span>&lt;(ptr&lt;f32&gt;, ptr&lt;f32&gt;, i64, array&lt;<span class="number">1</span> x i64&gt;, array&lt;<span class="number">1</span> x i64&gt;)&gt;</span><br><span class="line">    %<span class="number">346</span> = llvm.getelementptr %<span class="number">345</span>[%<span class="number">326</span>] : (!llvm.ptr&lt;f32&gt;, i64) -&gt; !llvm.ptr&lt;f32&gt;</span><br><span class="line">    llvm.store %<span class="number">344</span>, %<span class="number">346</span> : !llvm.ptr&lt;f32&gt;</span><br><span class="line">    %<span class="number">347</span> = llvm.add %<span class="number">324</span>, %<span class="number">7</span>  : i64</span><br><span class="line">    llvm.br ^<span class="built_in">bb8</span>(%<span class="number">347</span> : i64)</span><br><span class="line">  ^bb10:  <span class="comment">// pred: ^bb8</span></span><br><span class="line">    %<span class="number">348</span> = llvm.add %<span class="number">322</span>, %<span class="number">7</span>  : i64</span><br><span class="line">    llvm.br ^<span class="built_in">bb7</span>(%<span class="number">348</span> : i64)</span><br><span class="line">  ^bb11:  <span class="comment">// pred: ^bb7</span></span><br><span class="line">    %<span class="number">349</span> = llvm.add %<span class="number">320</span>, %<span class="number">9</span>  : i64</span><br><span class="line">    llvm.br ^<span class="built_in">bb6</span>(%<span class="number">349</span> : i64)</span><br><span class="line">  ^bb12:  <span class="comment">// 2 preds: ^bb4, ^bb6</span></span><br><span class="line">    llvm.<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul></li>
</ul></li>
</ul></li>
<li><p>createConvertToHALPass</p></li>
<li><p>createFixupLegacySyncPass</p></li>
<li><p>addCleanupPatterns</p></li>
<li><p>createLinkExecutablesPass</p></li>
<li><p>createResolveExportOrdinalsPass</p></li>
<li><p>createMaterializeResourceCachesPass</p></li>
<li><p>createInlineDeviceSwitchesPass</p></li>
<li><p>createMemoizeDeviceQueriesPass</p></li>
<li><p>addCleanupPatterns</p></li>
<li><p>createElideRedundantCommandsPass</p></li>
<li><p>mlir::createLowerAffinePass</p></li>
<li><p>mlir::createConvertSCFToCFPass</p></li>
<li><p>IREE::Util::createCombineInitializersPass</p></li>
<li><p>addCleanupPatterns</p></li>
<li><p>createSerializeExecutablesPass</p></li>
<li><p>mlir::createSymbolDCEPass</p></li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/DL-Compiler/">DL Compiler</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Deep-Learning-Compiler/">Deep Learning Compiler</a><a href="/tags/IREE/">IREE</a>
  </div>

</div>



</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2023/02/13/IREE编译流程5/"  title="IREE编译流程解析(五)">
 <strong>下一篇：</strong><br/> 
 <span>IREE编译流程解析(五)
</span>
</a>
</div>

</nav>

	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/DL-Compiler/" title="DL Compiler">DL Compiler<sup>8</sup></a></li>
		  
		
		  
			<li><a href="/categories/Daily/" title="Daily">Daily<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/ML-framework/" title="ML framework">ML framework<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/XRT/" title="XRT">XRT<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/code/" title="code">code<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/deep-learning/" title="deep learning">deep learning<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/graph-optimization-图优化/" title="graph optimization, 图优化">graph optimization, 图优化<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/kaldi-decision-tree-决策树/" title="kaldi, decision tree, 决策树">kaldi, decision tree, 决策树<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/low-bitwidth/" title="low bitwidth">low bitwidth<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/model-compression/" title="model compression">model compression<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/neural-machine-translation/" title="neural machine translation">neural machine translation<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/reinforcement-learning/" title="reinforcement learning">reinforcement learning<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/tvm-knowledge/" title="tvm knowledge">tvm knowledge<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Deep-Learning-Compiler/" title="Deep Learning Compiler">Deep Learning Compiler<sup>8</sup></a></li>
			
		
			
				<li><a href="/tags/IREE/" title="IREE">IREE<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/reinforcement-learning/" title="reinforcement learning">reinforcement learning<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/caffe/" title="caffe">caffe<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/deep-learning/" title="deep learning">deep learning<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/machine-learning/" title="machine learning">machine learning<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/momentum/" title="momentum">momentum<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/XLA/" title="XLA">XLA<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/FusionStitching/" title="FusionStitching">FusionStitching<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/c/" title="c++">c++<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/python/" title="python">python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/embedding/" title="embedding">embedding<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/kaldi/" title="kaldi">kaldi<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/decision-tree/" title="decision tree">decision tree<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/决策树/" title="决策树">决策树<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/HMM/" title="HMM">HMM<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/上下文相关音素/" title="上下文相关音素">上下文相关音素<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/web-technology/" title="web technology">web technology<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/TVM/" title="TVM">TVM<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/PackedFunc/" title="PackedFunc">PackedFunc<sup>1</sup></a></li>
			
		
		</ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2023 
		
		<a href="/about" target="_blank" title="Dou Jiang">Dou Jiang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
